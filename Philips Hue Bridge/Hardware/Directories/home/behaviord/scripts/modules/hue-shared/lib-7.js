"use strict";var Environment=require("./lib-4.js"),utils=require("./lib-9.js"),barrier$1=require("./lib-3.js"),helpers=require("./lib-8.js"),recipe=require("./lib-5.js"),barrier=function(items,iterator,successCallback,errorCallback){void 0===errorCallback&&(errorCallback=successCallback);var barrier=new barrier$1.Barrier(items.length,(function(errors){errors.length?errorCallback(Environment.unique(errors)):successCallback()})),callback=function(errors){return barrier.arrive(errors?helpers.formatErrors(errors):void 0)};items.forEach((function(item,index){return iterator(item,callback,index)}))},createActionsForLights=function(lightIds,action){return lightIds.map((function(lightId){return{action:action,target:{rid:lightId,rtype:"light"}}}))},responseHandler=function(successCallback,errorCallback){return void 0===errorCallback&&(errorCallback=utils.noop),function(_a){var errors=_a.errors,data=_a.data;return(null==errors?void 0:errors.length)?errorCallback(errors):successCallback(data[0])}},ClipResource=function(){function ClipResource(clip,resourceType){this.clip=clip,this.resourceType=resourceType}return ClipResource.prototype.get=function(id,successCallback,errorCallback){return this.clip.get("/".concat(this.resourceType,"/").concat(id),responseHandler(successCallback,errorCallback))},ClipResource.prototype.getAll=function(successCallback,errorCallback){return this.clip.get("/".concat(this.resourceType),function(successCallback,errorCallback){return void 0===errorCallback&&(errorCallback=utils.noop),function(_a){var errors=_a.errors,data=_a.data;return(null==errors?void 0:errors.length)?errorCallback(errors):successCallback(data)}}(successCallback,errorCallback))},ClipResource.prototype.put=function(id,data,successCallback,errorCallback){return this.clip.put("/".concat(this.resourceType,"/").concat(id),data,responseHandler(successCallback,errorCallback))},ClipResource.prototype.post=function(data,successCallback,errorCallback){return this.clip.post("/".concat(this.resourceType),data,responseHandler(successCallback,errorCallback))},ClipResource.prototype.delete=function(id,successCallback,errorCallback){return this.clip.delete("/".concat(this.resourceType,"/").concat(id),responseHandler(successCallback,errorCallback))},ClipResource}(),ClipApi=function(){function ClipApi(clip){this.clip=clip}return ClipApi.prototype.resource=function(resourceType){return new ClipResource(this.clip,resourceType)},ClipApi}(),PrivateScene=function(){function PrivateScene(scriptId,env){this.scriptId=scriptId,this.env=env,this._initialised=!1,this._isEmptyActions=!1,this.items=[]}return PrivateScene.prototype.add=function(item){return this.items.some((function(i){return i[0].rid===item[0].rid}))||this.items.push(item),this},Object.defineProperty(PrivateScene.prototype,"resource",{get:function(){return this.sceneId&&!this._isEmptyActions?{rid:this.sceneId,rtype:"private_scene"}:void 0},enumerable:!1,configurable:!0}),Object.defineProperty(PrivateScene.prototype,"hasInitialised",{get:function(){return this._initialised},enumerable:!1,configurable:!0}),PrivateScene.prototype.getLights=function(groups){var _this=this;return groups||(groups=this.items.map((function(_a){return _a[0]}))),Environment.flatmap(groups,(function(group){var _a;return null!==(_a=_this.env.state.get("lights:".concat(group.rid)))&&void 0!==_a?_a:[]}))},PrivateScene.prototype.init=function(successCallback,errorCallback){var _this=this;if(this._initialised)return successCallback();this._initialised=!0,this.verify((function(){_this.storeAllLights(),_this.createPrivateScene(successCallback,errorCallback)}),errorCallback)},PrivateScene.prototype.subscribeToGroup=function(group){var _this=this;this.env.events.update.subscribe(group.rid,(function(){_this.storeAllLights(),_this.updatePrivateScene()}))},PrivateScene.prototype.watchGroupChanges=function(){var _this=this;this.items.forEach((function(_a){var group=_a[0];_this.subscribeToGroup(group),"bridge_home"===group.rtype&&new ClipApi(_this.env.clip).resource("bridge_home").get(group.rid,(function(data){return data.children.filter((function(child){return"room"===child.rtype})).forEach((function(group){return _this.subscribeToGroup(group)}))}))}))},PrivateScene.prototype.storeAllLights=function(){var _this=this;this.items.forEach((function(_a){var group=_a[0];_this.env.state.set("lights:".concat(group.rid),ClipUtils2.getLightIdsInGroup(group.rtype,group.rid))}))},PrivateScene.prototype.createPrivateScene=function(successCallback,errorCallback){var _this=this;this.createActions(this.getLights(),(function(actions,creationMethod,palette){actions.length>0?_this.env.clipUtils.createPrivateScene(_this.scriptId,actions,(function(errors,scene){errors?errorCallback(errors):(_this.sceneId=scene.rid,successCallback(),_this.watchGroupChanges())}),creationMethod,palette):(_this._isEmptyActions=!0,_this.watchGroupChanges(),successCallback())}),errorCallback)},PrivateScene.prototype.updatePrivateScene=function(callback,groupsToInclude){var _this=this;void 0===callback&&(callback=utils.noop),this.createActions(this.getLights(groupsToInclude),(function(actions,privateSceneCreationMethod,palette){actions.length>0?(_this._isEmptyActions=!1,_this.resource?_this.env.clipUtils.updatePrivateScene(_this.resource,actions,callback,privateSceneCreationMethod,palette):_this.env.clipUtils.createPrivateScene(_this.scriptId,actions,(function(errors,scene){errors?callback(errors):(_this.sceneId=scene.rid,_this.watchGroupChanges(),callback())}),privateSceneCreationMethod,palette)):_this._isEmptyActions=!0}),callback)},PrivateScene}(),PrivateSceneWithRecipes=function(_super){function PrivateSceneWithRecipes(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(PrivateSceneWithRecipes,_super),Object.defineProperty(PrivateSceneWithRecipes.prototype,"lightsByGroup",{get:function(){var _this=this;return this.items.reduce((function(lights,_a){var _b,_c,group=_a[0];return Environment.__assign(Environment.__assign({},lights),((_b={})[group.rid]=null!==(_c=_this.env.state.get("lights:".concat(group.rid)))&&void 0!==_c?_c:[],_b))}),{})},enumerable:!1,configurable:!0}),PrivateSceneWithRecipes.prototype.verify=function(successCallback,errorCallback){barrier(this.items,(function(_a,barrierCallback){var what=_a[1];return"recipe"===what.rtype?recipe.Recipe.get(what.rid)?barrierCallback(void 0):barrierCallback("Recipe not found: ".concat(what.rid)):barrierCallback("Failed creating private scene for what => ".concat(what.rid))}),successCallback,errorCallback)},PrivateSceneWithRecipes.prototype.createActions=function(_lights,successCallback,_errorCallback){var palette,_this=this,privateSceneCreationMethod="use_palette";successCallback(Environment.flatmap(this.items,(function(_a){var _b,where=_a[0],what=_a[1],recipe_action=null===(_b=recipe.Recipe.get(what.rid))||void 0===_b?void 0:_b.action;return recipe_action&&(!function(palette){return Object.keys(palette).reduce((function(returnValue,key){return 0===palette[key].length&&returnValue}),!0)}(palette=recipe.Recipe.createPaletteFromRecipeAction(recipe_action))?recipe_action={}:(palette=void 0,privateSceneCreationMethod=void 0)),createActionsForLights(_this.lightsByGroup[where.rid],recipe_action)})),privateSceneCreationMethod,palette)},PrivateSceneWithRecipes}(PrivateScene),PrivateSceneWithPreviousState=function(_super){function PrivateSceneWithPreviousState(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(PrivateSceneWithPreviousState,_super),PrivateSceneWithPreviousState.prototype.verify=function(successCallback){successCallback()},PrivateSceneWithPreviousState.prototype.createActions=function(lights,successCallback){successCallback(createActionsForLights(lights,{}),"current_light_states",void 0)},PrivateSceneWithPreviousState}(PrivateScene);exports.ClipApi=ClipApi,exports.PrivateSceneWithPreviousState=PrivateSceneWithPreviousState,exports.PrivateSceneWithRecipes=PrivateSceneWithRecipes,exports.barrier=barrier;
