"use strict";var Environment=require("./lib-4.js");function ForEachAndFinally(allItems,doForEach,doFinally){if(allItems&&allItems.length>0){var itemsProcessed_1=0;allItems.forEach((function(item){doForEach(item,(function(){++itemsProcessed_1>=allItems.length&&(null==doFinally||doFinally())}))}))}else null==doFinally||doFinally()}function processResponseWithCallback(callback){return function(response){ClipUtils.prototype.hasErrors(response.errors)?callback(response.errors):callback(void 0,response.data[0])}}function hasErrors(errors){return(null==errors?void 0:errors.length)>0}var ClipUtils=function(){function ClipUtils(clip,timer){this.clip=clip,this.timer=timer}return ClipUtils.prototype.hasErrors=function(errors){return(null==errors?void 0:errors.length)>0},ClipUtils.prototype.setLightState=function(light,state,callback){this.clip.put("/"+light.rtype+"/"+light.rid,state,processResponseWithCallback(callback))},ClipUtils.prototype.turnOffLight=function(light,callback){this.setLightState(light,{on:{on:!1}},callback)},ClipUtils.prototype.turnOnLight=function(light,callback){this.setLightState(light,{on:{on:!0}},callback)},ClipUtils.prototype.blinkLight=function(light,callback){this.setLightState(light,{alert:{action:"breathe"}},callback)},ClipUtils.prototype.performWithGroupedLight=function(group,what,callback){this.getResource(group,(function(errors,groupData){if(hasErrors(errors))callback(errors);else{var groupedLightService=groupData.services.filter((function(service){return"grouped_light"==service.rtype}));1==groupedLightService.length?what(groupedLightService[0],callback):callback([{description:"group without or with multiple grouped_light service."}])}}))},ClipUtils.prototype.turnOnGroupOfLights=function(group,callback){var _this=this;this.performWithGroupedLight(group,(function(groupedLight,callback_){return _this.turnOnLight(groupedLight,callback_)}),callback)},ClipUtils.prototype.turnOffGroupOfLights=function(group,callback){var _this=this;this.performWithGroupedLight(group,(function(groupedLight,callback_){return _this.turnOffLight(groupedLight,callback_)}),callback)},ClipUtils.prototype.blinkGroupOfLights=function(group,callback){var _this=this;this.performWithGroupedLight(group,(function(groupedLight,callback_){return _this.blinkLight(groupedLight,callback_)}),callback)},ClipUtils.prototype.getLightState=function(light,callback){this.clip.get("/"+light.rtype+"/"+light.rid,processResponseWithCallback(callback))},ClipUtils.prototype.getLightsInGroup=function(group,callback){callback(void 0,ClipUtils2.getLightIdsInGroup(group.rtype,group.rid).map((function(id){return{rid:id,rtype:"light"}})))},ClipUtils.prototype.getBridgeHome=function(callback){this.clip.get("/bridge_home",(function(response){if(hasErrors(response.errors))callback(response.errors);else{var bridgeHomeRef={rid:response.data[0].id,rtype:response.data[0].type};callback(void 0,bridgeHomeRef)}}))},ClipUtils.prototype.getResource=function(resource,callback){this.clip.get("/"+resource.rtype+"/"+resource.rid,processResponseWithCallback(callback))},ClipUtils.prototype.createPrivateScene=function(ownerId,actions,callback,storeActions,palette){var scene={type:"private_scene",creator:{rid:ownerId,rtype:"behavior_instance"},actions:actions};storeActions&&(scene.store_actions=storeActions),palette&&(scene.palette=palette),this.clip.post("/private_scene",scene,processResponseWithCallback(callback))},ClipUtils.prototype.createPrivateGroup=function(ownerId,lights,callback){var group={type:"private_group",creator:{rid:ownerId,rtype:"behavior_instance"},children:lights};this.clip.post("/private_group",group,processResponseWithCallback(callback))},ClipUtils.prototype.updatePrivateScene=function(scene,actions,callback,storeActions,palette){var sceneInfo={actions:actions};storeActions&&(sceneInfo.store_actions=storeActions),palette&&(sceneInfo.palette=palette),this.clip.put("/private_scene/"+scene.rid,sceneInfo,processResponseWithCallback(callback))},ClipUtils.prototype.updatePrivateGroup=function(group,lights,callback){var groupUpdate={children:lights};this.clip.put("/private_group/"+group.rid,groupUpdate,processResponseWithCallback(callback))},ClipUtils.prototype.getSceneOrSmartScene=function(sceneOrSmartScene,callback){this.clip.get("/"+sceneOrSmartScene.rtype+"/"+sceneOrSmartScene.rid,processResponseWithCallback(callback))},ClipUtils.prototype.recallScene=function(scene,recallOptions,callback,metadata){this.clip.put("/"+scene.rtype+"/"+scene.rid,{recall:recallOptions},processResponseWithCallback(callback),metadata)},ClipUtils.prototype.recallScenes=function(scenes,recallOptions,callback){var _this=this,allErrors=[];ForEachAndFinally(scenes,(function(scene,done){_this.recallScene(scene,recallOptions,(function(errors,data){hasErrors(errors)&&(allErrors=allErrors.concat(errors)),done()}))}),(function(){callback(allErrors)}))},ClipUtils.prototype.activateScenes=function(scenes,callback){this.recallScenes(scenes,{action:"active"},callback)},ClipUtils.prototype.basicActivateScenesWithTransition=function(scenes,transitionTime,callback){var _this=this,recallSceneDurationMilliseconds=Environment.TimespanUtils.toMilliseconds(transitionTime);this.recallScenes(scenes,{action:"active",duration:recallSceneDurationMilliseconds},(function(errors){hasErrors(errors)?callback(errors):_this.timer.setTimeout((function(){callback()}),{milliseconds:recallSceneDurationMilliseconds})}))},ClipUtils.prototype.activateScenesWithInitialStateAndTransition=function(scenes,startState,transitionTime,callback,timerIdCallback){var _this=this;this.recallScenes(scenes,{action:"active",dimming:{brightness:startState.dimming.brightness},duration:Environment.TimespanUtils.toMilliseconds(startState.duration)},(function(errors){if(hasErrors(errors))callback(errors);else{var timerId_1=_this.timer.setTimeout((function(){var recallSceneDurationMilliseconds=Environment.TimespanUtils.toMilliseconds(transitionTime)-Environment.TimespanUtils.toMilliseconds(startState.duration);recallSceneDurationMilliseconds<0&&(recallSceneDurationMilliseconds=0),_this.recallScenes(scenes,{action:"active",duration:recallSceneDurationMilliseconds},(function(errors){hasErrors(errors)?callback(errors):(timerId_1=_this.timer.setTimeout((function(){callback()}),{milliseconds:recallSceneDurationMilliseconds}),null==timerIdCallback||timerIdCallback(timerId_1))}))}),startState.duration);null==timerIdCallback||timerIdCallback(timerId_1)}}))},ClipUtils.prototype.activateScenesWithTransition=function(scenes,transitionTime,callback){this.activateScenesWithInitialStateAndTransition(scenes,{dimming:{brightness:1},duration:{seconds:10}},transitionTime,callback)},ClipUtils.prototype.getScenesLights=function(scenes,callback){var _this=this,lights=[],lightActions=[],allErrors=[];ForEachAndFinally(scenes,(function(sceneReference,done){_this.getSceneOrSmartScene(sceneReference,(function(errors,scene){hasErrors(errors)&&(allErrors=allErrors.concat(errors)),void 0!==scene&&scene.hasOwnProperty("actions")&&scene.actions.forEach((function(action){lights.push(action.target),lightActions.push(action.action)})),done()}))}),(function(){callback(allErrors,lights,lightActions)}))},ClipUtils.prototype.turnOffScenesLights=function(scenes,callback){var _this=this,allErrors=[];this.getScenesLights(scenes,(function(errors,lights){if(hasErrors(errors))callback(errors);else{ForEachAndFinally(lights,(function(light,done){_this.turnOffLight(light,(function(errors){hasErrors(errors)&&(allErrors=allErrors.concat(errors)),done()}))}),(function(){callback(allErrors)}))}}))},ClipUtils.prototype.recallSmartScene=function(smartScene,callback){this.clip.put("/"+smartScene.rtype+"/"+smartScene.rid,{recall:{action:"activate"}},processResponseWithCallback(callback))},ClipUtils.prototype.recallSmartScenes=function(smartScenes,callback){var _this=this,allErrors=[];ForEachAndFinally(smartScenes,(function(smartScene,done){_this.recallSmartScene(smartScene,(function(errors,data){hasErrors(errors)&&(allErrors=allErrors.concat(errors)),done()}))}),(function(){callback(allErrors)}))},ClipUtils.prototype.getSmartScenesLights=function(smartScenes,callback){var _this=this,allSmartScenes=[],allLights=[],allErrors=[];ForEachAndFinally(smartScenes,(function(smartSceneReference,done){_this.getSceneOrSmartScene(smartSceneReference,(function(errors,smartScene){_this.hasErrors(errors)?allErrors=allErrors.concat(errors):smartScene&&(allSmartScenes=allSmartScenes.concat(smartScene)),done()}))}),(function(){allErrors.length>0?callback(allErrors,[]):ForEachAndFinally(allSmartScenes,(function(smartScene,done){_this.getLightsInGroup(smartScene.group,(function(errors,lights){_this.hasErrors(errors)?allErrors=allErrors.concat(errors):lights&&(allLights=allLights.concat(lights)),done()}))}),(function(){callback(allErrors,0===allErrors.length?allLights:[])}))}))},ClipUtils.prototype.deleteResource=function(resource,callback){this.clip.delete("/"+resource.rtype+"/"+resource.rid,processResponseWithCallback(callback))},ClipUtils.prototype.disableInstance=function(id,callback){this.clip.put("/behavior_instance/"+id,{enabled:!1},processResponseWithCallback(callback))},ClipUtils.prototype.triggerBehaviorInstance=function(id,action,callback){var _a;this.clip.put("/behavior_instance/"+id,{trigger:(_a={},_a[action]={},_a)},processResponseWithCallback(callback))},ClipUtils.prototype.getEntertainmentConfiguration=function(configuration,callback){this.clip.get("/entertainment_configuration/"+configuration,processResponseWithCallback(callback))},ClipUtils.prototype.getLightsInWhere=function(where,callback){var _this=this,allErrors=[],lights=[];ForEachAndFinally(where,(function(whereItem,done){whereItem.items?(lights=lights.concat(whereItem.items),done()):_this.getLightsInGroup(whereItem.group,(function(errors,lightsGet){hasErrors(errors)?allErrors=allErrors.concat(errors):lights=lights.concat(lightsGet),done()}))}),(function(){return callback(allErrors,lights)}))},ClipUtils.prototype.getInterestedLightsStateInWhere=function(where,matcher,resultCallback){var _this=this;this.getLightsInWhere(where,(function(errors,lights){if(ClipUtils.prototype.hasErrors(errors))resultCallback(errors);else{var allErrors_1=[];ForEachAndFinally(lights,(function(light,done){_this.getResource(light,(function(errors,lightState){var _a;ClipUtils.prototype.hasErrors(errors)?allErrors_1=allErrors_1.concat(errors):matcher.filter(lightState)?matcher.onMatchingResource(lightState):null===(_a=matcher.onUnmatchingResource)||void 0===_a||_a.call(matcher,lightState),done()}))}),(function(){return resultCallback(allErrors_1)}))}}))},ClipUtils.prototype.stopEffectOnLight=function(light,stopTimedEffects){var _this=this,prepareStopCommand=function(latestLightState){return stopTimedEffects&&((lightState=latestLightState).gradient&&Environment.includesAny(null!==(_b=null===(_a=lightState.timed_effects)||void 0===_a?void 0:_a.effect_values)&&void 0!==_b?_b:[],"sunset","sunrise"))?{timed_effects:{effect:"no_effect"}}:Object.keys(latestLightState).reduce((function(acc,key){return Environment.__assign(Environment.__assign(Environment.__assign(Environment.__assign(Environment.__assign({},acc),"on"===key&&latestLightState.on.on&&{on:{on:!0}}),"color"===key&&{color:{xy:{x:latestLightState.color.xy.x,y:latestLightState.color.xy.y}}}),"color_temperature"===key&&{color_temperature:{mirek:latestLightState.color_temperature.mirek}}),"dimming"===key&&{dimming:{brightness:latestLightState.dimming.brightness}})}),{});var lightState,_a,_b};this.getResource(light,(function(errors,state){ClipUtils.prototype.hasErrors(errors)||_this.setLightState(light,prepareStopCommand(state),(function(_){}))}))},ClipUtils.prototype.playChimeSoundOnSpeaker=function(speaker_service,type,sound,volume,resultCallback){var _a,_b,putRequest=((_a={})[type]={sound:sound},_a);null!=volume&&((_b={})[type]={sound:sound,volume:{level:volume}},putRequest=_b),this.clip.put("/speaker/"+speaker_service.rid,putRequest,processResponseWithCallback(resultCallback))},ClipUtils}(),ScriptEnvironmentWithClipUtils=function(_super){function ScriptEnvironmentWithClipUtils(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(ScriptEnvironmentWithClipUtils,_super),Object.defineProperty(ScriptEnvironmentWithClipUtils.prototype,"clipUtils",{get:function(){return new ClipUtils(this.clip,this.timer)},enumerable:!1,configurable:!0}),ScriptEnvironmentWithClipUtils}(Environment.ScriptEnvironment);exports.ClipUtils=ClipUtils,exports.ForEachAndFinally=ForEachAndFinally,exports.ScriptEnvironmentWithClipUtils=ScriptEnvironmentWithClipUtils;
