"use strict";var Environment=require("hue-shared/lib-4.js"),what=require("hue-shared/lib-0.js"),get_error_message=require("hue-shared/lib-1.js"),script_environment=require("hue-shared/lib-2.js"),barrier=require("hue-shared/lib-3.js"),where=require("hue-shared/lib-16.js"),time_point=require("hue-shared/lib-14.js");function onStartHandler(onStart){return this.log.inform("'start' timer triggered at "+(new Date).toString()),Environment.fapply(onStart)}function onEndHandler(onEnd){return this.log.inform("'end' timer triggered at "+(new Date).toString()),Environment.fapply(onEnd)}require("hue-shared/lib-5.js"),require("hue-shared/lib-15.js");var WhenExtended=function(){function WhenExtended(env,config){this.env=env,this.config=config}return Object.defineProperty(WhenExtended.prototype,"startAtTimePoint",{get:function(){return new time_point.TimePoint(this.env,this.config.start_at.time_point)},enumerable:!1,configurable:!0}),Object.defineProperty(WhenExtended.prototype,"endAtTimePoint",{get:function(){return this.config.end_at?new time_point.TimePoint(this.env,this.config.end_at.time_point):void 0},enumerable:!1,configurable:!0}),WhenExtended.prototype.validateConfig=function(callback){var config=this.config,errors=[];("sunset"===config.start_at.time_point.type||"sunrise"===config.start_at.time_point.type||config.end_at&&("sunset"===config.end_at.time_point.type||"sunrise"===config.end_at.time_point.type))&&!this.env.geolocation.isConfigured()&&errors.push({description:"geolocation not configured"}),callback(errors)},WhenExtended.prototype.scheduleTimer=function(onStart,onEnd){this.startAtTimePoint.scheduleTimer(Environment.fbind(onStartHandler,this.env,onStart),this.config.randomization,this.config.recurrence_days,this.config.start_at.time_point.offset),this.endAtTimePoint&&this.endAtTimePoint.scheduleTimer(Environment.fbind(onEndHandler,this.env,onEnd),this.config.randomization,this.config.recurrence_days,this.config.end_at.time_point.offset)},WhenExtended.prototype.isRecurring=function(){var _a;return!!(null===(_a=this.config.recurrence_days)||void 0===_a?void 0:_a.length)},WhenExtended}();function Schedule(context,env,callback){this.context=context,this.env=env,this.scheduled=!0,this.init(callback)}Object.defineProperty(Schedule.prototype,"what",{get:function(){const config=this.context.config,turnOffTransitionTime=config.when_extended.end_at?config.when_extended.end_at.transition:null;return new what.What(this.env,this.context.id,config.what,null,turnOffTransitionTime)}}),Object.defineProperty(Schedule.prototype,"whenExtended",{get:function(){return new WhenExtended(this.env,this.context.config.when_extended)}}),Object.defineProperty(Schedule.prototype,"where",{get:function(){return new where.Where(this.env,this.context.config.where)}}),Schedule.prototype.init=function(callback){const barrier$1=new barrier.Barrier(3,(function(errors){callback(get_error_message.GetErrorMessage(errors))}));this.where.claimDependencies(barrier$1.arrive),this.what.init(barrier$1.arrive),this.whenExtended.validateConfig(barrier$1.arrive)},Schedule.prototype.disable=function(){const self=this;self.env.clipUtils.disableInstance(self.context.id,(function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&self.env.log.warn("Error while disabling instance: "+get_error_message.GetErrorMessage(errors))}))},Schedule.prototype.onStartHandler=function(){const self=this,config=self.context.config,shouldDisableAfterStart=!self.whenExtended.isRecurring()&&!config.when_extended.end_at;Environment.TimespanUtils.toMilliseconds(config.when_extended.start_at.transition)>0?self.what.basicActivateScenesWithTransition(config.when_extended.start_at.transition,(function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&self.env.log.warn("Activate scenes with transition: "+get_error_message.GetErrorMessage(errors)),shouldDisableAfterStart&&self.disable()})):self.what.activateScenes((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&self.env.log.warn("Activate scenes: "+get_error_message.GetErrorMessage(errors)),shouldDisableAfterStart&&self.disable()}))},Schedule.prototype.onEndHandler=function(){const self=this;self.context.config.when_extended.end_at&&self.what.turnOffLights((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&self.env.log.inform("Lights are already off or unreachable: "+get_error_message.GetErrorMessage(errors)),self.whenExtended.isRecurring()||self.disable()}))};const onStart=function(){return this.env.log.inform("onStart triggered at "+(new Date).toString()+" scheduled: "+JSON.stringify(this.scheduled)),this.scheduled&&this.onStartHandler(),!0},onEnd=function(){return this.env.log.inform("onStop triggered at "+(new Date).toString()+" scheduled: "+JSON.stringify(this.scheduled)),this.scheduled&&this.onEndHandler(),!0};Schedule.prototype.run=function(){this.whenExtended.scheduleTimer(Environment.fbind(onStart,this),Environment.fbind(onEnd,this))},Schedule.prototype.trigger=function(action){this.env.log.inform("received trigger: "+JSON.stringify(action)),"start"===action.debug&&this.onStartHandler(),"end"===action.debug&&this.onEndHandler(),void 0!==action.enabled&&(this.scheduled=action.enabled)},Schedule.Environment=script_environment.ScriptEnvironmentWithClipUtils,module.exports=Schedule;
