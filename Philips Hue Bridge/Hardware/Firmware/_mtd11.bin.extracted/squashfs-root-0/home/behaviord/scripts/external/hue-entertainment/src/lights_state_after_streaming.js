"use strict";var recipe=require("hue-shared/lib-5.js"),script_environment=require("hue-shared/lib-2.js");function WhereEntertainment(env,config,addLightIdsCallback,deleteLightIdsCallback,updateStatusCallback){this.lightIds=[],this.status=null,this.env=env,this.config=config,this.addLightIdsCallback=addLightIdsCallback,this.deleteLightIdsCallback=deleteLightIdsCallback,this.updateStatusCallback=updateStatusCallback}function Dispatcher(){this.callbacks=[]}function AsyncArrayIterator(array){this.array=array}function LightStateCache(clipUtils){this.clipUtils=clipUtils,this.states={}}function LightStateUtils(){}function PrivateSceneLightStateHandler(clipUtils,scriptId,recipeOptional){var that=this;const lightStateCache=new LightStateCache(clipUtils);function callbackClosure(callback,doneCallback,errorCallback){return function(){callback(doneCallback,errorCallback)}}function processResponse(errors,data,doneCallback,errorCallback){clipUtils.hasErrors(errors)?errorCallback&&errorCallback(JSON.stringify(errors||{})):doneCallback&&doneCallback(data)}function createOrUpdate(doneCallback,errorCallback){that.privateScene?function(doneCallback,errorCallback){clipUtils.updatePrivateScene(that.privateScene,LightStateUtils.toActions(lightStateCache.getAllStatesDictionary(),recipeOptional),(function(errors){processResponse(errors,void 0,doneCallback,errorCallback)}))}(doneCallback,errorCallback):function(doneCallback,errorCallback){clipUtils.createPrivateScene(scriptId,LightStateUtils.toActions(lightStateCache.getAllStatesDictionary(),recipeOptional),(function(errors,scene){processResponse(errors,scene,(function(scene){that.privateScene=scene,doneCallback()}),errorCallback)}))}(doneCallback,errorCallback)}that.privateScene=null,that.clear=function(){lightStateCache.clear()},that.addLightStates=function(lightIds,doneCallback,errorCallback){lightStateCache.add(lightIds,callbackClosure(createOrUpdate,doneCallback,errorCallback),errorCallback)},that.removeLightStates=function(lightIds,doneCallback,errorCallback){lightStateCache.remove(lightIds,callbackClosure(createOrUpdate,doneCallback,errorCallback),errorCallback)},that.recall=function(doneCallback,errorCallback){that.privateScene?clipUtils.recallScene(that.privateScene,{action:"active"},(function(errors){processResponse(errors,void 0,doneCallback,errorCallback)})):errorCallback("no private scene id")}}function SceneStateAfterStreaming(env,context,whereConfig,recipeOptional){const that=this;that.env=env,this.where=new WhereEntertainment(env,whereConfig,(function(lightIds){that.onLightsIdsAdded(lightIds)}),(function(lightIds){that.onLightIdsDeleted(lightIds)}),(function(newStatus){that.updateStatus(newStatus)})),this.dispatcher=new Dispatcher,this.sceneLightStateHandler=new PrivateSceneLightStateHandler(env.clipUtils,context.id,recipeOptional)}function LightStateAfterStreaming(context,env,doneCallback){var config=context.config,that=this;function initialize(Mode,where,recipe,doneCallback){that.mode=new Mode(env,context,where,recipe),that.mode.initialize(doneCallback)}switch(config.end_state){case"off":initialize(SceneStateAfterStreaming,config.where,{action:{on:{on:!1}}},doneCallback);break;case"last_state":initialize(SceneStateAfterStreaming,config.where,null,doneCallback);break;case"scene":initialize(SceneStateAfterStreaming,config.where,recipe.Recipe.get(config.end_scene.rid),doneCallback);break;case"do_nothing":doneCallback();break;default:doneCallback("end_state not supported!")}}require("hue-shared/lib-4.js"),WhereEntertainment.prototype.updateStatus=function(newStatus){if(!newStatus)return;const updateStatusCallback=this.updateStatusCallback;this.status!==newStatus&&(this.status=newStatus,updateStatusCallback&&updateStatusCallback(this.status))},WhereEntertainment.prototype.updateLightIds=function(services){if(!services)return;const that=this,addLightIdsCallback=this.addLightIdsCallback,deleteLightIdsCallback=this.deleteLightIdsCallback;var updatedLightIds=[],addedLightIds=[],deletedLightIds=[];const find=function(array,elementToMatch){var found=[];return array.forEach((function(element){element===elementToMatch&&found.push(element)})),found.length>0?found:null};services.forEach((function(service){"light"===service.rtype&&updatedLightIds.push(service.rid)})),that.lightIds.forEach((function(lightId){find(updatedLightIds,lightId)||deletedLightIds.push(lightId)})),updatedLightIds.forEach((function(lightId){find(that.lightIds,lightId)||addedLightIds.push(lightId)})),that.lightIds=updatedLightIds,addLightIdsCallback&&0!==Object.keys(addedLightIds).length&&addLightIdsCallback(addedLightIds),deleteLightIdsCallback&&0!==Object.keys(deletedLightIds).length&&deleteLightIdsCallback(deletedLightIds)},WhereEntertainment.prototype.initialize=function(successCallback,errorCallback){const config=this.config,env=this.env,that=this;if(!config)return void errorCallback("Config not present");if(!config.length)return void errorCallback("Config should be an array with atleast one element");const setConfig=function(config){"entertainment_configuration"===config.type&&(that.updateLightIds(config.light_services),that.updateStatus(config.status))},updateConfig=function(id,configs){configs.forEach((function(config){setConfig(config)}))};config.forEach((function(whereItem){"entertainment_configuration"===whereItem.group.rtype&&(env.dependency.claimCritical(whereItem.group.rid,whereItem.group.rtype),env.events.update.subscribe(whereItem.group.rid,updateConfig),env.clipUtils.getEntertainmentConfiguration(whereItem.group.rid,(function(errors,config){env.clipUtils.hasErrors(errors)?errorCallback(JSON.stringify(errors||{})):(setConfig(config),successCallback())})))}))},WhereEntertainment.prototype.getLightIds=function(){return this.lightIds},WhereEntertainment.prototype.getStatus=function(){return this.status},Dispatcher.prototype.SyncAction=function(callback){this.AsyncAction((function(done){callback(),done()}))},Dispatcher.prototype.AsyncAction=function(callback){const callbacks=this.callbacks;callbacks.push(callback),1===callbacks.length&&function ProcessAction(){callbacks.length&&callbacks[0]((function(){callbacks.shift(),ProcessAction()}))}()},AsyncArrayIterator.prototype.iterate=function(processFunc,doneCallback,errorCallback,index){var that=this;if(Array.isArray(that.array)){var arrayLength=that.array.length;null==index&&(index=0),arrayLength>index?processFunc(that.array[index],(function(){that.iterate(processFunc,doneCallback,errorCallback,index+1)}),errorCallback):doneCallback()}else errorCallback("Array not valid")},LightStateCache.prototype.add=function(lightIds,doneCallback,errorCallback){const that=this;new AsyncArrayIterator(lightIds).iterate((function(lightId,processDoneCallback,processErrorCallback){that.clipUtils.getResource({rid:lightId,rtype:"light"},(function(errors,data){that.clipUtils.hasErrors(errors)?processErrorCallback(JSON.stringify(errors||{})):(that.states[lightId]=data,processDoneCallback())}))}),doneCallback,errorCallback)},LightStateCache.prototype.remove=function(lightIds,doneCallback,errorCallback){const that=this;return new AsyncArrayIterator(lightIds).iterate((function(lightId,processDoneCallback,processErrorCallback){delete that.states[lightId],processDoneCallback()}),doneCallback,errorCallback)},LightStateCache.prototype.clear=function(){this.states={}},LightStateCache.prototype.getAllStatesDictionary=function(){return this.states},LightStateUtils.toActions=function(lightStatesDictionary,recipeOptional){var actions=[];return Object.keys(lightStatesDictionary).forEach((function(key){var state;actions.push({action:recipeOptional?recipe.Recipe.createCustomRecipeAction(recipeOptional,lightStatesDictionary[key]).action:(state=lightStatesDictionary[key],{on:state.hasOwnProperty("on")?{on:state.on.on}:void 0,color:state.hasOwnProperty("color")?{xy:state.color.xy}:void 0,dimming:state.hasOwnProperty("dimming")?{brightness:state.dimming.brightness}:void 0,color_temperature:state.hasOwnProperty("color_temperature")&&null!==state.color_temperature.mirek?{mirek:state.color_temperature.mirek}:void 0}),target:{rid:key,rtype:"light"}})})),actions},PrivateSceneLightStateHandler.prototype.clear=function(){return this.clear()},PrivateSceneLightStateHandler.prototype.addLightStates=function(lightIds,doneCallback,errorCallback){return this.addLightStates(lightIds,doneCallback,errorCallback)},PrivateSceneLightStateHandler.prototype.removeLightStates=function(lightIds,doneCallback,errorCallback){return this.removeLightStates(lightIds,doneCallback,errorCallback)},PrivateSceneLightStateHandler.prototype.recall=function(doneCallback,errorCallback){return this.recall(doneCallback,errorCallback)},SceneStateAfterStreaming.CreateWarningCallback=function(errorPrefix,doneCallback){return function(errorMessage){print(errorPrefix+": "+errorMessage),doneCallback&&doneCallback()}},SceneStateAfterStreaming.prototype.restoreLightStates=function(doneCallback){const that=this;that.env.timer.setTimeout((function(){that.env.log.inform("entertainment restore light state."),that.sceneLightStateHandler.recall(null,SceneStateAfterStreaming.CreateWarningCallback("Cannot recall lightstates"))}),{seconds:1}),doneCallback()},SceneStateAfterStreaming.prototype.onLightsIdsAdded=function(lightIds){const that=this;that.dispatcher.AsyncAction((function(doneCallback){"active"===that.where.getStatus()?that.sceneLightStateHandler.addLightStates(lightIds,doneCallback,SceneStateAfterStreaming.CreateWarningCallback("Cannot add lightstates for lightIds "+JSON.stringify(lightIds))):doneCallback()}))},SceneStateAfterStreaming.prototype.onLightIdsDeleted=function(lightIds){const that=this;that.dispatcher.AsyncAction((function(doneCallback){"active"===that.where.getStatus()?that.sceneLightStateHandler.removeLightStates(lightIds,doneCallback,SceneStateAfterStreaming.CreateWarningCallback("Cannot delete lightstates for lightIds "+JSON.stringify(lightIds))):doneCallback()}))},SceneStateAfterStreaming.prototype.addCurrentLightStates=function(doneCallback){this.sceneLightStateHandler.clear(),this.sceneLightStateHandler.addLightStates(this.where.getLightIds(),doneCallback,SceneStateAfterStreaming.CreateWarningCallback("Cannot add lightstates"))},SceneStateAfterStreaming.prototype.updateStatus=function(newStatus){const that=this;that.env.log.inform("entertainment script state changed: "+JSON.stringify(newStatus)),that.dispatcher.AsyncAction((function(doneCallback){"active"===newStatus?that.addCurrentLightStates(doneCallback):"inactive"===newStatus&&that.restoreLightStates(doneCallback)}))},SceneStateAfterStreaming.prototype.initialize=function(initializeDoneCallback){const that=this;that.dispatcher.AsyncAction((function(actionDoneCallback){that.where.initialize((function(){actionDoneCallback(),initializeDoneCallback()}),(function(errorMessage){actionDoneCallback(),initializeDoneCallback(errorMessage)}))}))},LightStateAfterStreaming.Environment=script_environment.ScriptEnvironmentWithClipUtils,module.exports=LightStateAfterStreaming;
