"use strict";var script_environment=require("./lib-2.js"),recipe=require("./lib-5.js"),barrier=require("./lib-3.js"),Environment=require("./lib-4.js"),emptyArray=[];function getLightsInWhatItem(clipUtils,config,callback){config.items&&config.items.length>0?callback(emptyArray,config.items,!1):clipUtils.getLightsInGroup(config.group,(function(errors,lightServices){errors&&errors.length>0?callback(errors):callback(emptyArray,lightServices,!0)}))}function applyActionCreatorOnLights(clipUtils,lights,excludedLights,actionCreator,lightsCache,callback){var filteredLights=lights.filter((function(light){return!excludedLights.some((function(excludedLight){return excludedLight.rid===light.rid}))})),usedLights=[],actions=[],allErrors=[];script_environment.ForEachAndFinally(filteredLights,(function(lightReference,done){!function(clipUtils,light,lightsCache,callback){void 0!==(null==lightsCache?void 0:lightsCache[light.rid])?callback(emptyArray,lightsCache[light.rid]):clipUtils.getResource(light,(function(errors,light){!clipUtils.hasErrors(errors)&&lightsCache&&(lightsCache[light.id]=light),callback(errors,light)}))}(clipUtils,lightReference,lightsCache,(function(errors,light){if(clipUtils.hasErrors(errors))allErrors=allErrors.concat(errors);else if(!function(light){return usedLights.some((function(id){return id===light.id}))}(light)){var action=actionCreator(light);(function(action){return action&&Object.keys(action.action).some((function(p){return void 0!==action.action[p]}))})(action)&&(actions.push(action),usedLights.push(light.id))}done()}))}),(function(){callback(allErrors,actions)}))}function extractActions(clipUtils,whatItem,customActionGenerator,excludedLights,lightsCache,done){var actionCreator,_this=this,createActionsForLights=function(actionCreator,lights,done,lightsCache){applyActionCreatorOnLights(clipUtils,lights,excludedLights,actionCreator,lightsCache,done)};if(whatItem.actions)return done(null,whatItem.actions,!1,0),!0;if(customActionGenerator)actionCreator=createActionsForLights.bind(this,customActionGenerator);else{if(!whatItem.recall||"recipe"!==whatItem.recall.rtype)return!1;actionCreator=createActionsForLights.bind(this,(function(light){return recipe.Recipe.createRecipeAction(whatItem.recall.rid,light)}))}return actionCreator&&getLightsInWhatItem(clipUtils,whatItem,(function(errors,items,isWholeGroup){clipUtils.hasErrors(errors)?done(errors):actionCreator.apply(_this,[items,function(errors,actions){done(errors,actions,!0,isWholeGroup?1:0)},lightsCache])})),!0}function addIfNotExist(elements,newElement,predicate){var addSingleElement=function(elementToAdd){return!elements.some((function(element){return predicate(element,elementToAdd)}))&&elements.push(elementToAdd)};Array.isArray(newElement)?newElement.forEach((function(elementToAdd){return addSingleElement(elementToAdd)})):addSingleElement(newElement)}var areRefsEqual=function(a,b){return a.rid===b.rid&&a.rtype===b.rtype},areActionsEqual=function(a,b){return areRefsEqual(a.target,b.target)},WhatResourcesCreator=function(){function WhatResourcesCreator(clipUtils,scriptId,config,hasOffTransitionTime,customAction){this.clipUtils=clipUtils,this.scriptId=scriptId,this.config=config,this.hasOffTransitionTime=hasOffTransitionTime,this.customAction=customAction,this.actions_=[],this.scenes_=[],this.smartScenes_=[],this.hasRecipe_=!1,this.hasBlink_=!1,this.wholeGroupCount_=0,this.allLights_=[],this.allBlinkLights_=[],this.allErrors=[],this.offGroup_=null,this.allBlinkLightsGroup_=null,this.groupUpdateRequired_=!1,this.lightsCache={}}return WhatResourcesCreator.prototype.createScenes=function(done){var _this=this;script_environment.ForEachAndFinally(this.config,this.extractScenesAndActions.bind(this),(function(){_this.clipUtils.hasErrors(_this.allErrors)?done(_this.allErrors):_this.handleOffAction(_this.scenes_,_this.smartScenes_,_this.actions_,(function(){_this.clipUtils.hasErrors(_this.allErrors)?done(_this.allErrors):_this.createPrivateScene(_this.actions_,(function(){_this.clipUtils.hasErrors(_this.allErrors)?done(_this.allErrors):_this.handleBlinkAction((function(){done(_this.allErrors,_this.scenes_,_this.smartScenes_,_this.sceneHash_,_this.offGroup_,_this.groupUpdateRequired_,_this.hasRecipe_,_this.hasBlink_,_this.allBlinkLightsGroup_,_this.offScene_,_this.offSceneHash_)}))}))}))}))},WhatResourcesCreator.prototype.processNewErrors=function(errors){return!!this.clipUtils.hasErrors(errors)&&(this.allErrors=this.allErrors.concat(errors),!0)},WhatResourcesCreator.prototype.extractScenesAndActions=function(whatItem,done){var _this=this;this.clipUtils.getResource(whatItem.group,(function(errors,_group){if(_this.clipUtils.hasErrors(errors)&&(_this.processNewErrors(errors),done()),whatItem.blink)return _this.hasBlink_=!0,void getLightsInWhatItem(_this.clipUtils,whatItem,(function(errors,lights,isWholeGroup){_this.allBlinkLights_=_this.allBlinkLights_.concat(lights),_this.wholeGroupCount_+=isWholeGroup?1:0,done()}));whatItem.actions||whatItem.recall&&"recipe"===whatItem.recall.rtype||_this.customAction?extractActions(_this.clipUtils,whatItem,_this.customAction,[],_this.lightsCache,(function(errors,actions,hasRecipe,wholeGroupCount){_this.processNewErrors(errors)||(addIfNotExist(_this.actions_,actions,areActionsEqual),_this.hasRecipe_=_this.hasRecipe_||hasRecipe,_this.wholeGroupCount_+=wholeGroupCount),done()})):(whatItem.recall&&"scene"===whatItem.recall.rtype&&_this.clipUtils.getSceneOrSmartScene(whatItem.recall,(function(errors,scene){if(_this.clipUtils.hasErrors(errors))_this.processNewErrors(errors),done();else if(whatItem.items&&whatItem.items.length>0&&scene){var actions_1=[];whatItem.items.forEach((function(light){var action=scene.actions.filter((function(action){return action.target.rid===light.rid&&action.target.rtype===light.rtype}))[0];action&&actions_1.push(action)})),addIfNotExist(_this.actions_,actions_1,areActionsEqual),done()}else addIfNotExist(_this.scenes_,whatItem.recall,areRefsEqual),done()})),whatItem.recall&&"smart_scene"===whatItem.recall.rtype&&_this.clipUtils.getSceneOrSmartScene(whatItem.recall,(function(errors,_scene){_this.clipUtils.hasErrors(errors)?_this.processNewErrors(errors):addIfNotExist(_this.smartScenes_,whatItem.recall,areRefsEqual),done()})))}))},WhatResourcesCreator.prototype.handleOffAction=function(scenes,smartScenes,actions,done){var _this=this;if(1===this.config.length&&!this.config[0].items&&!this.config[0].actions&&!this.hasOffTransitionTime)return this.offGroup_=this.config[0].group,void done();var allLights=[],barrier$1=new barrier.Barrier(2,(function(errors){_this.processNewErrors(errors)?done():(addIfNotExist(_this.allLights_,actions.map((function(action){return action.target})),areRefsEqual),addIfNotExist(_this.allLights_,allLights.map((function(light){return{rid:light.id?light.id:light.rid,rtype:light.type?light.type:light.rtype}})),areRefsEqual),addIfNotExist(_this.allLights_,_this.allBlinkLights_,areRefsEqual),_this.groupUpdateRequired_=_this.groupUpdateRequired_=_this.config.length>1&&(_this.config.some((function(config){return!config.items&&!config.actions}))||scenes.length>0||smartScenes.length>0),_this.hasOffTransitionTime?_this.createPrivateOffScene((function(errors,offScene,offSceneHash){_this.processNewErrors(errors),_this.offScene_=offScene,_this.offSceneHash_=offSceneHash,done()})):_this.clipUtils.createPrivateGroup(_this.scriptId,_this.allLights_,(function(errors,group){_this.processNewErrors(errors),_this.offGroup_=group,done()})))})),extractLights=function(errors,lights){allLights=allLights.concat(lights),barrier$1.arrive(errors)};this.clipUtils.getScenesLights(scenes,extractLights),this.clipUtils.getSmartScenesLights(smartScenes,extractLights)},WhatResourcesCreator.prototype.handleBlinkAction=function(done){var _this=this,createBlinkGroup=function(done){1!==_this.config.length||_this.config[0].items?_this.clipUtils.createPrivateGroup(_this.scriptId,_this.allBlinkLights_,(function(errors,group){_this.processNewErrors(errors),_this.allBlinkLightsGroup_=group,done()})):(_this.allBlinkLightsGroup_=_this.config[0].group,done())};this.hasBlink_?this.allBlinkLights_.length===this.allLights_.length&&this.offGroup_?(this.allBlinkLightsGroup_=this.offGroup_,done()):createBlinkGroup(done):done()},WhatResourcesCreator.prototype.createPrivateScene=function(actions,doNext){var _this=this;0!==actions.length?this.clipUtils.createPrivateScene(this.scriptId,actions,(function(errors,scene){_this.processNewErrors(errors)||(_this.sceneHash_=hash(JSON.stringify(actions)),addIfNotExist(_this.scenes_,scene,areRefsEqual)),doNext()})):doNext()},WhatResourcesCreator.prototype.createPrivateOffScene=function(callback){var _this=this;applyActionCreatorOnLights(this.clipUtils,this.allLights_,[],(function(light){return recipe.Recipe.createRecipeAction(recipe.Recipe.getRecipeId("Off"),light)}),this.lightsCache,(function(errors,actions){_this.clipUtils.hasErrors(errors)?callback(errors):actions.length>0?_this.clipUtils.createPrivateScene(_this.scriptId,actions,(function(errors,scene){callback(errors,scene,hash(JSON.stringify(actions)))})):callback(errors)}))},WhatResourcesCreator}(),NoError=[],What=function(){function What(env,scriptId,config,recipe$1,turnOffTransitionTime,customActionGenerator){this.env=env,this.scriptId=scriptId,this.config=config,this.recipe=recipe$1,this.turnOffTransitionTime=turnOffTransitionTime,this.customActionGenerator=customActionGenerator,this._privateResourcesData={allBlinkLightsGroup:void 0,allLightsGroup:void 0,groupUpdateRequired:!1,hasBlink:!1,hasRecipe:!1,offScene:void 0,offSceneHash:"",sceneHash:"",scenes:[],smartScenes:[],excludedLightRefs:[]},recipe$1&&!customActionGenerator&&(recipe$1.recall&&"recipe"===recipe$1.recall.rtype?this.customActionGenerator=function(light){return recipe.Recipe.createRecipeAction(recipe$1.recall.rid,light)}:this.customActionGenerator=function(light){return recipe.Recipe.createCustomRecipeAction(recipe$1,light)})}return What.prototype.getPrivateResourcesData=function(callback){var _this=this;if(this.hasLoadedData)return callback(this._privateResourcesData);this.env.storage.retrieveData("what:resources",(function(error,data){_this.hasLoadedData=!0,!error&&(null==data?void 0:data.length)&&(_this._privateResourcesData=data[0]),callback(_this._privateResourcesData)}))},What.prototype.updatePrivateResourcesData=function(callback){this.env.storage.store("what:resources",this._privateResourcesData,callback)},What.prototype.init=function(callback){var _this=this;new WhatResourcesCreator(this.env.clipUtils,this.scriptId,this.config,this.hasOffTransitionTime(),this.customActionGenerator).createScenes((function(errors,scenes,smartScenes,sceneHash,allLightsGroup,groupUpdateRequired,hasRecipe,hasBlink,allBlinkLightsGroup,offScene,offSceneHash){if(!_this.env.clipUtils.hasErrors(errors))return _this._privateResourcesData.scenes=scenes,_this._privateResourcesData.smartScenes=smartScenes,_this._privateResourcesData.sceneHash=sceneHash,_this._privateResourcesData.offScene=offScene,_this._privateResourcesData.offSceneHash=offSceneHash,_this._privateResourcesData.allLightsGroup=allLightsGroup,_this._privateResourcesData.groupUpdateRequired=groupUpdateRequired,_this._privateResourcesData.hasRecipe=hasRecipe,_this._privateResourcesData.hasBlink=hasBlink,_this._privateResourcesData.allBlinkLightsGroup=allBlinkLightsGroup,_this.updatePrivateResourcesData(),_this.config.forEach((function(whatItem){_this.env.dependency.claimCritical(whatItem.group.rid,whatItem.group.rtype),whatItem.items&&whatItem.items.forEach((function(singleItem){_this.env.dependency.claimCritical(singleItem.rid,singleItem.rtype)})),!whatItem.recall||"scene"!==whatItem.recall.rtype&&"smart_scene"!==whatItem.recall.rtype||_this.env.dependency.claimCritical(whatItem.recall.rid,whatItem.recall.rtype)})),callback(errors);callback(errors)}))},What.prototype.updatePrivateScene=function(scenes,hasRecipe,lastPrivateSceneHash,callback,lightsCache){var _this=this;if(hasRecipe){var processNewErrors=function(errors){return!!_this.env.clipUtils.hasErrors(errors)&&(allErrors=allErrors.concat(errors),!0)},sceneHash_=lastPrivateSceneHash,allErrors=[],actions_=[],hasRecipe_=!1;script_environment.ForEachAndFinally(this.config,(function(whatItem,done){extractActions(_this.env.clipUtils,whatItem,_this.customActionGenerator,_this._privateResourcesData.excludedLightRefs,lightsCache,(function(errors,actions){processNewErrors(errors)||(addIfNotExist(actions_,actions,areActionsEqual),hasRecipe_=hasRecipe_||hasRecipe),done()}))||done()}),(function(){_this.env.clipUtils.hasErrors(allErrors)?callback(allErrors):(actions_.length>0||hasRecipe_)&&function(scene,actions,lastPrivateSceneHash,done){var sceneHash=hash(JSON.stringify(actions));lastPrivateSceneHash!==sceneHash&&scene&&actions.length>0?_this.env.clipUtils.updatePrivateScene(scene,actions,(function(errors){processNewErrors(errors)||(addIfNotExist(actions_,actions,areActionsEqual),sceneHash_=sceneHash),done()})):done()}(scenes[scenes.length-1],actions_,lastPrivateSceneHash,(function(){callback(allErrors,sceneHash_,actions_)}))}))}else{callback([])}},What.prototype.addExcludedLight=function(lightRef){this.isLightExcluded(lightRef)||(this._privateResourcesData.excludedLightRefs=this._privateResourcesData.excludedLightRefs.concat(lightRef))},What.prototype.isLightExcluded=function(lightRef){return this._privateResourcesData.excludedLightRefs.some((function(excludedLightRef){return excludedLightRef.rid===lightRef.rid&&excludedLightRef.rtype===lightRef.rtype}))},What.prototype.clearExcludedLights=function(){this._privateResourcesData.excludedLightRefs=[]},What.prototype.updatePrivateOffScene=function(scenes,smartScenes,offScene,offSceneHash,callback,lightsCache){var _this=this;this.getAllLightsUsedByScenesAndSmartScenes(scenes,smartScenes,(function(errors,lights){_this.env.clipUtils.hasErrors(errors)?callback(errors):0===lights.length?_this.env.clipUtils.deleteResource(offScene,(function(errors){callback(errors)})):applyActionCreatorOnLights(_this.env.clipUtils,lights,_this._privateResourcesData.excludedLightRefs,(function(light){return recipe.Recipe.createRecipeAction(recipe.Recipe.getRecipeId("Off"),light)}),lightsCache,(function(errors,actions){if(_this.env.clipUtils.hasErrors(errors))callback(errors);else{var newSceneHash_1=hash(JSON.stringify(actions));offSceneHash!==newSceneHash_1?offScene?_this.env.clipUtils.updatePrivateScene(offScene,actions,(function(errors){callback(errors,newSceneHash_1,offScene)})):_this.env.clipUtils.createPrivateScene(_this.scriptId,actions,(function(errors,scene){callback(errors,hash(JSON.stringify(actions)),scene)})):callback(NoError,offSceneHash,offScene)}}))}))},What.prototype.updatePrivateGroup=function(privateGroup,scenes,smartScenes,groupUpdateRequired,callback){var _this=this;groupUpdateRequired?this.getAllLightsUsedByScenesAndSmartScenes(scenes,smartScenes,(function(errors,lights){_this.env.clipUtils.hasErrors(errors)?callback(errors):_this.env.clipUtils.updatePrivateGroup(privateGroup,lights,(function(errors){callback(errors)}))})):callback()},What.prototype.updateCurrentPrivateScene=function(callback){var _this=this;this.getPrivateResourcesData((function(privateResourcesData){var updatePrivateSceneOffset={seconds:1};_this.updatePrivateScene(privateResourcesData.scenes,privateResourcesData.hasRecipe,privateResourcesData.sceneHash,(function(errors,sceneHash,actions){_this.env.clipUtils.hasErrors(errors)?callback(errors):actions&&actions.length>0?_this.env.timer.setTimeout((function(){privateResourcesData.sceneHash=sceneHash,_this.updatePrivateResourcesData(callback)}),updatePrivateSceneOffset):sceneHash?(errors.push("command (updatePrivateScene) may not have effect"),callback(errors)):(privateResourcesData.sceneHash=sceneHash,_this.updatePrivateResourcesData(callback))}),void 0)}))},What.prototype.activateScenes=function(callback){var _this=this;this.getPrivateResourcesData((function(privateResourcesData){var _a,_b,activateScenesLocal=function(){_this.updateCurrentPrivateScene((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)?callback(errors):_this.checkIfResourceDataHasScenesAndOrSmartScenes(privateResourcesData,(function(scenes,onDone){return _this.env.clipUtils.activateScenes(scenes,onDone)}),(function(smartScenes,onDone){return _this.env.clipUtils.recallSmartScenes(smartScenes,onDone)}),callback)}))},blinkCallback=(null===(_a=privateResourcesData.scenes)||void 0===_a?void 0:_a.length)>0||(null===(_b=privateResourcesData.smartScenes)||void 0===_b?void 0:_b.length)>0?activateScenesLocal:callback;privateResourcesData.hasBlink?_this.env.clipUtils.blinkGroupOfLights(privateResourcesData.allBlinkLightsGroup,blinkCallback):activateScenesLocal()}))},What.prototype.activateScenesWithTransition=function(transitionTime,callback){var _this=this;this.getPrivateResourcesData((function(privateResourcesData){_this.updateCurrentPrivateScene((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)?callback(errors):_this.checkIfResourceDataHasScenesAndOrSmartScenes(privateResourcesData,(function(scenes,onDone){return _this.env.clipUtils.activateScenesWithTransition(scenes,transitionTime,onDone)}),(function(smartScenes,onDone){return _this.env.clipUtils.recallSmartScenes(smartScenes,onDone)}),callback)}))}))},What.prototype.basicActivateScenesWithTransition=function(transitionTime,callback){var _this=this;this.getPrivateResourcesData((function(privateResourcesData){_this.updateCurrentPrivateScene((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)?callback(errors):_this.checkIfResourceDataHasScenesAndOrSmartScenes(privateResourcesData,(function(scenes,onDone){return _this.env.clipUtils.basicActivateScenesWithTransition(scenes,transitionTime,onDone)}),(function(smartScenes,onDone){return _this.env.clipUtils.recallSmartScenes(smartScenes,onDone)}),callback)}))}))},What.prototype.activateScenesWithInitialStateAndTransition=function(startState,transitionTime,callback,timerIdCallback){var _this=this;this.getPrivateResourcesData((function(privateResourcesData){_this.updateCurrentPrivateScene((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)?callback(errors):_this.checkIfResourceDataHasScenesAndOrSmartScenes(privateResourcesData,(function(scenes,onDone){return _this.env.clipUtils.activateScenesWithInitialStateAndTransition(scenes,startState,transitionTime,onDone,timerIdCallback)}),_this.env.clipUtils.recallSmartScenes,callback)}))}))},What.prototype.turnOffLights=function(callback){var _this=this;this.getPrivateResourcesData((function(privateResourcesData){var turnOffLightIfNotExcluded=function(activeLights){var lightsToBeTurnedOff=activeLights.filter((function(lightInstance){return!_this.isLightExcluded(lightInstance)}));script_environment.ForEachAndFinally(lightsToBeTurnedOff,function(lightInstance,done){this.env.clipUtils.turnOffLight(lightInstance,(function(){done()}))}.bind(_this),callback)};_this.hasOffTransitionTime()?_this.updatePrivateOffScene(privateResourcesData.scenes,privateResourcesData.smartScenes,privateResourcesData.offScene,privateResourcesData.offSceneHash,(function(errors,offSceneHash,offScene){_this.env.clipUtils.hasErrors(errors)||(privateResourcesData.offSceneHash=offSceneHash,privateResourcesData.offScene=offScene,_this.updatePrivateResourcesData()),_this.env.clipUtils.basicActivateScenesWithTransition([privateResourcesData.offScene],_this.turnOffTransitionTime,callback)}),void 0):_this.updatePrivateGroup(privateResourcesData.allLightsGroup,privateResourcesData.scenes,privateResourcesData.smartScenes,privateResourcesData.groupUpdateRequired,(function(){var lightsCb,allLights_;_this.customActionGenerator?(lightsCb=function(lightsInConfig){_this.env.clipUtils.getScenesLights(privateResourcesData.scenes,(function(sceneErrors,lightsInScenes){_this.env.clipUtils.hasErrors(sceneErrors)?turnOffLightIfNotExcluded(lightsInConfig):lightsInConfig.length===lightsInScenes.length&&0===privateResourcesData.excludedLightRefs.length?_this.env.clipUtils.turnOffGroupOfLights(privateResourcesData.allLightsGroup,callback):turnOffLightIfNotExcluded(lightsInConfig)}))},allLights_=[],script_environment.ForEachAndFinally(_this.config,function(whatItem,done){getLightsInWhatItem(_this.env.clipUtils,whatItem,(function(errors,lights){_this.env.clipUtils.hasErrors(errors)||addIfNotExist(allLights_,lights,areRefsEqual),done()}))}.bind(_this),(function(){lightsCb(allLights_)}))):_this.env.clipUtils.turnOffGroupOfLights(privateResourcesData.allLightsGroup,callback)}))}))},What.prototype.hasOffTransitionTime=function(){return this.turnOffTransitionTime&&Environment.TimespanUtils.toMilliseconds(this.turnOffTransitionTime)>0},What.prototype.getAllLightsUsedByScenesAndSmartScenes=function(scenes,smartScenes,callback){var _this=this,allLights_=[],barrier$1=new barrier.Barrier(2,(function(errors){callback(errors,allLights_)}));this.env.clipUtils.getSmartScenesLights(smartScenes,(function(errors,lights){_this.env.clipUtils.hasErrors(errors)||addIfNotExist(allLights_,lights,areRefsEqual),barrier$1.arrive(errors)})),this.env.clipUtils.getScenesLights(scenes,(function(errors,lights){_this.env.clipUtils.hasErrors(errors)||addIfNotExist(allLights_,lights,areRefsEqual),barrier$1.arrive(errors)}))},What.prototype.checkIfResourceDataHasScenesAndOrSmartScenes=function(privateResourcesData,onHasScenes,onHasSmartScenes,doFinally){var _a,_b,barrierCount=0,hasScenes=(null===(_a=privateResourcesData.scenes)||void 0===_a?void 0:_a.length)>0,hasSmartScenes=(null===(_b=privateResourcesData.smartScenes)||void 0===_b?void 0:_b.length)>0;barrierCount+=hasScenes?1:0,barrierCount+=hasSmartScenes?1:0;var barrier$1=new barrier.Barrier(barrierCount,(function(errors){doFinally(errors)}));hasScenes&&onHasScenes(privateResourcesData.scenes,(function(errors){barrier$1.arrive(errors)})),hasSmartScenes&&onHasSmartScenes(privateResourcesData.smartScenes,(function(errors){barrier$1.arrive(errors)}))},What}();exports.What=What;
