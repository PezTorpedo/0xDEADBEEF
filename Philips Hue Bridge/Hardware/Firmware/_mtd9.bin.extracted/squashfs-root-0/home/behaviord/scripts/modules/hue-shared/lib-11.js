"use strict";var actionFn,privateSceneActionFn,accessory=require("./lib-6.js"),helpers=require("./lib-8.js"),script_environment=require("./lib-2.js"),private_scene=require("./lib-7.js"),Environment=require("./lib-4.js"),get_error_message=require("./lib-1.js"),supportedFeatures=["on","dimming","dynamics","dimming_delta","color","color_temperature"],DimAction=function(){function DimAction(env,groupListener,defaultState){this.env=env,this.groupListener=groupListener,this.defaultState=defaultState}return DimAction.prototype.canExecute=function(state){return void 0===state&&(state=this.defaultState),void 0!==this.groupListener.groupedLight&&void 0!==state&&state.dimming_delta.brightness_delta>0},DimAction.prototype.execute=function(state){void 0===state&&(state=this.defaultState),this.canExecute(state)&&this.env.clipUtils.setLightState(this.groupListener.groupedLight,helpers.getSupportedFeatures(supportedFeatures,state),(function(){}))},DimAction}(),PreviousStateOnCancelAction=function(){function PreviousStateOnCancelAction(action,privateSceneAction,groups){this.action=action,this.privateSceneAction=privateSceneAction,this.groups=groups}return PreviousStateOnCancelAction.prototype.execute=function(){var _this=this;this.privateSceneAction.scene.updatePrivateScene((function(){return _this.action.execute()}),this.groups.map((function(group){return group.group})))},PreviousStateOnCancelAction.prototype.cancel=function(){var _a,_b;null===(_b=(_a=this.action).cancel)||void 0===_b||_b.call(_a),this.privateSceneAction.execute()},PreviousStateOnCancelAction.prototype.init=function(callback){new accessory.WhatGroup([this.privateSceneAction,this.action]).init(callback)},PreviousStateOnCancelAction}(),UpdateOffLights=function(){function UpdateOffLights(env,scene){this.env=env,this.scene=scene}return UpdateOffLights.prototype.execute=function(_state){var _this=this;void 0!==this.scene&&this.scene.hasInitialised&&this.scene.resource&&this.env.clipUtils.getScenesLights([this.scene.resource],(function(errors,lights,actions){if(!_this.env.clipUtils.hasErrors(errors)){var lightActions=lights.map((function(light,index){return{light:light,action:actions[index]}}));script_environment.ForEachAndFinally(lightActions,(function(_a,callback){var light=_a.light,action=_a.action;_this.env.clipUtils.setLightState(light,{dimming:action.dimming},callback)}),(function(){}))}}))},UpdateOffLights}(),createDimAction=function(dimmingDelta,duration){return function(context,where){return where.map((function(where){return new DimAction(context.env,where,{dimming_delta:dimmingDelta,dynamics:void 0!==duration?{duration:duration}:void 0})}))}},createDimWithPreviousStateAction=(actionFn=createDimAction({action:"down",brightness_delta:50}),privateSceneActionFn=accessory.createGroupedPreviousStateAction("private_scene_before_dim"),function(context,where){var privateSceneAction=privateSceneActionFn(context,where)[0],action=actionFn(context,where);return[new PreviousStateOnCancelAction(accessory.WhatGroup.wrapMultiple(action),privateSceneAction,where)]});var DimAlternateAction=function(){function DimAlternateAction(env,createDimActions,groupListeners,repeatInterval,brightnessDelta,state){this.env=env,this.createDimActions=createDimActions,this.groupListeners=groupListeners,this.repeatInterval=repeatInterval,this.brightnessDelta=brightnessDelta,this.state=state}return DimAlternateAction.prototype.canExecute=function(_payload,event){var _this=this;return("on_initial_press"===event||"on_repeat"===event)&&this.groupListeners.some((function(groupListener){var _a;return null===(_a=groupListener.state.on)||void 0===_a?void 0:_a.on}))&&this.createDimActions().some((function(dimAction){return dimAction.canExecute(_this.dimmingLightState)}))},DimAlternateAction.prototype.execute=function(payload,event){if(this.canExecute(payload,event)){var now=Date.now(),isCurrentExecutionWithinActivePeriod=this.isExecutionTimeWithinActivePeriod(now);"on_initial_press"===event&&(this.state.dimDirection=isCurrentExecutionWithinActivePeriod&&"down"===this.state.dimDirection?"up":"down"),new accessory.WhatGroup(this.createDimActions()).execute(this.dimmingLightState),this.state.lastExecutionTime=now}},Object.defineProperty(DimAlternateAction.prototype,"dimmingLightState",{get:function(){return{dimming_delta:{brightness_delta:this.brightnessDelta,action:this.state.dimDirection},dynamics:{duration:this.repeatInterval}}},enumerable:!1,configurable:!0}),DimAlternateAction.prototype.isExecutionTimeWithinActivePeriod=function(now){var lastExecutionTime=this.state.lastExecutionTime;return void 0!==lastExecutionTime&&now<=lastExecutionTime+3800},DimAlternateAction}(),createDimAlternateAction=function(brightnessDelta,duration){return function(context,where,stateKey){return[new DimAlternateAction(context.env,(function(){return createDimAction()(context,where)}),where,duration,brightnessDelta,context.env.state.get(stateKey,(function(){return{dimDirection:"stop"}})))]}},RecallSingleExtendedAction=function(){function RecallSingleExtendedAction(env,wheres,actions,withOff){this.env=env,this.wheres=wheres,this.actions=actions,this.withOff=withOff}return RecallSingleExtendedAction.prototype.init=function(callback){private_scene.barrier(this.actions,(function(action,barrierCallback){return action.init?action.init(barrierCallback):barrierCallback(void 0)}),callback,callback)},RecallSingleExtendedAction.prototype.execute=function(state,event,metadata){var _a,_this=this;(null===(_a=this.withOff)||void 0===_a?void 0:_a.enabled)&&this.wheres.some((function(where){var _a,_b;return null===(_b=null===(_a=where.state)||void 0===_a?void 0:_a.on)||void 0===_b?void 0:_b.on}))?this.wheres.forEach((function(where){var _a,_b;(null===(_b=null===(_a=where.state)||void 0===_a?void 0:_a.on)||void 0===_b?void 0:_b.on)&&_this.env.clipUtils.turnOffLight(where.groupedLight,(function(){}))})):this.actions.forEach((function(action){return action.execute(state,event,metadata)}))},RecallSingleExtendedAction}(),getSecondsFromTime=function(hours,minutes,seconds){return void 0===hours&&(hours=0),void 0===minutes&&(minutes=0),void 0===seconds&&(seconds=0),3600*hours+60*minutes+seconds},getSecondsSinceMidnight=function(schedule){return getSecondsFromTime(null==schedule?void 0:schedule.hour,null==schedule?void 0:schedule.minute)};function isTimeBetweenSchedules(time,from,to){var timeInSeconds=getSecondsFromTime(time.getHours(),time.getMinutes()),secondsSinceMidnightFrom=getSecondsSinceMidnight(from),secondsSinceMidnightTo=getSecondsSinceMidnight(to);return secondsSinceMidnightFrom>secondsSinceMidnightTo?timeInSeconds>=secondsSinceMidnightFrom||timeInSeconds<secondsSinceMidnightTo:timeInSeconds>=secondsSinceMidnightFrom&&timeInSeconds<secondsSinceMidnightTo}var getItemsSortedByStartTimeFn=function(resolveTime){return function(items){return items.slice().sort(function(resolveTime){return function(a,b){return getSecondsSinceMidnight(resolveTime(a))-getSecondsSinceMidnight(resolveTime(b))}}(resolveTime))}},ActionCycler=function(){function ActionCycler(slots,state,repeatTimeoutMs){void 0===repeatTimeoutMs&&(repeatTimeoutMs=3e3),this.slots=slots,this.state=state,this.repeatTimeoutMs=repeatTimeoutMs}return Object.defineProperty(ActionCycler.prototype,"current",{get:function(){return this.slots[this.state.currentIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(ActionCycler.prototype,"group",{get:function(){return new accessory.WhatGroup(this.slots)},enumerable:!1,configurable:!0}),Object.defineProperty(ActionCycler.prototype,"timeSinceLastEventHasExceededThreshold",{get:function(){return!this.state.lastEvent||Date.now()-this.state.lastEvent>this.repeatTimeoutMs},enumerable:!1,configurable:!0}),ActionCycler.prototype.execute=function(){this.timeSinceLastEventHasExceededThreshold?this.reset():this.next(),this.state.lastEvent=Date.now(),this.executeSlot()},ActionCycler.prototype.setRepeatTimeout=function(timeoutMs){this.repeatTimeoutMs=timeoutMs},ActionCycler.prototype.executeSlot=function(){this.state.failedExecutions>=this.slots.length?this.state.failedExecutions=0:this.canExecute()?(this.state.failedExecutions=0,this.current.execute()):(this.state.failedExecutions+=1,this.next(),this.executeSlot())},ActionCycler.prototype.next=function(){this.state.currentIndex+=1,this.state.currentIndex>=this.slots.length&&(this.state.currentIndex=0)},ActionCycler.prototype.canExecute=function(){return accessory.isExecutable(this.current)},ActionCycler.prototype.init=function(callback){this.group.init(callback)},ActionCycler.prototype.reset=function(){this.state.currentIndex=0},ActionCycler}(),TimeBased=function(_super){function TimeBased(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(TimeBased,_super),TimeBased.prototype.init=function(callback){0===this.slots.length?callback("Time based light without slots created"):_super.prototype.init.call(this,callback)},TimeBased.prototype.reset=function(){this.state.currentIndex=1===this.slots.length?0:Environment.findIndex(this.slots,(function(item){return item.canExecute(new Date)}))},TimeBased}(ActionCycler),TimeBasedSlot=function(){function TimeBasedSlot(actions,schedule,nextSchedule){this.actions=actions,this.schedule=schedule,this.nextSchedule=nextSchedule}return Object.defineProperty(TimeBasedSlot.prototype,"group",{get:function(){return new accessory.WhatGroup(this.actions)},enumerable:!1,configurable:!0}),TimeBasedSlot.prototype.execute=function(time){this.canExecute(time)&&this.group.execute()},TimeBasedSlot.prototype.canExecute=function(time){return time?isTimeBetweenSchedules(time,this.schedule,this.nextSchedule):this.actions.some((function(action){return accessory.isExecutable(action)}))},TimeBasedSlot.prototype.init=function(callback){this.group.init(callback)},TimeBasedSlot}(),getTimebasedSchedulesSortedByStartTime=getItemsSortedByStartTimeFn((function(item){return item.start_time})),createTimebased=function(context,schedules,wheres,speakers,stateKey){if((schedules.length>0&&schedules.every((function(schedule){return schedule.actions&&schedule.actions.length===(null==wheres?void 0:wheres.length)})))===(schedules.length>0&&schedules.every((function(schedule){var _a,_b;return schedule.signal&&(null===(_a=schedule.signal.lights)||void 0===_a?void 0:_a.length)===(null==wheres?void 0:wheres.length)&&(null===(_b=schedule.signal.sounds)||void 0===_b?void 0:_b.length)===(null==speakers?void 0:speakers.length)}))))return[new accessory.ErrorAction("Where has unmatched what or signal targets in time_based action")];var items=(schedules=getTimebasedSchedulesSortedByStartTime(schedules)).map((function(schedule,scheduleIndex){var _a,actions=context.createActions(wheres,speakers,schedule.actions?{recall_single:schedule.actions}:{signal:schedule.signal}),endTime=null===(_a=schedules[scheduleIndex+1])||void 0===_a?void 0:_a.start_time;return scheduleIndex+1===schedules.length&&(endTime=schedules[0].start_time),new TimeBasedSlot(actions,schedule.start_time,endTime)}));return[new TimeBased(items,context.env.state.get(stateKey,(function(){return{currentIndex:0,lastExecutionTime:0,failedExecutions:0}})))]},ActionCyclerExtended=function(){function ActionCyclerExtended(env,wheres,actions,repeatTimeout,withOff){var _a;this.env=env,this.wheres=wheres,this.actions=actions,this.hasOffEnabled=null!==(_a=null==withOff?void 0:withOff.enabled)&&void 0!==_a&&_a,repeatTimeout&&actions.forEach((function(action){var _a;null===(_a=action.setRepeatTimeout)||void 0===_a||_a.call(action,Environment.TimespanUtils.toMilliseconds(repeatTimeout))}))}return ActionCyclerExtended.prototype.init=function(callback){private_scene.barrier(this.actions,(function(action,barrierCallback){return action.init?action.init(barrierCallback):barrierCallback(void 0)}),callback,callback)},ActionCyclerExtended.prototype.execute=function(){var _this=this,didTurnOff=!1;this.hasOffEnabled&&this.actions.length>0&&this.actions[0].timeSinceLastEventHasExceededThreshold&&this.wheres.forEach((function(where){var _a,_b;(null===(_b=null===(_a=where.state)||void 0===_a?void 0:_a.on)||void 0===_b?void 0:_b.on)&&(_this.env.clipUtils.turnOffLight(where.groupedLight,(function(){})),didTurnOff=!0)})),didTurnOff||this.actions.forEach((function(action){return action.execute()}))},ActionCyclerExtended.prototype.canExecute=function(){return this.actions.some((function(action){return action.canExecute()}))},ActionCyclerExtended}(),SceneCycler=function(_super){function SceneCycler(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(SceneCycler,_super),SceneCycler.prototype.init=function(callback){0===this.slots.length?callback("Scene cycler without slots created"):_super.prototype.init.call(this,callback)},SceneCycler}(ActionCycler),SceneCyclerSlot=function(_super){function SceneCyclerSlot(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(SceneCyclerSlot,_super),SceneCyclerSlot.prototype.canExecute=function(){return this.actions.some((function(action){return accessory.isExecutable(action)}))},SceneCyclerSlot}(accessory.WhatGroup),createSceneCycle=function(context,config,wheres,speakers,stateKey){if(!config.every((function(cycle){return cycle.length===wheres.length})))return[new accessory.ErrorAction("Where has unmatched what in scene_cycle action")];var slots=config.map((function(cycle){var actions=context.createActions(wheres,speakers,{recall_single:cycle});return new SceneCyclerSlot(actions)}));return[new SceneCycler(slots,context.env.state.get(stateKey,(function(){return{currentIndex:0,failedExecutions:0}})))]},BridgeHomeOffAction=function(){function BridgeHomeOffAction(env){this.env=env,this.bridgeHomeOffActionCacheKey="".concat(BridgeHomeOffAction.toString())}return Object.defineProperty(BridgeHomeOffAction.prototype,"bridgeHomeGroup",{get:function(){return this.env.state.get(this.bridgeHomeOffActionCacheKey)},set:function(value){this.env.state.set(this.bridgeHomeOffActionCacheKey,value)},enumerable:!1,configurable:!0}),BridgeHomeOffAction.prototype.init=function(callback){var _this=this;if(void 0!==this.bridgeHomeGroup)return callback();new private_scene.ClipApi(this.env.clip).resource("bridge_home").getAll((function(bridgeHomes){_this.bridgeHomeGroup={rid:bridgeHomes[0].id,rtype:bridgeHomes[0].type},callback()}),(function(errors){return callback(errors[0])}))},BridgeHomeOffAction.prototype.execute=function(){this.canExecute()&&this.env.clipUtils.turnOffGroupOfLights(this.bridgeHomeGroup,(function(){}))},BridgeHomeOffAction.prototype.canExecute=function(){return void 0!==this.bridgeHomeGroup},BridgeHomeOffAction}(),BehaviorTriggerAction=function(){function BehaviorTriggerAction(env,behavior,trigger){this.env=env,this.behavior=behavior,this.trigger=trigger}return BehaviorTriggerAction.prototype.execute=function(){var _this=this;this.env.clipUtils.triggerBehaviorInstance(this.behavior.rid,this.trigger,(function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&_this.env.log.warn("Error while sending trigger to behavior instance: "+get_error_message.GetErrorMessage(errors))}))},BehaviorTriggerAction.prototype.init=function(callback){this.env.dependency.claimCritical(this.behavior.rid,this.behavior.rtype),callback()},BehaviorTriggerAction}(),SignalTriggerAction=function(){function SignalTriggerAction(env,where,speakers,soundActions,lightActions){this.env=env,this.where=where,this.speakers=speakers,this.soundActions=soundActions,this.lightActions=lightActions}return SignalTriggerAction.prototype.execute=function(){var _a,_b,_c,_d,_this=this,soundActionsWithSpeakers=null!==(_b=null===(_a=this.speakers)||void 0===_a?void 0:_a.map((function(speaker,i){return{speaker:speaker,soundAction:_this.soundActions[i]}})))&&void 0!==_b?_b:[],lightActionsWithWhere=null!==(_d=null===(_c=this.where)||void 0===_c?void 0:_c.map((function(where,i){return{where:where,lightAction:_this.lightActions[i]}})))&&void 0!==_d?_d:[],signalLight=function(_a,callback){var _b,_c,where=_a.where,lightAction=_a.lightAction,duration_ms=Environment.TimespanUtils.toMilliseconds(lightAction.duration);if(0!==duration_ms){var supportsColorSignaling=-1!==(null===(_c=null===(_b=where.state)||void 0===_b?void 0:_b.signaling)||void 0===_c?void 0:_c.signal_values.indexOf("on_off_color"));where.groupedLight?_this.env.clipUtils.setLightState(where.groupedLight,{signaling:Environment.__assign({signal:"on_off_color"!==lightAction.type&&"alternating"!==lightAction.type||!supportsColorSignaling?"on_off":lightAction.type,duration:duration_ms},lightAction.colors&&supportsColorSignaling?{colors:lightAction.colors}:{})},callback):callback()}else callback()};private_scene.barrier(soundActionsWithSpeakers,(function(_a,callback){var speaker=_a.speaker,soundAction=_a.soundAction;soundAction.sound?_this.env.clipUtils.playChimeSoundOnSpeaker(speaker,soundAction.type,soundAction.sound,soundAction.volume,callback):callback()}),(function(){private_scene.barrier(lightActionsWithWhere,signalLight,(function(){}))}))},SignalTriggerAction.prototype.init=function(callback){var _a,_b,_c,_d,_e,_this=this;(null===(_a=this.speakers)||void 0===_a?void 0:_a.length)===(null===(_b=this.soundActions)||void 0===_b?void 0:_b.length)&&(null===(_c=this.where)||void 0===_c?void 0:_c.length)===(null===(_d=this.lightActions)||void 0===_d?void 0:_d.length)?(null===(_e=this.speakers)||void 0===_e||_e.forEach((function(speaker){return _this.env.dependency.claimCritical(speaker.rid,speaker.rtype)})),callback()):callback("Mismatch between speaker targets and actions")},SignalTriggerAction}(),defaultConfiguration={all_off:accessory.createGroupedLightOffAction,home_off:function(context,_){return[new BridgeHomeOffAction(context.env)]},last_on:accessory.createLastOnAction,do_nothing:accessory.createEmptyAction,dim:createDimAction(),dim_down:createDimAction(),dim_up:createDimAction(),dim_alternate:createDimAlternateAction(),clamp:accessory.createEmptyAction,scene_cycle:createSceneCycle,scene_cycle_extended:function(context,config,wheres,speakers,stateKey){var sceneCycle=createSceneCycle(context,config.slots,wheres,speakers,stateKey);return sceneCycle[0]instanceof accessory.ErrorAction?[sceneCycle[0]]:[new ActionCyclerExtended(context.env,wheres,sceneCycle,config.repeat_timeout,config.with_off)]},recall_single:accessory.createRecallSingleAction,recall_single_extended:function(context,config,where,speakers,stateKey){return[new RecallSingleExtendedAction(context.env,where,accessory.createRecallSingleAction(context,config.actions,where),config.with_off)]},time_based:createTimebased,time_based_extended:function(context,config,wheres,speakers,stateKey){var timebased=createTimebased(context,config.slots,wheres,speakers,stateKey);return timebased[0]instanceof accessory.ErrorAction?[timebased[0]]:[new ActionCyclerExtended(context.env,wheres,timebased,config.repeat_timeout,config.with_off)]},recall:{recipe:function(context,what,where){var scene=context.env.state.get("private_scene:".concat(what.recall.rid,":").concat(where.group.rid),(function(){return new private_scene.PrivateSceneWithRecipes(context.scriptId,context.env).add([where.group,what.recall])}));return new accessory.RecallPrivateSceneAction(context.env,scene)},scene:accessory.createRecallSceneAction,smart_scene:accessory.createRecallSmartSceneAction},behavior_trigger:function(context,behaviorTrigger){return[new BehaviorTriggerAction(context.env,behaviorTrigger.behavior,behaviorTrigger.trigger)]},temporarily_dim:createDimWithPreviousStateAction,soft_off_restore_brightness:function(context){return[new UpdateOffLights(context.env,context.env.state.get("private_scene_before_dim"))]},previous_state:accessory.createPreviousStateAction(accessory.PREVIOUS_STATE_SCENE_NAME),signal:function(context,alertTrigger,where,speakers){return[new SignalTriggerAction(context.env,where,speakers,alertTrigger.sounds,alertTrigger.lights)]}};exports.createDimAction=createDimAction,exports.createDimAlternateAction=createDimAlternateAction,exports.defaultConfiguration=defaultConfiguration,exports.getCurrentItemByStartTimeFn=function(resolveTime){return function(items,time){return void 0===time&&(time=new Date),Environment.find(getItemsSortedByStartTimeFn(resolveTime)(items),(function(item,index,sortedItems){var endTime=resolveTime(sortedItems[(index+1)%sortedItems.length]);return isTimeBetweenSchedules(time,resolveTime(item),endTime)}))}};
