"use strict";var script_environment=require("hue-shared/lib-2.js"),private_scene=require("hue-shared/lib-7.js");require("hue-shared/lib-4.js"),require("hue-shared/lib-9.js"),require("hue-shared/lib-3.js"),require("hue-shared/lib-8.js"),require("hue-shared/lib-5.js");var SmokeAlarm=function(){function SmokeAlarm(context,env,resultCallback){this.context=context,this.env=env,this.resultCallback=resultCallback,this.state=void 0,this.timerId=void 0,this.init(resultCallback)}return Object.defineProperty(SmokeAlarm.prototype,"config",{get:function(){return this.context.config},enumerable:!1,configurable:!0}),SmokeAlarm.prototype.init=function(resultCallback){var _this=this;this.env.storage.clear(),this.setState("stopped");var subscribeToWhere=function(where,callback){var complete;complete=function(){script_environment.ForEachAndFinally(where,(function(whereItem,done){_this.env.log.debug("[smoke_alarm] subscribed Where: id: ".concat(whereItem.group.rid," type: ").concat(whereItem.group.rtype)),_this.env.events.update.subscribe(whereItem.group.rid,callback)&&_this.groups.push(whereItem.group.rid),"bridge_home"===whereItem.group.rtype?_this.env.clipUtils.getResource(whereItem.group,(function(errors,home){script_environment.ClipUtils.prototype.hasErrors(errors)||home.children.filter((function(child){return"room"===child.rtype})).forEach((function(room){_this.env.log.debug("[smoke_alarm] subscribed Where: id: ".concat(room.rid," type: ").concat(room.rtype)),_this.env.events.update.subscribe(room.rid,callback)&&_this.groups.push(room.rid)})),done()})):done()}),(function(){}))},script_environment.ForEachAndFinally(_this.groups,(function(groupId,done){_this.env.events.update.unsubscribe(groupId),done()}),(function(){_this.groups=[],complete()}))},getLightsExcludingSmartPlugs=function(lightIds,callback){var lightsWithoutSmartPlugs=[];script_environment.ForEachAndFinally(lightIds,(function(lightId,done){_this.env.clipUtils.getResource(lightId,(function(errors,data){_this.env.clipUtils.hasErrors(errors)?_this.env.log.debug("[smoke_alarm] failed to get light resource to exclude smart plugs"):"plug"!==data.metadata.archetype&&lightsWithoutSmartPlugs.push(lightId),done()}))}),(function(){callback(lightsWithoutSmartPlugs)}))},onWhereChange=function(){subscribeToWhere(_this.config.where,onWhereChange),_this.env.clipUtils.getLightsInWhere(_this.config.where,(function(errors,lightIds){script_environment.ClipUtils.prototype.hasErrors(errors)?_this.env.log.debug("[smoke_alarm] failed to get lights in where"):getLightsExcludingSmartPlugs(lightIds,(function(lightsWithoutSmartPlugs){_this.env.clipUtils.updatePrivateGroup(_this.private_group,lightsWithoutSmartPlugs,(function(errors,private_group_id){errors?_this.env.log.debug("[smoke_alarm] private group creation failed"):resultCallback(errors)}))}))}))};this.checkWhereConfig((function(errors){if(_this.env.clipUtils.hasErrors(errors))return _this.env.log.debug("[smoke_alarm] where check error"),void resultCallback(errors);_this.env.clipUtils.getLightsInWhere(_this.config.where,(function(errors,lightIds){_this.env.clipUtils.hasErrors(errors)?_this.env.log.debug("[smoke_alarm] failed to get lights in where"):getLightsExcludingSmartPlugs(lightIds,(function(lightsWithoutSmartPlugs){_this.env.clipUtils.createPrivateGroup(_this.context.id,lightsWithoutSmartPlugs,(function(errors,private_group_id){_this.env.clipUtils.hasErrors(errors)?_this.env.log.debug("[smoke_alarm] private group creation failed"):(_this.env.log.debug("[smoke_alarm] created private group "+private_group_id.rid),_this.private_group=private_group_id,_this.createPrivateScene(_this.private_group,(function(errors){if(_this.env.clipUtils.hasErrors(errors))return _this.env.log.debug("[smoke_alarm] private scene creation failed"),void resultCallback(errors)})))}))}))})),subscribeToWhere(_this.config.where,onWhereChange),_this.claimDependencies(resultCallback)}))},SmokeAlarm.prototype.trigger=function(action){var _a;switch(this.env.log.debug("[smoke_alarm] received trigger: "+JSON.stringify(action)),Object.getOwnPropertyNames(action)[0]){case"start":if("started"!==this.getState()){this.env.log.debug("[smoke_alarm] trigger: start");var effectDuration=null!==(_a=action.start.duration)&&void 0!==_a?_a:1800;this.start_effect(action.start.effect,effectDuration)}break;case"stop":"stopped"!==this.getState()&&(this.env.log.debug("[smoke_alarm] trigger: stop"),this.stop_effect((function(){})))}},SmokeAlarm.prototype.start_effect=function(effect,effectDuration){var _this=this;if("smoke_alarm"===effect){this.setState("started"),this.scene.updatePrivateScene((function(errors){_this.env.clipUtils.hasErrors(errors)&&_this.env.log.debug("[smoke_alarm] there where failures updating private scene"),_this.setAlarmLightState()}));var timeOffset={seconds:effectDuration};this.env.log.debug("[smoke_alarm] setting timeout for ".concat(effectDuration," seconds")),this.timerId=this.env.timer.setTimeout((function(){_this.env.log.debug("[smoke_alarm] timed out after ".concat(effectDuration," seconds")),_this.stop_effect((function(){}))}),timeOffset)}else this.env.log.debug("[smoke_alarm] no or wrong light effect defined")},SmokeAlarm.prototype.stop_effect=function(callback){var _a;this.setState("stopped"),this.timerId&&(this.env.timer.cancelTimer(this.timerId),this.timerId=void 0),(null===(_a=this.scene)||void 0===_a?void 0:_a.resource)&&this.env.clipUtils.recallScene(this.scene.resource,{action:"active"},(function(errors,data){})),this.env.log.debug("[smoke_alarm] stopped")},SmokeAlarm.prototype.setAlarmLightState=function(){var _this=this,lightState={on:{on:!0},dimming:{brightness:100},color_temperature:{mirek:500},color:{xy:{x:.6758,y:.3286}}};this.env.clipUtils.performWithGroupedLight(this.private_group,(function(groupedLight){_this.env.clipUtils.setLightState(groupedLight,lightState,(function(errors){errors&&_this.env.log.debug("[smoke_alarm] there where error updating invoking the alarm light state")}))}),(function(error,data){error&&_this.env.log.debug("[smoke_alarm] error getting the grouped light service of the group used")}))},SmokeAlarm.prototype.setState=function(state){this.state={smoke_alarm_state:state},this.env.persistence.storeState(this.state)},SmokeAlarm.prototype.getState=function(){var SmokeAlarmState;return this.state?SmokeAlarmState=this.state.smoke_alarm_state:this.env.persistence.isStatePersisted()&&(this.state=this.env.persistence.restoreState(),SmokeAlarmState=this.state.smoke_alarm_state),SmokeAlarmState},SmokeAlarm.prototype.checkWhereConfig=function(callback){var _this=this,allErrors=[],checkIfResourceExists=function(resource,doneItem){_this.env.clipUtils.getResource(resource,(function(errors,data){_this.env.clipUtils.hasErrors(errors)&&(_this.env.log.debug("[smoke_alarm] failed to get resource: ".concat(JSON.stringify(resource))),allErrors=allErrors.concat(errors),doneItem()),doneItem()}))};script_environment.ForEachAndFinally(this.config.where,(function(whereItem,doneItem){checkIfResourceExists(whereItem.group,(function(){whereItem.items?script_environment.ForEachAndFinally(whereItem.items,checkIfResourceExists,doneItem):doneItem()}))}),(function(){callback(0===allErrors.length?void 0:allErrors)}))},SmokeAlarm.prototype.claimDependencies=function(callback){var _this=this;this.config.where.forEach((function(where){where.group&&_this.env.dependency.claimCritical(where.group.rid,where.group.rtype),where.items&&where.items.forEach((function(item){_this.env.dependency.claimCritical(where.items[0].rid,where.items[0].rtype)}))})),callback()},SmokeAlarm.prototype.createPrivateScene=function(group,resultCallback){var _this=this;this.scene=new private_scene.PrivateSceneWithPreviousState(this.context.id,this.env),this.env.log.debug("createPrivateScene group "+JSON.stringify(group)),this.scene.add([group]),this.scene.init((function(){_this.env.log.debug("[smoke_alarm] created private scene successfully"),resultCallback()}),(function(){_this.env.log.debug("[smoke_alarm] failed to init private scene"),resultCallback(["failed to init private scene"])}))},SmokeAlarm.Environment=script_environment.ScriptEnvironmentWithClipUtils,SmokeAlarm}();module.exports=SmokeAlarm;
