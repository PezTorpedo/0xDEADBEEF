"use strict";var Environment=require("hue-shared/lib-4.js"),script_environment=require("hue-shared/lib-2.js"),get_error_message=require("hue-shared/lib-1.js"),time=require("hue-shared/lib-17.js"),cron_expression=require("hue-shared/lib-15.js"),utils=require("hue-shared/lib-9.js"),TimePointScheduler=function(){function TimePointScheduler(){}return TimePointScheduler.wrapCallback=function(callback,_a){var cancelIfNeeded=_a.cancelIfNeeded,_b=_a.recurrenceDays,recurrenceDays=void 0===_b?[]:_b;return function(){cancelIfNeeded(),(0===recurrenceDays.length||Environment.includes(recurrenceDays,cron_expression.WEEKDAYS[new Date(Date.now()).getDay()]))&&callback()}},TimePointScheduler.schedule=function(_a,callback,_b){var timer=_a.timer,config=_a.config,_c=void 0===_b?{}:_b,_d=_c.recurrenceDays,recurrenceDays=void 0===_d?[]:_d,_e=_c.offset,offset=void 0===_e?{}:_e,fireOnce=!recurrenceDays||0===recurrenceDays.length,callbackContext={timerId:null},wrappedCallback=this.wrapCallback(callback,{cancelIfNeeded:function(){fireOnce&&timer.cancelTimer(callbackContext.timerId)},recurrenceDays:recurrenceDays});switch(config.type){case"sunrise":callbackContext.timerId=timer.setRecurringSunriseAlarmWithOffset(wrappedCallback,offset);break;case"sunset":callbackContext.timerId=timer.setRecurringSunsetAlarmWithOffset(wrappedCallback,offset);break;case"time":var cronDays=fireOnce?cron_expression.WEEKDAYS:recurrenceDays;callbackContext.timerId=timer.setRecurringAlarmWithOffset(wrappedCallback,cron_expression.CronExpression.fromTimeWithRecurrence(config.time,cronDays),offset)}return{cancelTimer:function(){null!==callbackContext.timerId&&timer.cancelTimer(callbackContext.timerId),callbackContext.timerId=null}}},TimePointScheduler}(),getStateFromAction=function(action,defaultState){switch(action){case"activate":return"active";case"deactivate":return"inactive";default:return defaultState}},NaturalLight=function(){function NaturalLight(context,env,callback){this.context=context,this.env=env,this.timePointSchedulerCancellable=utils.noop,this.transitionDuration={minutes:1},this.init(callback)}return Object.defineProperty(NaturalLight.prototype,"config",{get:function(){return this.context.config},enumerable:!1,configurable:!0}),NaturalLight.prototype.init=function(cb){var action,_a,_b,config,callbackWithErrorMessage,validateTimeslotScene,_this=this,allErrors=[];action=this.config.action,_this.env.persistence.isStatePersisted()&&(_this.state=_this.env.persistence.restoreState()),_this.state=Environment.__assign(Environment.__assign({state:getStateFromAction(action,"active")},null!==(_a=_this.state)&&void 0!==_a?_a:{}),(null===(_b=_this.state)||void 0===_b?void 0:_b.is_dormant)?{state:"inactive"}:{}),_this.state.is_dormant=void 0,_this.state.active_timeslot=void 0,_this.env.persistence.storeState(_this.state),config=this.config,callbackWithErrorMessage=function(){cb(get_error_message.GetErrorMessage(allErrors,_this.env.log))},validateTimeslotScene=function(timeslot,done){_this.env.clipUtils.getSceneOrSmartScene(timeslot.target,(function(errors,scene){var lhs,rhs;_this.env.clipUtils.hasErrors(errors)?allErrors=allErrors.concat(errors):(lhs=scene.group,rhs=_this.config.group,lhs.rid===rhs.rid&&lhs.rtype===rhs.rtype?_this.env.dependency.claimCritical(timeslot.target.rid,timeslot.target.rtype):allErrors.push("invalid attribute value scene's group ID")),"sunrise"===timeslot.start_time.type&&allErrors.push("invalid attribute value 'sunrise'"),"sunset"!==timeslot.start_time.type||_this.env.geolocation.isConfigured()||allErrors.push("geolocation not configured"),done()}))},_this.config.transition_duration&&(_this.transitionDuration=_this.config.transition_duration),_this.env.clipUtils.getResource(config.group,(function(errors,_){allErrors=errors||[],_this.env.clipUtils.hasErrors(errors)||_this.env.dependency.claimCritical(config.group.rid,config.group.rtype),script_environment.ForEachAndFinally(_this.config.week_timeslots[0].timeslots,validateTimeslotScene.bind(_this),callbackWithErrorMessage)}))},NaturalLight.prototype.run=function(){"active"===this.state.state&&this.performNaturalLight()},NaturalLight.prototype.setActiveState=function(state){this.state.state=state},NaturalLight.prototype.setActiveTimeslot=function(id,weekday){this.state.active_timeslot={timeslot_id:id,weekday:weekday}},NaturalLight.prototype.resetActiveTimeslot=function(){this.state.active_timeslot=void 0},NaturalLight.prototype.getTimeslotsSyncedToSunset=function(){var now=new Date;return this.env.geolocation.isConfigured()?time.Time.getTimeslotsSyncedToSunset(this.env.geolocation.getDayTypeSunriseSunset(now),this.config.week_timeslots[0].timeslots).filter((function(timeslot){return"time"===timeslot.start_time.type})):this.config.week_timeslots[0].timeslots},NaturalLight.prototype.getActiveTimeslotIndex=function(startTimes,transitionDuration){var now=new Date,nowInSeconds=Environment.TimespanUtils.toSeconds({hours:now.getHours(),minutes:now.getMinutes(),seconds:now.getSeconds()}),nightTimeslotIndex=startTimes.length-1;function convertTimePointToTimespan(timePoint){return{hours:timePoint.time.hour,minutes:timePoint.time.minute,seconds:timePoint.time.second}}var currentTimeslotIndex,normalizeTime=function(time,startTime){return time>=startTime?time-startTime:time-startTime+Environment.TimespanUtils.toSeconds({hours:24})};if(0===startTimes.length)currentTimeslotIndex=0;else{var transitionDurationSeconds_1=Environment.TimespanUtils.toSeconds(transitionDuration),startTimeInSeconds=startTimes.map((function(timeslot,index){return index!==nightTimeslotIndex&&transitionDuration?Environment.TimespanUtils.toSeconds(convertTimePointToTimespan(timeslot.start_time))-transitionDurationSeconds_1:Environment.TimespanUtils.toSeconds(convertTimePointToTimespan(timeslot.start_time))})),startTimeNormalized_1=startTimeInSeconds[0];startTimeInSeconds=startTimeInSeconds.map((function(slotStartTime){return normalizeTime(slotStartTime,startTimeNormalized_1)}));var nowInSecondsNormalized_1=normalizeTime(nowInSeconds,startTimeNormalized_1);currentTimeslotIndex=Environment.findIndex(startTimeInSeconds,(function(_,i,startTimeInSeconds){return i<nightTimeslotIndex&&nowInSecondsNormalized_1<startTimeInSeconds[i+1]&&nowInSecondsNormalized_1>=startTimeInSeconds[i]})),currentTimeslotIndex=-1===currentTimeslotIndex?nightTimeslotIndex:currentTimeslotIndex}return this.env.log.debug("getCurrentTimeslotIndex: ".concat(currentTimeslotIndex)),currentTimeslotIndex},NaturalLight.prototype.getNextTimeslotIndex=function(currentIndex,timeslots){var timeslotCount=timeslots.length,timeslotCountWithoutNightTimeslot=timeslotCount-1;return currentIndex>=timeslotCountWithoutNightTimeslot&&(currentIndex=timeslotCountWithoutNightTimeslot-1),timeslotCount>1?(currentIndex+1)%timeslotCountWithoutNightTimeslot:0},NaturalLight.prototype.handleErrors=function(message,errors){return!!script_environment.ClipUtils.prototype.hasErrors(errors)&&(this.env.log.warn(message+get_error_message.GetErrorMessage(errors)),!0)},NaturalLight.prototype.performNaturalLight=function(){var _this=this;this.env.log.inform("Activating Smart Scene");var timeslots=this.getTimeslotsSyncedToSunset(),scheduleTimeslotScene=function(){var startTime=timeslots[activeTimeslotIndex].start_time;_this.timePointSchedulerCancellable=TimePointScheduler.schedule({timer:_this.env.timer,config:startTime},activateTimeslotScene,{offset:_this.transitionDuration}).cancelTimer},SceneRecallHandler=function(id,data,metadata){_this.env.log.debug("SceneRecallHandler --\x3e Id: ".concat(id," Data: ").concat(JSON.stringify(data)," Metadata: ").concat(JSON.stringify(metadata))),!NaturalLight.IsResourceUpdatedByMe(metadata,_this.context.id)&&data.some((function(item){var _a,_b;return void 0!==(null===(_a=item.status)||void 0===_a?void 0:_a.last_recall)||"inactive"===(null===(_b=item.status)||void 0===_b?void 0:_b.active)}))&&(_this.env.log.inform("Deactivate smartscene due to activated scene interrupted."),_this.trigger({action:"deactivate"}))},handleErrors=function(errors){return _this.handleErrors("performNaturalLight: ",errors)},activateTimeslotScene=function(isFirstActivation){void 0===isFirstActivation&&(isFirstActivation=!1);var sceneId,scene=timeslots[activeTimeslotIndex].target;sceneId=scene.rid,script_environment.ForEachAndFinally(timeslots,(function(timeslot,done){_this.env.events.update.unsubscribe(timeslot.target.rid),done()}),(function(){return _this.env.events.update.subscribe(sceneId,SceneRecallHandler)})),isFirstActivation?_this.env.clipUtils.activateScenes([scene],handleErrors):_this.env.clipUtils.basicActivateScenesWithTransition([scene],_this.transitionDuration,handleErrors),_this.setActiveTimeslot(activeTimeslotIndex,cron_expression.WEEKDAYS[(new Date).getDay()]),_this.env.persistence.storeState(_this.state),timeslots=_this.getTimeslotsSyncedToSunset();var nextIndex=_this.getNextTimeslotIndex(activeTimeslotIndex,timeslots);timeslots.length<=2&&nextIndex===activeTimeslotIndex?scheduleTimeslotScene():nextIndex!==activeTimeslotIndex&&(activeTimeslotIndex=nextIndex,scheduleTimeslotScene())};this.updateScriptStartingTime(),this.timePointSchedulerCancellable();var activeTimeslotIndex=this.getActiveTimeslotIndex(timeslots,this.transitionDuration);activateTimeslotScene(!0)},NaturalLight.prototype.trigger=function(trigger){var done,_this=this;done=function(){var newActiveState=getStateFromAction(trigger.action,"inactive");newActiveState===_this.state.state&&"active"!==newActiveState||("active"===newActiveState?(_this.setActiveState(newActiveState),_this.performNaturalLight()):"inactive"===newActiveState&&(_this.timePointSchedulerCancellable(),_this.setActiveState(newActiveState),_this.resetActiveTimeslot(),_this.logNaturalLightRunningTime(),_this.env.events.update.unsubscribeAll(),_this.env.persistence.storeState(_this.state)))},void 0===trigger.enabled&&done()},NaturalLight.prototype.updateScriptStartingTime=function(){this.state.start_time||(this.state.start_time=(new Date).getTime()/1e3)},NaturalLight.prototype.logNaturalLightRunningTime=function(){if(this.state.start_time){var difference=Math.round((new Date).getTime()/1e3-this.state.start_time);this.env.log.inform("Smart scene interrupted after ".concat(difference," seconds")),this.state.start_time=void 0}},NaturalLight.Environment=script_environment.ScriptEnvironmentWithClipUtils,NaturalLight.IsResourceUpdatedByMe=function(metadata,selfId){return"behavior"===metadata.event_origin&&"behavior_instance"===metadata.origin_rtype&&metadata.origin_rid===selfId},NaturalLight}();module.exports=NaturalLight;
