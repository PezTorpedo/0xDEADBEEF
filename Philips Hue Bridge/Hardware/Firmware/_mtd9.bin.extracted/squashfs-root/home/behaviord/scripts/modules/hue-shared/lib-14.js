"use strict";var Environment=require("./lib-4.js"),cron_expression=require("./lib-15.js");function onTimerEvent(data,callback){var _this=this,currentDay=new Date,dayName=cron_expression.WEEKDAYS[currentDay.getDay()],callCallback=function(){var _a,triggerNextDayFlag=null!==(_a=Environment.fapply(callback))&&void 0!==_a&&_a;data.recurrenceDays||(triggerNextDayFlag?_this.log.inform("The non-recurring timer is not cancelled!"):_this.timer.cancelTimer(data.timerId))};(!data.recurrenceDays||data.recurrenceDays.indexOf(dayName)>=0)&&(data.randomizationInSeconds>0?data.randomizationTimerId=this.timer.setTimeout(callCallback,{seconds:Math.floor(Math.random()*data.randomizationInSeconds)}):callCallback())}var TimePoint=function(){function TimePoint(env,config){this.env=env,this.config=config}return TimePoint.prototype.scheduleTimer=function(callback,randomization,recurrenceDays,offset){var randomizationInSeconds=Environment.TimespanUtils.toSeconds(randomization),additionalOffset={seconds:Environment.TimespanUtils.toSeconds(offset)+randomizationInSeconds/2};this.data={recurrenceDays:recurrenceDays,randomizationInSeconds:randomizationInSeconds};var callbackWrapper=Environment.fbind(onTimerEvent,this.env,this.data,callback);"sunrise"==this.config.type?this.data.timerId=this.env.timer.setRecurringSunriseAlarmWithOffset(callbackWrapper,additionalOffset):"sunset"==this.config.type?this.data.timerId=this.env.timer.setRecurringSunsetAlarmWithOffset(callbackWrapper,additionalOffset):"time"==this.config.type&&(this.data.timerId=this.env.timer.setRecurringAlarmWithOffset(callbackWrapper,cron_expression.CronExpression.fromTimeWithRecurrence(this.config.time,null!=recurrenceDays?recurrenceDays:cron_expression.WEEKDAYS),additionalOffset))},TimePoint.prototype.cancelTimer=function(){this.data&&(this.env.timer.cancelTimer(this.data.timerId),this.env.timer.cancelTimer(this.data.randomizationTimerId))},TimePoint}();exports.TimePoint=TimePoint;
