"use strict";var Environment=require("hue-shared/lib-4.js"),script_environment=require("hue-shared/lib-2.js"),when=require("hue-shared/lib-13.js"),get_error_message=require("hue-shared/lib-1.js"),helpers=require("hue-shared/lib-8.js"),barrier=require("hue-shared/lib-3.js"),utils=require("hue-shared/lib-9.js"),recipe=require("hue-shared/lib-5.js"),what=require("hue-shared/lib-0.js");require("hue-shared/lib-14.js"),require("hue-shared/lib-15.js");var Reachability,BrightnessProps,GtsRoutine=function(){function GtsRoutine(context,env,resultCallback){this.context=context,this.env=env,this.initializeState(),this.init(resultCallback)}return Object.defineProperty(GtsRoutine.prototype,"config",{get:function(){return this.context.config},enumerable:!1,configurable:!0}),GtsRoutine.prototype.initializeState=function(){this.env.persistence.storeState({gts_state:"stopped"})},Object.defineProperty(GtsRoutine.prototype,"when",{get:function(){return new when.When(this.env,this.config.when)},enumerable:!1,configurable:!0}),GtsRoutine.prototype.disable=function(){var _this=this;this.env.clipUtils.disableInstance(this.context.id,(function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&_this.env.log.warn("Error while disabling instance: "+get_error_message.GetErrorMessage(errors))}))},GtsRoutine.prototype.storeState=function(newState){var state=this.restoreState();if(state){if(state.gts_state=newState,"started"===newState){var now=new Date;state.fade_end_time=new Date(now.getTime()+Environment.TimespanUtils.toMilliseconds(this.config.fade_out_duration)).toISOString()}else state.fade_end_time&&delete state.fade_end_time;this.env.persistence.storeState(state)}},GtsRoutine.prototype.restoreState=function(){if(this.env.persistence.isStatePersisted())return this.env.persistence.restoreState()},GtsRoutine.minimumFadeOutDurationInSecs=300,GtsRoutine.endStateRecipes={turn_off:{first_matching_action:[{color_temperature:{mirek:447},color:{xy:{x:.5018,y:.4152}},dimming:{brightness:1}},{on:{on:!1}}]},nightlight:{recall:{rid:"28bbfeff-1a0c-444e-bb4b-0b74b88e0c95",rtype:"recipe"}},minimum_brightness:{first_matching_action:[{color_temperature:{mirek:447},color:{xy:{x:.5018,y:.4152}},dimming:{brightness:1}},{on:{on:!0}}]}},GtsRoutine}();!function(Reachability){Reachability[Reachability.Undefined=0]="Undefined",Reachability[Reachability.Reachable=1]="Reachable",Reachability[Reachability.Unreachable=2]="Unreachable"}(Reachability||(Reachability={})),function(BrightnessProps){BrightnessProps[BrightnessProps.Brightness=0]="Brightness",BrightnessProps[BrightnessProps.MinimumBrightness=1]="MinimumBrightness"}(BrightnessProps||(BrightnessProps={}));var Executor=function(){function Executor(env,instanceId,lightGetter,actionGetter,state,resultCallback){var _this=this;this.env=env,this.instanceId=instanceId,this.lightGetter=lightGetter,this.actionGetter=actionGetter,this.state=state,this.terminated=!1,this.recipes=[],this.populateActions(state,helpers.clipCallbackHandler((function(_){return _this.init(state,resultCallback)}),resultCallback))}return Executor.prototype.wait=function(duration,done,doTerminate){var _this=this;this.timerCallback=doTerminate,this.timerId=this.env.timer.setTimeout((function(){_this.timerCallback=void 0,_this.timerId=void 0,done()}),duration)},Executor.prototype.populateActions=function(state,completed){var _this=this,lightIds=this.lightGetter(state);this.previousRecipes=utils.clone(this.recipes),this.recipes=[],script_environment.ForEachAndFinally(lightIds,(function(lightId,done){var recipe=_this.actionGetter(state,lightId);recipe&&_this.recipes.push(recipe),done()}),(function(){return null==completed?void 0:completed([])}))},Executor.prototype.terminate=function(duration,cancelTimer,endAction){var _a;if(void 0===endAction&&(endAction=this.previousRecipes),this.terminated=!0,this.timerId){cancelTimer(this.timerId);var overwrittenEndAction=endAction.map((function(recipe){return{action:Object.keys(recipe.action).reduce((function(acc,key){var _a,_b;return Environment.__assign(Environment.__assign({},acc),"dimming_delta"===key?((_a={})[key]={action:"stop"},_a):((_b={})[key]=recipe.action[key],_b))}),{}),target:recipe.target}}));null===(_a=this.timerCallback)||void 0===_a||_a.call(this,duration,overwrittenEndAction)}},Executor.prototype.reset=function(){this.terminated=!1,this.timerCallback=void 0,this.timerId=void 0},Executor.prototype.execute=function(state,duration,onDone,onLightsUpdated){var _this=this;this.terminated?onDone():(this.wait(duration,onDone,(function(terminationDuration,endAction){return _this.sendLightCommand(endAction,terminationDuration,onDone)})),this.sendLightCommand(this.recipes,duration,(function(){_this.populateActions(state,(function(){return null==onLightsUpdated?void 0:onLightsUpdated(utils.noop)}))})))},Executor.addDynamics=function(action,duration){return Environment.__assign(Environment.__assign({},action),duration?{dynamics:{duration:Environment.TimespanUtils.toMilliseconds(duration)}}:null)},Executor}(),GroupCastExecutor=function(_super){function GroupCastExecutor(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(GroupCastExecutor,_super),GroupCastExecutor.prototype.init=function(state,resultCallback){var _this=this;this.env.log.debug("GroupCastExecutor::init"),this.lightIdsInGroup=this.lightGetter(state),this.env.clipUtils.createPrivateGroup(this.instanceId,this.lightIdsInGroup.map((function(lightId){return{rid:lightId,rtype:"light"}})),helpers.clipCallbackHandler((function(group){_this.privateGroup=group,resultCallback([])}),resultCallback))},GroupCastExecutor.prototype.populateActions=function(state,completed){var _this=this;this.updatePrivateGroupIfLightsChanged(this.lightGetter(state),(function(){_this.previousRecipes=utils.clone(_this.recipes),_this.recipes=[_this.actionGetter(state)],null==completed||completed([])}))},GroupCastExecutor.prototype.sendLightCommand=function(recipes,duration,doNext){var _a,_this=this;this.env.log.debug("GroupCastExecutor::sendLightCommand"),this.privateGroup&&this.lightIdsInGroup.length>0&&(null===(_a=recipes[0])||void 0===_a?void 0:_a.action)?this.env.clipUtils.performWithGroupedLight(this.privateGroup,(function(service,whatCallback){_this.env.clipUtils.setLightState(service,Executor.addDynamics(recipes[0].action,duration),whatCallback)}),doNext):doNext()},GroupCastExecutor.prototype.updatePrivateGroupIfLightsChanged=function(expectedLightIds,doNext){var _this=this;this.privateGroup?Environment.equalsBy(expectedLightIds,this.lightIdsInGroup)?(this.env.log.debug("GroupCastExecutor -> No change in the lights."),doNext()):(this.env.log.debug("GroupCastExecutor -> Lights changed! old: ".concat(JSON.stringify(this.lightIdsInGroup)," new: ").concat(JSON.stringify(expectedLightIds))),this.env.clipUtils.updatePrivateGroup(this.privateGroup,expectedLightIds.map((function(id){return{rid:id,rtype:"light"}})),(function(e){_this.lightIdsInGroup=expectedLightIds,doNext(e)}))):doNext()},GroupCastExecutor}(Executor),LightCastExecutor=function(_super){function LightCastExecutor(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(LightCastExecutor,_super),LightCastExecutor.prototype.init=function(_state,resultCallback){this.env.log.debug("LightCastExecutor::init"),resultCallback([])},LightCastExecutor.prototype.sendLightCommand=function(recipes,duration,doNext){var _this=this;this.env.log.debug("LightCastExecutor::sendLightCommand"),script_environment.ForEachAndFinally(recipes,(function(recipe,done){_this.env.clipUtils.setLightState(recipe.target,Executor.addDynamics(recipe.action,duration),done)}),doNext)},LightCastExecutor}(Executor),SceneCastExecutor=function(_super){function SceneCastExecutor(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(SceneCastExecutor,_super),SceneCastExecutor.prototype.init=function(state,resultCallback){var _this=this;this.env.log.debug("SceneCastExecutor::init"),0===this.recipes.length?this.env.clipUtils.createPrivateScene(this.instanceId,this.lightGetter(state).map((function(lightId){return{target:{rtype:"light",rid:lightId},action:{}}})),helpers.clipCallbackHandler((function(scene){_this.privateScene=scene,resultCallback([])}),resultCallback),"current_light_states"):resultCallback([])},SceneCastExecutor.prototype.sendLightCommand=function(_recipes,duration,doNext){this.env.log.debug("SceneCastExecutor::sendLightCommand"),this.privateScene&&this.recipes.length>0?this.env.clipUtils.recallScene(this.privateScene,{action:"active",duration:Environment.TimespanUtils.toMilliseconds(duration)},doNext):doNext()},SceneCastExecutor.prototype.populateActions=function(state,completed){var _this=this;_super.prototype.populateActions.call(this,state,(function(){_this.recipes.length>0?_this.privateScene?_this.env.clipUtils.updatePrivateScene(_this.privateScene,_this.recipes,completed):_this.env.clipUtils.createPrivateScene(_this.instanceId,_this.recipes,helpers.clipCallbackHandler((function(scene){_this.privateScene=scene,completed([])}),completed)):completed([])}))},SceneCastExecutor}(Executor);var EffectSimulator=function(){function EffectSimulator(env,instanceId,style,fadeDuration,where,interruptionManager,initialActions,timeslots,timeslotsSimulationStrategy,resultCallback){this.env=env,this.instanceId=instanceId,this.style=style,this.fadeDuration=fadeDuration,this.where=where,this.interruptionManager=interruptionManager,this.timeslots=timeslots,this.timeslotsSimulationStrategy=timeslotsSimulationStrategy,this.currentTimeslotIndex=0,this.state="idle",this.initialActions=utils.clone(initialActions),this.selectedInitialAction=utils.clone(initialActions.normalAction),this.init(resultCallback)}return EffectSimulator.prototype.init=function(resultCallback){var _this=this,resultHandler=function(callback){return helpers.clipCallbackHandler(callback,resultCallback)},createTimeslotsExecutor=function(resultCallback){var ExecutorTypeMap;_this.env.log.debug("initializeTimeslotsExecutor:: timeslots: "+JSON.stringify(_this.timeslots)),_this.timeslot.finished()?(_this.env.log.debug("no timeslots."),resultCallback([{description:"no timeslots."}])):_this.timeslotsExecutor=(ExecutorTypeMap={light_cast:LightCastExecutor,scene_cast:SceneCastExecutor,group_cast:GroupCastExecutor},{Create:function(strategy){for(var _a,args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];return new((_a=ExecutorTypeMap[strategy]).bind.apply(_a,Environment.__spreadArray([void 0],args,!1)))}}).Create(_this.timeslotsSimulationStrategy,_this.env,_this.instanceId,_this.getExecutorLightGetter.bind(_this),_this.getExecutorActionGetter.bind(_this),"middle_states",resultCallback)},overwriteBrightnessInInitialAction=function(){_this.env.log.debug("overwriteBrightness -> strategy: "+_this.initialActions.strategy);var lights,totalNumberOfOnLights,overwriteInitialLightBrightnesses=function(brightness){return _this.lightKeys(!1).forEach((function(lightId){_this.otherLights[lightId].on&&_this.otherLights[lightId].br&&(_this.otherLights[lightId].br[BrightnessProps.Brightness]=brightness)}))};switch(_this.initialActions.strategy){case"average":var bri=(lights=_this.otherLights,totalNumberOfOnLights=Object.keys(lights).reduce((function(total,key){return total+(EffectSimulator.isLightOnAndReachable(lights[key])&&lights[key].br?1:0)}),0),Object.keys(lights).reduce((function(acc,key){return acc+(EffectSimulator.isLightOnAndReachable(lights[key])&&(lights[key].br?lights[key].br[BrightnessProps.Brightness]:0))}),0)/totalNumberOfOnLights);_this.initialActions.normalAction.dimming.brightness=bri,overwriteInitialLightBrightnesses(bri);break;case"minimum":bri=function(lights){return Object.keys(lights).reduce((function(minBrightness,key){return minBrightness>(EffectSimulator.isLightOnAndReachable(lights[key])&&lights[key].br?lights[key].br[BrightnessProps.Brightness]:minBrightness)?lights[key].br[BrightnessProps.Brightness]:minBrightness}),101)}(_this.otherLights);_this.initialActions.normalAction.dimming.brightness=bri,overwriteInitialLightBrightnesses(bri);break;case"individual":_this.initialActions.normalAction.dimming=void 0;break;case"given":overwriteInitialLightBrightnesses(bri=_this.initialActions.normalAction.dimming.brightness)}};this.gatherLights(resultHandler((function(){overwriteBrightnessInInitialAction(),function(resultCallback){_this.initialAndEndStateExecutor=new GroupCastExecutor(_this.env,_this.instanceId,_this.getExecutorLightGetter.bind(_this),_this.getExecutorActionGetter.bind(_this),"initial",resultCallback)}(resultHandler((function(){createTimeslotsExecutor(resultHandler((function(){_this.env.log.debug("afterLightsOffAction: ".concat(JSON.stringify(_this.initialActions.afterLightsOffAction))),_this.env.log.debug("Subscribing to where: "+JSON.stringify(_this.where)),_this.interruptionManager.subscribeToWhere(_this.where,(function(groupId){_this.env.log.debug("group: ".concat(groupId," is updated!")),"idle"===_this.state&&_this.gatherLights((function(){_this.initialAndEndStateExecutor.populateActions("initial",overwriteBrightnessInInitialAction)}))})),resultCallback([])})))})))})))},EffectSimulator.prototype.lightKeys=function(includingEffectCapable){return Object.keys(Environment.__assign(Environment.__assign({},this.otherLights),includingEffectCapable&&this.effectCapableLights))},EffectSimulator.prototype.terminate=function(overriddenRecipes){var _this=this;if("running"===this.state){this.env.log.debug("EffectSimulator is being terminated!"),this.state="terminated";var cancelTimer=function(id){return _this.env.timer.cancelTimer(id)};cancelTimer(this.endStateTimerId),this.initialAndEndStateExecutor.terminate(EffectSimulator.terminationOffset,cancelTimer,overriddenRecipes),this.timeslotsExecutor.terminate(EffectSimulator.terminationOffset,cancelTimer,overriddenRecipes)}},EffectSimulator.prototype.run=function(blendingDurationInSecs,turnOnLightsWhenOff,onComplete){var _a,_b,_this=this,runDone=function(){_this.state="idle",_this.interruptionManager.disable(),_this.initialAndEndStateExecutor.reset(),_this.timeslotsExecutor.reset(),onComplete((function(){return _this.gatherLights((function(){}))}))};this.timeslot.reset(),!this.groupedLightProperty.on&&turnOnLightsWhenOff?(this.updateLightProperties(this.lightKeys(!0),this.initialActions.afterLightsOffAction,"update"),this.selectedInitialAction=utils.clone(this.initialActions.afterLightsOffAction)):(this.selectedInitialAction=Environment.__assign(Environment.__assign(Environment.__assign({},utils.clone(this.initialActions.normalAction)),(null===(_a=this.groupedLightProperty.br)||void 0===_a?void 0:_a.avg)>=EffectSimulator.brightnessLimit&&{dimming_delta:{action:"down",brightness_delta:Math.min(EffectSimulator.brightnessLimit/4,this.groupedLightProperty.br.min-1)}}),(null===(_b=this.groupedLightProperty.br)||void 0===_b?void 0:_b.min)>=EffectSimulator.brightnessLimit&&{dimming_delta:{action:"down",brightness_delta:EffectSimulator.brightnessLimit/2}}),this.selectedInitialAction.dimming_delta&&this.updateLightProperties(this.lightKeys(!0),{dimming_delta:utils.clone(this.selectedInitialAction.dimming_delta)},"update"));var simulateCapable=function(done){_this.env.log.debug("Effect capable lights: "+JSON.stringify(_this.effectCapableLights)),script_environment.ForEachAndFinally(Object.keys(_this.effectCapableLights),(function(lightId,done){"running"===_this.state&&EffectSimulator.isLightOnAndReachable(_this.effectCapableLights[lightId])?_this.env.clipUtils.setLightState({rid:lightId,rtype:"light"},{on:{on:!0},timed_effects:{effect:_this.style,duration:Environment.TimespanUtils.toMilliseconds(_this.fadeDuration)-1e3*_this.initialActions.duration},dynamics:{duration:1e3*_this.initialActions.duration}},(function(errors,_){_this.env.clipUtils.hasErrors(errors)&&_this.env.log.warn("Error while setting"+_this.style+"on light: "+lightId+"error: "+get_error_message.GetErrorMessage(errors)),done()})):done()}),(function(){done()}))},simulateEffectOnNonCapableLights=function(onComplete){var _a,timeslot=_this.timeslot;_this.env.log.debug("simulating timeslot index: ".concat(timeslot.getIndex()," current action: ")+JSON.stringify(timeslot.current().action));var transitionTime={milliseconds:(Environment.TimespanUtils.toMilliseconds(_this.fadeDuration)-1e3*_this.initialActions.duration)*timeslot.current().percentage+(null!==(_a=timeslot.current().offset_millis)&&void 0!==_a?_a:0)||400};timeslot.iterate(),_this.timeslotsExecutor.execute("middle_states",transitionTime,(function(){timeslot.last()?onComplete():simulateEffectOnNonCapableLights(onComplete)}),(function(doNext){timeslot.current().is_group_casted?_this.initialAndEndStateExecutor.populateActions("end_state",doNext):doNext()}))},simulateEffect=function(){var done;!function(onLightsUpdated,done){_this.initialAndEndStateExecutor.execute("initial",{seconds:_this.initialActions.duration},done,(function(){_this.interruptionManager.enable(),null==onLightsUpdated||onLightsUpdated(utils.noop)}))}(simulateCapable,(done=function(){var _a;_this.env.log.debug("EffectSimulator::run done"),"terminated"===_this.state&&(null===(_a=_this.endStateTimerCallback)||void 0===_a||_a.call(_this))},function(){simulateEffectOnNonCapableLights(done)}))},onStopEffect=function(callback){var terminateAndCall=function(){_this.terminate([]),callback()};_this.timeslot.current().is_group_casted?_this.initialAndEndStateExecutor.execute("end_state",{milliseconds:400},terminateAndCall):_this.timeslotsExecutor.execute("end_state",{milliseconds:400},terminateAndCall)},simulateEndState=function(done){var callback;_this.timeslot.current().includeEffectCapableLights||"terminated"===_this.state?(callback=function(){return onStopEffect(done)},script_environment.ForEachAndFinally(Object.keys(_this.effectCapableLights),(function(lightId,done){EffectSimulator.isLightOnAndReachable(_this.effectCapableLights[lightId])&&!_this.interruptionManager.isLightInterrupted(lightId)?_this.env.clipUtils.setLightState({rid:lightId,rtype:"light"},{timed_effects:{effect:"no_effect"}},done):done()}),callback)):onStopEffect(done)};this.initialActions.duration=blendingDurationInSecs,this.env.log.debug("EffectSimulator::run"),this.state="running",function(done){_this.env.log.debug("Simulating initial action");var barrier$1=new barrier.Barrier(2,(function(errors){(null==errors?void 0:errors.length)>0&&_this.env.log.warn("simulating ".concat(_this.style," has errors: ")+JSON.stringify(errors)),done()}));_this.initialAndEndStateExecutor.populateActions("initial",barrier$1.arrive),_this.timeslotsExecutor.populateActions("middle_states",barrier$1.arrive)}((function(){return doNext=simulateEffect,done=runDone,_this.endStateTimerCallback=function(){simulateEndState(done)},_this.endStateTimerId=_this.env.timer.setTimeout((function(){_this.endStateTimerCallback(),_this.endStateTimerCallback=void 0}),_this.fadeDuration),void doNext();var doNext,done}))},EffectSimulator.prototype.getExecutorActionGetter=function(state,lightId){var _this=this;return"initial"===state?(this.env.log.debug("actionGetter: allLightsOff: ".concat(JSON.stringify(this.groupedLightProperty.on)," selected action: ").concat(JSON.stringify(this.selectedInitialAction))),{target:EffectSimulator.EmptyTarget,action:this.selectedInitialAction}):function(lightId,requestedAction){var _a;_this.env.log.debug("getActionForLightId -> id: "+lightId+" action: "+JSON.stringify(requestedAction));var chooseBrightness=function(initialActionForLight,requestedAction){return _this.timeslot.penultimate()||_this.timeslot.last()?_this.effectCapableLights[lightId]||initialActionForLight.dimming.min_dim_level>EffectSimulator.deepDimLightThreshold?requestedAction.dimming.brightness:EffectSimulator.minBrightnessForDimLight:Math.min(initialActionForLight.dimming.brightness,EffectSimulator.brightnessLimit)*(requestedAction.dimming.brightness/100)};if(requestedAction){if(!lightId)return{target:{rtype:"light",rid:lightId},action:requestedAction};var initialActionForLight_1=EffectSimulator.createActionFromLightProperty(null!==(_a=_this.otherLights[lightId])&&void 0!==_a?_a:_this.effectCapableLights[lightId]);if(initialActionForLight_1.color_temperature&&initialActionForLight_1.color&&delete initialActionForLight_1.color_temperature,_this.env.log.debug("initialActionForLight -> "+JSON.stringify(initialActionForLight_1)),(initialActionForLight_1.on.on||_this.timeslot.last())&&!_this.interruptionManager.isLightInterrupted(lightId))return{target:{rtype:"light",rid:lightId},action:Object.keys(requestedAction).reduce((function(acc,key){var _a;return Environment.__assign(Environment.__assign({},acc),initialActionForLight_1[key]&&((_a={})[key]="dimming"===key?{brightness:chooseBrightness(initialActionForLight_1,requestedAction)}:requestedAction[key],_a))}),{})}}}(lightId,this.timeslot.current().action)},EffectSimulator.prototype.getExecutorLightGetter=function(state){var _a,_this=this;if("initial"===state)return this.lightKeys(!1);var allLights=Environment.__assign(Environment.__assign({},this.otherLights),(null===(_a=this.timeslot.current())||void 0===_a?void 0:_a.includeEffectCapableLights)&&this.effectCapableLights);return Object.keys(allLights).filter((function(lightId){return allLights[lightId].rc===Reachability.Reachable&&(allLights[lightId].on||_this.timeslot.last())&&!_this.interruptionManager.isLightInterrupted(lightId)}))},EffectSimulator.prototype.gatherLights=function(resultCallback){var _this=this,lightInterests=[];lightInterests.push();var lightMatcher={filter:function(state){return EffectSimulator.isEffectCapableLight(state,_this.style)},onMatchingResource:function(state){var _a;return _this.effectCapableLights[state.id]=lightInterests.push({lightId:state.id,deviceId:null===(_a=state.owner)||void 0===_a?void 0:_a.rid})&&EffectSimulator.createLightPropertyFromLightAction(state)},onUnmatchingResource:function(state){var _a;return _this.otherLights[state.id]=lightInterests.push({lightId:state.id,deviceId:null===(_a=state.owner)||void 0===_a?void 0:_a.rid})&&EffectSimulator.createLightPropertyFromLightAction(state)}};this.effectCapableLights={},this.otherLights={},this.interruptionManager.resetLightSubscribers((function(){return _this.env.clipUtils.getInterestedLightsStateInWhere(_this.where,lightMatcher,helpers.clipCallbackHandler((function(){_this.env.log.debug("OtherLights: "+JSON.stringify(_this.lightKeys(!1))),_this.env.log.debug("EffectCapableLights: "+JSON.stringify(Object.keys(_this.effectCapableLights))),_this.groupedLightProperty=EffectSimulator.calculateGroupedLightProperty(Environment.__assign(Environment.__assign({},_this.otherLights),_this.effectCapableLights)),_this.env.log.debug("Grouped light Statistics: ".concat(JSON.stringify(_this.groupedLightProperty))),_this.interruptionManager.subscribeToLights(lightInterests,resultCallback,(function(lightIds,data,reason){return _this.lightUpdateHandler(lightIds,data,reason)}))}),resultCallback))}))},Object.defineProperty(EffectSimulator.prototype,"timeslot",{get:function(){var _this=this;return{current:function(){var currentTimeslot=_this.timeslots[_this.currentTimeslotIndex];return void 0===currentTimeslot?(_this.env.log.warn("Index out of bound: ".concat(_this.currentTimeslotIndex," #Timeslots: ").concat(_this.timeslots.length,". Resetting index!")),_this.timeslots[_this.currentTimeslotIndex=0]):currentTimeslot},iterate:function(){return _this.currentTimeslotIndex++},reset:function(){return _this.currentTimeslotIndex=0},getIndex:function(){return _this.currentTimeslotIndex},finished:function(){return _this.currentTimeslotIndex>=_this.timeslots.length},penultimate:function(){return _this.currentTimeslotIndex===_this.timeslots.length-2},last:function(){return _this.currentTimeslotIndex===_this.timeslots.length-1}}},enumerable:!1,configurable:!0}),EffectSimulator.prototype.updateLightProperties=function(ids,data,reason){var _this=this;this.env.log.debug("updateLightProperties -> LightIds: ".concat(JSON.stringify(ids)," Event: ").concat(JSON.stringify(data)," Reason: ").concat(reason)),ids.forEach((function(id){var _a,interestedLights=null!==(_a=_this.otherLights[id]&&_this.otherLights)&&void 0!==_a?_a:_this.effectCapableLights[id]&&_this.effectCapableLights;if(interestedLights){var updatedLightProperty_1=EffectSimulator.createLightPropertyFromLightAction(data),obsoleteLightProperty_1=utils.clone(interestedLights[id]);_this.env.log.debug("Light ".concat(id,": ").concat(JSON.stringify(obsoleteLightProperty_1)," -- updated --\x3e ").concat(JSON.stringify(updatedLightProperty_1))),Object.keys(obsoleteLightProperty_1).forEach((function(key){var _a;return interestedLights[id][key]=null!==(_a=updatedLightProperty_1[key])&&void 0!==_a?_a:obsoleteLightProperty_1[key]})),interestedLights[id].br&&(interestedLights[id].br[BrightnessProps.MinimumBrightness]=obsoleteLightProperty_1.br[BrightnessProps.MinimumBrightness],data.dimming_delta&&(interestedLights[id].br[BrightnessProps.Brightness]+=data.dimming_delta.brightness_delta*("down"===data.dimming_delta.action?-1:"up"===data.dimming_delta.action?1:0))),interestedLights[id].rc=updatedLightProperty_1.rc||obsoleteLightProperty_1.rc,_this.env.log.debug("Light ".concat(id," updated: ").concat(JSON.stringify(interestedLights[id])))}})),this.groupedLightProperty=EffectSimulator.calculateGroupedLightProperty(Environment.__assign(Environment.__assign({},this.otherLights),this.effectCapableLights)),this.env.log.debug("Grouped light Statistics: ".concat(JSON.stringify(this.groupedLightProperty)))},EffectSimulator.prototype.lightUpdateHandler=function(lightIds,data,reason){var allLights,_this=this;switch(this.state){case"idle":this.updateLightProperties(lightIds,data,reason);break;case"running":if("interrupt"===reason){void 0===allLights&&(allLights=utils.clone(Environment.__assign(Environment.__assign({},_this.effectCapableLights),_this.otherLights))),Object.keys(allLights).filter((function(lightId){return EffectSimulator.isLightOnAndReachable(allLights[lightId])})).every((function(lightId){return _this.interruptionManager.isLightInterrupted(lightId)}))?this.terminate([]):this.timeslotsExecutor.populateActions("middle_states")}}},EffectSimulator.EmptyTarget={rid:"",rtype:"light"},EffectSimulator.deepDimLightThreshold=2.5,EffectSimulator.minBrightnessForDimLight=10,EffectSimulator.brightnessLimit=56,EffectSimulator.terminationOffset={milliseconds:400},EffectSimulator.isLightOnAndReachable=function(prop){return prop.on&&prop.rc===Reachability.Reachable},EffectSimulator.createActionFromLightProperty=function(prop){return Object.keys(prop).reduce((function(acc,attr){return Environment.__assign(Environment.__assign({},acc),"br"===attr?{dimming:{brightness:prop[attr][BrightnessProps.Brightness],min_dim_level:prop[attr][BrightnessProps.MinimumBrightness]}}:"ct"===attr?{color_temperature:{mirek:prop[attr]}}:"xy"===attr?{color:{xy:{x:prop[attr][0],y:prop[attr][1]}}}:"on"===attr?{on:{on:prop[attr]}}:null)}),{})},EffectSimulator.createLightPropertyFromLightAction=function(data){var _a,_b,_c,_d,_e,_f;return Environment.__assign(Environment.__assign(Environment.__assign(Environment.__assign(Environment.__assign({},data.on&&{on:data.on.on}),data.dimming&&{br:[data.dimming.brightness,null!==(_a=data.dimming.min_dim_level)&&void 0!==_a?_a:10]}),(null===(_c=null===(_b=data.color)||void 0===_b?void 0:_b.xy)||void 0===_c?void 0:_c.x)&&(null===(_e=null===(_d=data.color)||void 0===_d?void 0:_d.xy)||void 0===_e?void 0:_e.y)&&{xy:[data.color.xy.x,data.color.xy.y]}),(null===(_f=data.color_temperature)||void 0===_f?void 0:_f.mirek)&&{ct:data.color_temperature.mirek}),data.status?{rc:"connected"===data.status?Reachability.Reachable:Reachability.Unreachable}:{rc:Reachability.Undefined})},EffectSimulator.isEffectCapableLight=function(lightState,style){var _a,_b;return lightState.gradient&&(null===(_b=null===(_a=lightState.timed_effects)||void 0===_a?void 0:_a.effect_values)||void 0===_b?void 0:_b.some((function(effect){return style===effect})))},EffectSimulator.calculateGroupedLightProperty=function(lights){var onLightIds=Object.keys(lights).filter((function(id){return EffectSimulator.isLightOnAndReachable(lights[id])})),lightIdsSupportBri=onLightIds.filter((function(id){var _a;return(null===(_a=lights[id].br)||void 0===_a?void 0:_a[BrightnessProps.Brightness])>=0}));return Environment.__assign({on:onLightIds.length>0},lightIdsSupportBri.length>0&&{br:lightIdsSupportBri.reduce((function(br,id){return{avg:(br.avg*lightIdsSupportBri.length+lights[id].br[BrightnessProps.Brightness])/lightIdsSupportBri.length,min:Math.min(br.min,lights[id].br[BrightnessProps.Brightness])}}),{avg:0,min:101})})},EffectSimulator.areAllLightsOff=function(lights){return Object.keys(lights).filter((function(lightId){return lights[lightId].rc===Reachability.Reachable})).every((function(lightId){return!lights[lightId].on}))},EffectSimulator}(),InterruptionManager=function(){function InterruptionManager(env,instanceId){this.env=env,this.instanceId=instanceId,this.active=!1,this.lights=[],this.interruptedLights=[]}return InterruptionManager.prototype.HandleInterruption=function(lightIds,eventData){var _this=this;!Environment.includesAny.apply(void 0,Environment.__spreadArray([this.interruptedLights],lightIds,!1))&&this.active&&(this.env.log.debug("Lights are interrupted: ".concat(JSON.stringify(lightIds))),this.interruptedLights=this.interruptedLights.concat(lightIds),lightIds.forEach((function(lightId){return _this.env.clipUtils.stopEffectOnLight({rtype:"light",rid:lightId},!0)})),this.notify(lightIds,eventData,"interrupt"))},InterruptionManager.prototype.lightUpdateHandler=function(serviceId,data,metadata){var _this=this,eventDescription=InterruptionManager.GetEventDescription(metadata),eventData=(null==data?void 0:data.length)>0&&data[0],interruptedLights=Environment.flatmap(_this.lights,(function(light){return light.interests.filter((function(interest){return Environment.includesAny([interest.lightId,interest.serviceId],serviceId)})).map((function(interest){return interest.lightId}))}));switch(this.env.log.debug("Update event on lights: ".concat(JSON.stringify(interruptedLights))),eventDescription.origin){case"behavior":"behavior_instance"===eventDescription.rtype&&eventDescription.rid!==this.instanceId&&this.HandleInterruption(interruptedLights,eventData);break;case"zigbee":"zigbee_connectivity"===(null==eventData?void 0:eventData.type)&&this.HandleInterruption(interruptedLights,eventData);break;case"clip_v1":case"clip_v2":case"rule":case"homekit":case"matter":case"schedule":this.HandleInterruption(interruptedLights,eventData);break;case"system":case"internal":break;default:this.env.log.warn("Undefined event origin in metadata: "+JSON.stringify(metadata))}this.notify(interruptedLights,eventData,"update")},InterruptionManager.prototype.notify=function(ids,data,reason){this.lights.forEach((function(light){var _a,filteredLightIds=light.interests.map((function(interest){return interest.lightId})).filter((function(lightId){return Environment.includesAny(ids,lightId)}));filteredLightIds&&filteredLightIds.length>0&&(null===(_a=light.handler)||void 0===_a||_a.call(light,filteredLightIds,data,reason))}))},InterruptionManager.prototype.subscribeToLights=function(interests,completed,listener){var _this=this,_lightUpdateHandler=function(serviceId,data,metadata){return _this.lightUpdateHandler(serviceId,data,metadata)},internalInterests=[],internalMetadata={event_origin:"internal"};script_environment.ForEachAndFinally(interests,(function(interest,done){var light={lightId:interest.lightId};_this.env.events.update.subscribe(interest.lightId,_lightUpdateHandler),_this.env.log.debug("Subscribed to light update: lightId: ".concat(interest.lightId)),_this.env.clipUtils.getResource({rtype:"device",rid:interest.deviceId},(function(errors,device){var _a;script_environment.ClipUtils.prototype.hasErrors(errors)||(light.serviceId=null===(_a=Environment.find(device.services,(function(service){return"zigbee_connectivity"===service.rtype})))||void 0===_a?void 0:_a.rid,light.serviceId&&(_this.env.events.update.subscribe(light.serviceId,_lightUpdateHandler),_this.env.log.debug("Subscribed ZBConnectivity serviceId: ".concat(light.serviceId)))),internalInterests.push(light),done()}))}),(function(){_this.lights.push({interests:internalInterests,handler:listener}),script_environment.ForEachAndFinally(internalInterests,(function(interest,done){interest.serviceId&&listener?_this.env.clipUtils.getResource({rid:interest.serviceId,rtype:"zigbee_connectivity"},(function(errors,data){!script_environment.ClipUtils.prototype.hasErrors(errors)&&_lightUpdateHandler(data.id,[data],internalMetadata),done()})):done()}),completed)}))},InterruptionManager.prototype.resetLightSubscribers=function(callback){var _this=this;script_environment.ForEachAndFinally(this.lights,(function(light,done){light.interests.forEach((function(interest){_this.env.log.debug("Unsubscribe LightId: ".concat(interest.lightId," ZB Connectivity serviceId: ").concat(interest.serviceId)),_this.env.events.update.unsubscribe(interest.lightId),_this.env.events.update.unsubscribe(interest.serviceId)})),done()}),(function(){_this.lights=[],_this.interruptedLights=[],callback()}))},InterruptionManager.prototype.enable=function(){this.active=!0,this.interruptedLights=[],this.env.events.update.listenNewEventsFromNow()},InterruptionManager.prototype.disable=function(){this.active=!1,this.interruptedLights=[]},InterruptionManager.prototype.enabled=function(){return this.active},InterruptionManager.prototype.isLightInterrupted=function(lightId){return Environment.includes(this.interruptedLights,lightId)},InterruptionManager.prototype.subscribeToWhere=function(where,callback){var complete,_this=this;complete=function(){script_environment.ForEachAndFinally(where,(function(whereItem,done){_this.env.log.debug("Subscribed Where: id: ".concat(whereItem.group.rid," type: ").concat(whereItem.group.rtype)),_this.env.events.update.subscribe(whereItem.group.rid,callback)&&_this.groups.push(whereItem.group.rid),"bridge_home"===whereItem.group.rtype?_this.env.clipUtils.getResource(whereItem.group,(function(errors,home){script_environment.ClipUtils.prototype.hasErrors(errors)||home.children.filter((function(child){return"room"===child.rtype})).forEach((function(room){_this.env.log.debug("Subscribed Where: id: ".concat(room.rid," type: ").concat(room.rtype)),_this.env.events.update.subscribe(room.rid,callback)&&_this.groups.push(room.rid)})),done()})):done()}),(function(){}))},script_environment.ForEachAndFinally(_this.groups,(function(groupId,done){_this.env.events.update.unsubscribe(groupId),done()}),(function(){_this.groups=[],complete()}))},InterruptionManager.GetEventDescription=function(metadata){return{origin:metadata.event_origin,rtype:metadata.origin_rtype,rid:metadata.origin_rid}},InterruptionManager}(),SunsetStyle=function(_super){function SunsetStyle(context,env,resultCallback){var _this=_super.call(this,context,env,resultCallback)||this;return _this.context=context,_this.env=env,_this}return Environment.__extends(SunsetStyle,_super),SunsetStyle.prototype.init=function(resultCallback){var _this=this,convertEndStateToCustomRecipe=function(endState){var recipeAction,endStateRecipe=GtsRoutine.endStateRecipes[endState];switch(endState){case"turn_off":recipeAction={on:{on:!1}};break;case"nightlight":recipeAction=recipe.Recipe.get(recipe.Recipe.getRecipeId("Nightlight")).action;break;case"minimum_brightness":recipeAction=Environment.__assign(Environment.__assign({},endStateRecipe.first_matching_action[0]),{on:{on:!0}})}return recipeAction};this.env.log.debug("Activated GTS instance sunset style"),this.validateConfig((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)?resultCallback(errors):(_this.config.where.forEach((function(whereItem){var _a;_this.env.dependency.claimCritical(whereItem.group.rid,whereItem.group.rtype),null===(_a=whereItem.items)||void 0===_a||_a.forEach((function(item){return _this.env.dependency.claimCritical(item.rid,item.rtype)}))})),_this.initSimulator(convertEndStateToCustomRecipe,resultCallback))}))},SunsetStyle.prototype.initSimulator=function(convertEndStateToCustomRecipe,resultCallback){this.simulator=new EffectSimulator(this.env,this.context.id,"sunset",this.config.fade_out_duration,this.config.where,new InterruptionManager(this.env,this.context.id),JSON.parse(JSON.stringify(SunsetStyle.blendingAction)),Environment.__spreadArray(Environment.__spreadArray([],SunsetStyle.sunsetActions,!0),[{percentage:0,action:convertEndStateToCustomRecipe(this.config.end_state),is_group_casted:"turn_off"===this.config.end_state,includeEffectCapableLights:"turn_off"!==this.config.end_state}],!1),"light_cast",resultCallback)},SunsetStyle.prototype.validateConfig=function(resultCallback){var _this=this;(function(errors){resultCallback(get_error_message.GetErrorMessage(errors))})(Environment.TimespanUtils.toSeconds(_this.config.fade_out_duration)<GtsRoutine.minimumFadeOutDurationInSecs?[{description:"Configured fade-out duration is too low; minimum fade-out duration for Sunset style is ".concat(GtsRoutine.minimumFadeOutDurationInSecs," seconds.")}]:[])},SunsetStyle.prototype.run=function(scope,start){var _a,_this=this,turnOnLightsWhenOff="manual"===scope,blendingDurationInSecs=null!==(_a=null==start?void 0:start.blending_duration)&&void 0!==_a?_a:SunsetStyle.defaultBlendingDurationInSecs;this.env.log.debug("trigger: sunset GTS -> blendingDurationInSecs: ".concat(blendingDurationInSecs)),this.storeState("started"),this.simulator.run(blendingDurationInSecs,turnOnLightsWhenOff,(function(response){_this.storeState("stopped"),_this.when.isRecurring()||(_this.env.log.debug("Sunset GTS is completed! Not recurring."),_this.disable()),response()}))},SunsetStyle.prototype.terminate=function(){this.simulator.terminate()},SunsetStyle.defaultBlendingDurationInSecs=2,SunsetStyle.blendingAction=Object.freeze({normalAction:{color:{xy:{x:.5056,y:.4141}},color_temperature:{mirek:455},dimming:{brightness:100}},afterLightsOffAction:recipe.Recipe.get(recipe.Recipe.getRecipeId("Relax")).action,strategy:"individual",duration:SunsetStyle.defaultBlendingDurationInSecs}),SunsetStyle.sunsetActions=Object.freeze([{percentage:.25,action:{color:{xy:{x:.5159,y:.4146}},color_temperature:{mirek:455},dimming:{brightness:88},on:{on:!0}}},{percentage:.25,action:{color:{xy:{x:.5378,y:.4111}},color_temperature:{mirek:455},dimming:{brightness:66},on:{on:!0}}},{percentage:.25,action:{color:{xy:{x:.5857,y:.3931}},color_temperature:{mirek:455},dimming:{brightness:36},on:{on:!0}}},{percentage:.25,offset_millis:-2e3,action:{dimming:{brightness:1}}}]),SunsetStyle}(GtsRoutine),BasicStyle=function(_super){function BasicStyle(context,env,resultCallback){var _this=_super.call(this,context,env,resultCallback)||this;return _this.context=context,_this.env=env,_this}return Environment.__extends(BasicStyle,_super),Object.defineProperty(BasicStyle.prototype,"what",{get:function(){var goToSleepRecipe=GtsRoutine.endStateRecipes[this.config.end_state];return new what.What(this.env,this.context.id,this.config.where,goToSleepRecipe)},enumerable:!1,configurable:!0}),BasicStyle.prototype.completeRoutine=function(terminated){var done,_this=this;this.env.log.debug("Basic GTS is completed!"),this.storeState("stopped"),this.activeTimerId=void 0,done=function(){return!_this.when.isRecurring()&&_this.disable()},"turn_off"!==_this.config.end_state||terminated?done():_this.what.turnOffLights(done)},BasicStyle.prototype.init=function(resultCallback){this.env.log.debug("Activated GTS instance basic style"),this.what.init((function(errors){resultCallback(get_error_message.GetErrorMessage(errors))}))},BasicStyle.prototype.run=function(_scope,_start){var _this=this;this.env.log.debug("trigger: basic GTS"),this.storeState("started"),this.what.activateScenesWithInitialStateAndTransition(BasicStyle.startState,this.config.fade_out_duration,(function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&_this.env.log.warn("Activate scenes with initial state and transition: "+get_error_message.GetErrorMessage(errors)),_this.completeRoutine(!1)}),(function(timerId){_this.env.log.debug("Active TimerId: ".concat(timerId)),_this.activeTimerId=timerId}))},BasicStyle.prototype.terminate=function(){var _a,_this=this;"started"===(null===(_a=this.restoreState())||void 0===_a?void 0:_a.gts_state)&&(this.env.log.debug("Basic GTS is terminated!"),this.env.timer.cancelTimer(this.activeTimerId),this.env.clipUtils.getLightsInWhere(this.config.where,(function(errors,lights){script_environment.ClipUtils.prototype.hasErrors(errors)||script_environment.ForEachAndFinally(lights,(function(light,done){_this.env.clipUtils.stopEffectOnLight(light,!1),done()}),(function(){return _this.completeRoutine(!0)}))})))},BasicStyle.startState={dimming:{brightness:50},duration:{seconds:60}},BasicStyle}(GtsRoutine),GoToSleep=function(){function GoToSleep(context,env,resultCallback){this.context=context,this.env=env,this.scheduled=!0,this.init(resultCallback)}return Object.defineProperty(GoToSleep.prototype,"config",{get:function(){return this.context.config},enumerable:!1,configurable:!0}),GoToSleep.prototype.init=function(resultCallback){this.routine="sunset"===this.config.style?function(context,env,resultCallback){return new SunsetStyle(context,env,resultCallback)}(this.context,this.env,resultCallback):function(context,env,resultCallback){return new BasicStyle(context,env,resultCallback)}(this.context,this.env,resultCallback)},GoToSleep.prototype.runIfNotRunning=function(scope,start){var _a;"manual"!==scope&&!this.scheduled||"started"===(null===(_a=this.routine.restoreState())||void 0===_a?void 0:_a.gts_state)||this.routine.run(scope,start)},GoToSleep.prototype.onTimer=function(){return this.env.log.inform("timer triggered at "+(new Date).toString()+" scheduled: "+JSON.stringify(this.scheduled)),this.runIfNotRunning("scheduled",{blending_duration:60}),!0},GoToSleep.prototype.run=function(){this.routine.when.scheduleTimer(Environment.fbind(this.onTimer,this))},GoToSleep.prototype.trigger=function(action){this.env.log.inform("received trigger: "+JSON.stringify(action)),action.start&&this.runIfNotRunning("manual",action.start),action.stop&&this.routine.terminate(),void 0!==action.enabled&&(this.scheduled=action.enabled)},GoToSleep.Environment=script_environment.ScriptEnvironmentWithClipUtils,GoToSleep}();module.exports=GoToSleep;
