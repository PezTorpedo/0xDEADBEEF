"use strict";var Environment=require("./lib-4.js"),what_config=require("./lib-11.js"),private_scene=require("./lib-7.js"),utils=require("./lib-9.js"),accessory=require("./lib-6.js"),INVALID_DAY_SCHEDULE_ERROR=["Configuration with invalid day schedule provided"],getStartTimeFromMotionSensorTimeSlot=function(item){return item.start_time.time},getCurrentSlotByTime=what_config.getCurrentItemByStartTimeFn(getStartTimeFromMotionSensorTimeSlot),getNextSlotByTime=what_config.getNextSlotByTimeFn(getStartTimeFromMotionSensorTimeSlot);var INCOMPLETE_CONFIGURATION=["too few or too many required services found"],NO_MOTION_HOLD_TIME={seconds:10},DIM_FOLLOWED_BY_ALL_OFF_DURATION={seconds:30},hasPrivateSceneAction=function(what){var _a;return"all_off"===what.action||"previous_state"===what.action||(null===(_a=what.recall_single)||void 0===_a?void 0:_a.some(hasPrivateSceneAction))},MotionBehavior=function(){function MotionBehavior(_source,context){this.context=context,this.noMotionTimerIds=[],this.enableLogging=!1,this.servicesEnabledState={motion:!1,temperature:!1,light_level:!1,camera_motion:!1,convenience_area_motion:!1,grouped_motion:!1,grouped_light_level:!1,daylight_sunrise_sunset:!1},this._internalState={state:"armed",event:void 0}}return Object.defineProperty(MotionBehavior.prototype,"speakers",{get:function(){return{}},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"config",{get:function(){return this.context.context.config},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"what",{get:function(){var _a,whats=Environment.flatmap(this.timeslots,(function(slot){return[slot.on_motion,slot.on_no_motion]})).filter(Boolean);return whats.some(hasPrivateSceneAction)&&whats.push({action:"temporarily_dim"}),(_a={}).DEVICE=whats,_a},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"where",{get:function(){var _a,_b;return(_a={}).DEVICE=(null===(_b=this.config.motion)||void 0===_b?void 0:_b.where)||this.config.where,_a},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"when",{get:function(){var _a;return(null===(_a=this.config.motion)||void 0===_a?void 0:_a.when.timeslots[this.currentSlotIndex])||this.config.when.timeslots[this.currentSlotIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"timeslots",{get:function(){var _a;return(null===(_a=this.config.motion)||void 0===_a?void 0:_a.when.timeslots)||this.config.when.timeslots},enumerable:!1,configurable:!0}),MotionBehavior.prototype.isLightLevelWithMotionConfiguration=function(lightLevel){return void 0!==(null==lightLevel?void 0:lightLevel.daylight_sensitivity)},MotionBehavior.prototype.isDaylightConfiguration=function(lightLevel){return void 0!==(null==lightLevel?void 0:lightLevel.daylight)},MotionBehavior.prototype.isDaylightSensitivityConfiguration=function(config){return void 0!==(null==config?void 0:config.daylight_sensitivity)},MotionBehavior.prototype.isDaylightSunriseSunsetConfiguration=function(config){return void 0!==(null==config?void 0:config.sunrise_sunset)},Object.defineProperty(MotionBehavior.prototype,"daylightSensitivity",{get:function(){var _a,_b,_c,_d;return this.isLightLevelWithMotionConfiguration(this.config.light_level)?null===(_a=this.config.light_level)||void 0===_a?void 0:_a.daylight_sensitivity:this.isDaylightConfiguration(this.config.light_level)&&this.isDaylightSensitivityConfiguration(null===(_b=this.config.light_level)||void 0===_b?void 0:_b.daylight)?null===(_c=this.config.light_level)||void 0===_c?void 0:_c.daylight.daylight_sensitivity.settings:null===(_d=this.config.settings)||void 0===_d?void 0:_d.daylight_sensitivity},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"isEnabled",{get:function(){var s=this.servicesEnabledState,cameraRequiredServicesEnabled=s.camera_motion,rfSensingRequiredServicesEnabled=s.convenience_area_motion,groupedMotionRequiredServicesEnabled=s.grouped_motion;return s.motion||cameraRequiredServicesEnabled||rfSensingRequiredServicesEnabled||groupedMotionRequiredServicesEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"allLightsAreOff",{get:function(){return this.context.getWheresByServiceId("DEVICE").every((function(group){var _a,_b;return!(null===(_b=null===(_a=group.state)||void 0===_a?void 0:_a.on)||void 0===_b?void 0:_b.on)}))},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"hasAnyLightChanged",{get:function(){return this.context.getWheresByServiceId("DEVICE").some((function(group){return group.hasLightsChanged()}))},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"lastMotionEvent",{get:function(){return this._internalState.event},set:function(value){this._internalState.event=value,this.StoreInternalState()},enumerable:!1,configurable:!0}),Object.defineProperty(MotionBehavior.prototype,"state",{get:function(){return this._internalState.state},set:function(value){this._internalState.state!==value&&this.enableLogging&&this.context.env.log.inform("state changed from ".concat(this._internalState.state," to ").concat(value)),this._internalState.state=value,this.StoreInternalState()},enumerable:!1,configurable:!0}),MotionBehavior.prototype.init=function(source,callback){var _this=this,validationErrors=this.validateConfig();if(validationErrors.length>0)return callback(validationErrors);var getLightLevelService=function(c){var configLigtLevelServiceRid=function(){if(_this.config.light_level)return _this.isLightLevelWithMotionConfiguration(_this.config.light_level)&&_this.config.light_level.light_level_service?_this.config.light_level.light_level_service:_this.isDaylightConfiguration(_this.config.light_level)&&_this.isDaylightSensitivityConfiguration(_this.config.light_level.daylight)&&_this.config.light_level.daylight.daylight_sensitivity.light_level_service?_this.config.light_level.daylight.daylight_sensitivity.light_level_service:void 0}(),deviceLightLevelServices=source.getServicesByType("light_level","grouped_light_level");configLigtLevelServiceRid?new private_scene.ClipApi(_this.context.env.clip).resource(configLigtLevelServiceRid.rtype).get(configLigtLevelServiceRid.rid,(function(response){deviceLightLevelServices.length>0&&configLigtLevelServiceRid.rid!==deviceLightLevelServices[0].id&&(_this.enableLogging=!0),c([response])}),(function(errors){callback(errors)})):c(deviceLightLevelServices)};!function(c){if(_this.config.motion)new private_scene.ClipApi(_this.context.env.clip).resource(_this.config.motion.motion_service.rtype).get(_this.config.motion.motion_service.rid,(function(response){c([response])}),(function(errors){return callback(errors)}));else{var motionServices=source.getServicesByType("motion","camera_motion","convenience_area_motion","grouped_motion");c(motionServices)}}((function(motionService){if(!motionService)return callback(INCOMPLETE_CONFIGURATION);var initMotionAndTemperatureServices=function(){var temperatureServices=source.getServicesByType("temperature");_this.context.subscribeToUpdateEvents(temperatureServices,Environment.fbind(_this.onToggleEvent,_this)),_this.context.subscribeToUpdateEvents(motionService,Environment.fbind(_this.onMotionEvent,_this)),_this.onToggleEvent(void 0,temperatureServices),_this.onToggleEvent(void 0,motionService),_this.currentSlotIndex=_this.getCurrentSlotIndex(new Date),_this.RestoreInternalState(motionService[0],callback)};if(_this.isDaylightConfiguration(_this.config.light_level)&&_this.isDaylightSunriseSunsetConfiguration(_this.config.light_level.daylight)){var sunrise_sunset=_this.config.light_level.daylight.sunrise_sunset,sunrise_offset=sunrise_sunset.sunrise_offset,sunset_offset=sunrise_sunset.sunset_offset,now=new Date;_this.context.env.timer.setRecurringSunriseAlarmWithOffset(Environment.fbind(_this.handleDark,_this,!1),sunrise_offset),_this.context.env.timer.setRecurringSunsetAlarmWithOffset(Environment.fbind(_this.handleDark,_this,!0),sunset_offset),_this.handleDark(!_this.context.env.geolocation.isDaytime(now,sunrise_offset,sunset_offset)),_this.servicesEnabledState.daylight_sunrise_sunset=!0,initMotionAndTemperatureServices()}else getLightLevelService((function(lightService){_this.context.subscribeToUpdateEvents(lightService,Environment.fbind(_this.onLightLevelEvent,_this)),_this.onLightLevelEvent(void 0,lightService),initMotionAndTemperatureServices()}))}))},MotionBehavior.prototype.RestoreInternalState=function(motionService,callback){var _this=this;this.context.env.storage.retrieveData("last_motion_event",(function(_eventErrors,eventData){_this.context.env.storage.retrieveData("last_motion_state",(function(_stateErrors,stateData){_this._internalState=null==stateData?void 0:stateData[0],_this._internalState||(_this._internalState={state:"armed",event:null==eventData?void 0:eventData[0]},_this.StoreInternalState(!0),_this.context.env.log.debug("New persisted data is stored: ".concat(JSON.stringify(_this._internalState)))),_this.handleRestoredState(motionService),callback()}))}))},MotionBehavior.prototype.StoreInternalState=function(clear){var _a;clear&&(this.context.env.storage.clearKey("last_motion_event"),this.context.env.storage.clearKey("last_motion_state")),this.context.env.storage.store("last_motion_state",{state:this._internalState.state,event:null!==(_a=this._internalState.event)&&void 0!==_a?_a:[]})},MotionBehavior.prototype.onToggleEvent=function(_serviceId,events){var _this=this;events.forEach((function(event){var _a,_b,_c,isServiceEnabled=!1;if("boolean"==typeof event.enabled)isServiceEnabled=event.enabled;else{if("grouped_motion"!==event.type&&"motion"!==event.type||!(null===(_a=event.motion)||void 0===_a?void 0:_a.motion_report))return;isServiceEnabled=!0}_this.servicesEnabledState[event.type]=isServiceEnabled,_this.isEnabled?"motion"!==event.type&&_this.handleMissedEvent():(_this.cancelTimers(),null===(_c=null===(_b=_this.lastAction)||void 0===_b?void 0:_b.cancel)||void 0===_c||_c.call(_b))}))},MotionBehavior.prototype.onLightLevelEvent=function(id,events){var _this=this;this.onToggleEvent(id,events),events.forEach((function(event){var _a,wasDark=_this.isDark,actOnEvent=!1;if(void 0!==event.enabled&&!event.enabled||null===(null===(_a=event.light)||void 0===_a?void 0:_a.light_level_report))void 0!==_this.isDark&&(_this.isDark=void 0,actOnEvent=!0);else{if(void 0===event.light||void 0===event.light.light_level_report)return;var light_level=event.light.light_level_report.light_level;_this.daylightSensitivity?_this.isDark=light_level<_this.daylightSensitivity.dark_threshold:_this.isDark=!0,actOnEvent=!0,_this.enableLogging&&_this.context.env.log.inform("light level triggered: wasDark: ".concat(JSON.stringify(wasDark),", isDark: ").concat(JSON.stringify(_this.isDark),", light_level: ").concat(JSON.stringify(light_level)))}actOnEvent&&_this.lastMotionEvent&&_this.isDark&&!wasDark&&_this.handleMotionEvent(_this.lastMotionEvent[0],new Date(_this.lastMotionEvent[1]))}))},MotionBehavior.prototype.onMotionEvent=function(id,events){var _this=this;this.onToggleEvent(id,events),events.forEach((function(event){var _a;(null===(_a=event.motion)||void 0===_a?void 0:_a.motion_report)&&(event.motion.motion_report.motion?_this.handleMotionEvent("motion"):_this.handleMotionEvent("no_motion"))}))},MotionBehavior.prototype.handleRestoredState=function(initialMotion){var _a;if("armed"!==this.state){var restoredMotionEvent="no_motion";(null===(_a=initialMotion.motion)||void 0===_a?void 0:_a.motion_report)&&(restoredMotionEvent=initialMotion.motion.motion_report.motion?"motion":"no_motion"),this.currentSlotIndex=this.getCurrentSlotIndex(),"no_motion"===restoredMotionEvent?this.handleNoMotion():"switched"!==this.state&&(this.state="switched")}else this.handleMissedEvent()},MotionBehavior.prototype.handleMissedEvent=function(){this.lastMotionEvent&&(this.lastMotionEvent[1]+3e4>=(new Date).getTime()||"no_motion"===this.lastMotionEvent[0]?this.handleMotionEvent(this.lastMotionEvent[0],new Date(this.lastMotionEvent[1])):this.lastMotionEvent=void 0)},MotionBehavior.prototype.handleMotionEvent=function(eventAction,date){var _a,_b;if(void 0===date&&(date=new Date),this.enableLogging&&this.context.env.log.inform("received motion event: event_received=".concat(eventAction,", isEnabled=").concat(this.isEnabled,", state=").concat(this.state,", isDark=").concat(this.isDark,", currentSlotIndex=").concat(this.currentSlotIndex,", newSlotIndex=").concat(this.getCurrentSlotIndex(),", wereAllLightsOffBeforeMotion=").concat(this.wereAllLightsOffBeforeMotion,", areAllLightsOff=").concat(this.allLightsAreOff,", whatDoesSomethingOnMotion=").concat(accessory.whatDoesSomething(null===(_a=this.when)||void 0===_a?void 0:_a.on_motion),", whatDoesSomethingOnNoMotion=").concat(String(accessory.whatDoesSomething(null===(_b=this.when)||void 0===_b?void 0:_b.on_no_motion)))),this.isEnabled||this.cancelTimers(),this.allLightsAreOff&&(this.state="armed"),this.isEnabled&&("motion"!==eventAction||"armed"!==this.state||this.isDark||void 0===this.isDark))if(this.lastMotionEvent=void 0,"motion"===eventAction){this.cancelTimers();var previousSlotIndex=this.currentSlotIndex;this.currentSlotIndex=this.getCurrentSlotIndex(date),accessory.whatDoesSomething(this.when.on_motion)||"dimmed"===this.state?(this.handleMotion(previousSlotIndex),this.lastAction=void 0,this.lastPreviousStateAction=void 0):this.state="switched"}else"armed"!==this.state&&0===this.noMotionTimerIds.length&&this.handleNoMotion();else this.lastMotionEvent=[eventAction,date.getTime()]},MotionBehavior.prototype.handleMotion=function(previousSlotIndex){var _a,_b,_c,_d,_e,_f,_this=this;"armed"===this.state?this.wereAllLightsOffBeforeMotion=this.allLightsAreOff:this.wereAllLightsOffBeforeMotion||(this.wereAllLightsOffBeforeMotion=this.allLightsAreOff);var currentState=this.state;if("switched"!==currentState||previousSlotIndex!==this.currentSlotIndex||this.allLightsAreOff){if(this.state="switched","dimmed"===currentState&&this.currentSlotIndex===previousSlotIndex)return null===(_b=null===(_a=this.lastAction)||void 0===_a?void 0:_a.cancel)||void 0===_b?void 0:_b.call(_a);var scenes=this.context.env.state.get(accessory.PREVIOUS_STATE_SCENE_NAME);(null==scenes?void 0:scenes.length)&&("armed"===currentState||this.allLightsAreOff)?private_scene.barrier(scenes,(function(scene,barrierCallback){scene.updatePrivateScene(barrierCallback)}),(function(){return _this.executeActions(_this.when.on_motion)}),utils.noop):this.executeActions(this.when.on_motion),(null===(_d=null===(_c=this.when.on_motion)||void 0===_c?void 0:_c.recall_single)||void 0===_d?void 0:_d.some((function(item){return"last_on"===item.action})))&&!this.hasAnyLightChanged&&(null===(_f=null===(_e=this.lastPreviousStateAction)||void 0===_e?void 0:_e.cancel)||void 0===_f||_f.call(_e))}},MotionBehavior.prototype.handleNoMotion=function(){var _a,_b,_this=this;if(!(null===(_a=this.when)||void 0===_a?void 0:_a.on_no_motion)&&this.timeslots.length>1)return this.setNoMotionTimeout(Environment.TimespanUtils.getTimeUntilTimePoint(this.getNextTimeSlot().start_time.time),"armed");if((null===(_b=this.when)||void 0===_b?void 0:_b.on_no_motion)&&"armed"!==this.state){var timeout="dimmed"===this.state?{seconds:0}:Environment.TimespanUtils.subtract(this.when.on_no_motion.after,NO_MOTION_HOLD_TIME);"switched"===this.state&&this.when.on_no_motion.recall_single.some((function(item){return _this.actionRequiresDimming(item)}))&&this.setNoMotionTimeout(Environment.TimespanUtils.subtract(timeout,DIM_FOLLOWED_BY_ALL_OFF_DURATION),"dimmed"),this.setNoMotionTimeout(timeout,"armed")}},MotionBehavior.prototype.setNoMotionTimeout=function(timeout,nextState,defaultAction){var _a,_b;void 0===defaultAction&&(defaultAction=[{action:"do_nothing"}]);var action=(null===(_b=null===(_a=this.when)||void 0===_a?void 0:_a.on_no_motion)||void 0===_b?void 0:_b.recall_single)||defaultAction;this.noMotionTimerIds.push(this.context.env.timer.setTimeout(Environment.fbind(this.onNoMotionTimeout,this,action,nextState),timeout))},MotionBehavior.prototype.handleDark=function(isDark){this.isDark=isDark,isDark&&this.lastMotionEvent&&this.handleMotionEvent(this.lastMotionEvent[0],new Date(this.lastMotionEvent[1]))},MotionBehavior.prototype.cancelTimers=function(){var _this=this;this.noMotionTimerIds.forEach((function(timerId){return _this.context.env.timer.cancelTimer(timerId)})),this.noMotionTimerIds=[]},MotionBehavior.prototype.onNoMotionTimeout=function(onNoMotionConfig,nextState){var _this=this;this.state=nextState,"dimmed"===nextState?(onNoMotionConfig=onNoMotionConfig.map((function(item){return{action:_this.actionRequiresDimming(item)?"temporarily_dim":"do_nothing"}})),this.lastAction=this.lastPreviousStateAction=this.executeActions({recall_single:onNoMotionConfig}),this.context.getWheresByServiceId("DEVICE").forEach((function(group){return group.resetLightsChanged()}))):this.lastAction=this.executeActions({recall_single:onNoMotionConfig})},MotionBehavior.prototype.executeActions=function(actionsConfig){if(!this.when.do_not_disturb||this.wereAllLightsOffBeforeMotion)return this.context.executeActions("DEVICE",actionsConfig,[])},MotionBehavior.prototype.getCurrentSlotIndex=function(date){void 0===date&&(date=new Date);var timeslots=this.timeslots;return 1===timeslots.length?0:timeslots.indexOf(getCurrentSlotByTime(timeslots,date))},MotionBehavior.prototype.getNextTimeSlot=function(date){void 0===date&&(date=new Date);var timeslots=this.timeslots;return getNextSlotByTime(timeslots,date)},MotionBehavior.prototype.actionRequiresDimming=function(item){return"all_off"===item.action||"previous_state"===item.action&&this.wereAllLightsOffBeforeMotion||"temporarily_dim"===item.action},MotionBehavior.prototype.validateConfig=function(){var _this=this,validationErrors=[],timeslotsErrors=this.timeslots.length<1?INVALID_DAY_SCHEDULE_ERROR:null;return timeslotsErrors&&validationErrors.push.apply(validationErrors,timeslotsErrors),function(){var lightLevel=_this.config.light_level;if(_this.isDaylightConfiguration(lightLevel)){var daylight=lightLevel.daylight;if(_this.isDaylightSunriseSunsetConfiguration(daylight)){var sunrise_sunset=daylight.sunrise_sunset,sunriseOffset=sunrise_sunset.sunrise_offset,sunsetOffset=sunrise_sunset.sunset_offset,isOffsetValid=function(offset){return Math.abs(Environment.TimespanUtils.toSeconds(offset))<=7200};isOffsetValid(sunriseOffset)||validationErrors.push("sunriseOffset should be within 2 hours (including 2 hours)"),isOffsetValid(sunsetOffset)||validationErrors.push("sunsetOffset should be within 2 hours (including 2 hours)")}}}(),validationErrors},MotionBehavior}();exports.MotionBehavior=MotionBehavior;
