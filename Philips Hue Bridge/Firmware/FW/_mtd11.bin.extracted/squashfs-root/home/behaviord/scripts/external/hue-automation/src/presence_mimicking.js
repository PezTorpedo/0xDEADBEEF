"use strict";var Environment=require("hue-shared/lib-4.js"),script_environment=require("hue-shared/lib-2.js"),recipe=require("hue-shared/lib-5.js"),time_point=require("hue-shared/lib-14.js"),time=require("hue-shared/lib-17.js"),cron_expression=require("hue-shared/lib-15.js"),barrier=require("hue-shared/lib-3.js"),LightMaestroAdapter=function(){function LightMaestroAdapter(){}return LightMaestroAdapter.CreateLightMaestro=function(where,complement){var whereConfig={where:where,option:{filter:"no_filter",invert_selection:null!=complement&&complement}};return new LightMaestroNative(JSON.stringify(whereConfig))},LightMaestroAdapter.Schedule=function(maestro,cron,state,randomization,offset){null==maestro||maestro.schedule(cron_expression.CronExpression.fromTimeWithRecurrence(cron,cron_expression.WEEKDAYS),Environment.TimespanUtils.toSeconds(offset),Environment.TimespanUtils.toSeconds(randomization),JSON.stringify(state))},LightMaestroAdapter.AddAction=function(maestro,lightState){null==maestro||maestro.push(JSON.stringify(lightState))},LightMaestroAdapter.Initialize=function(maestros,doNext){script_environment.ForEachAndFinally(maestros,(function(maestro,done){null==maestro||maestro.init(),done()}),doNext)},LightMaestroAdapter.Execute=function(maestros,doNext){script_environment.ForEachAndFinally(maestros,(function(maestro,done){null==maestro||maestro.execute(),done()}),doNext)},LightMaestroAdapter.InitializeAndExecute=function(maestros,doNext){script_environment.ForEachAndFinally(maestros,(function(maestro,done){null==maestro||maestro.init(),null==maestro||maestro.execute(),done()}),doNext)},LightMaestroAdapter.Cancel=function(maestros,doNext){script_environment.ForEachAndFinally(maestros,(function(maestro,done){null==maestro||maestro.cancel(),done()}),doNext)},LightMaestroAdapter}(),PresenceMimicking=function(){function PresenceMimicking(context,env,resultCallback){var _this=this;this.context=context,this.env=env,this.timerId=void 0,this.state=void 0,this.lightMaestros=[],this.subscribeToSunriseAndSunsetIfConfigured=function(){return"nighttime"===_this.mode&&_this.subscribeToSunriseAndSunset()},this.init(resultCallback)}return PresenceMimicking.getScheduleItem=function(recipeEnum,startAt){return{time:{type:0,time:{hour:startAt,minute:0}},recipe:recipeEnum}},PresenceMimicking.prototype.init=function(resultCallback){var _this=this,archetypeWhereMap={};this.lightMaestros=[];var generateLightMaestros=function(){return script_environment.ForEachAndFinally(Object.keys(archetypeWhereMap),(function(archetype,done){_this.env.log.debug("Creating light maestro for archetype ".concat(archetype));var maestro=LightMaestroAdapter.CreateLightMaestro(archetypeWhereMap[archetype]);(function(archetype){var _a,_b,_c,_d,roomFunctionSchedules=[{roomFunction:1,schedule:[PresenceMimicking.getScheduleItem("7fd2ccc5-5749-4142-b7a5-66405a676f03",9),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",11),PresenceMimicking.getScheduleItem("b90c8900-a6b7-422c-a5d3-e170187dbf8c",13),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",15),PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",18),PresenceMimicking.getScheduleItem("a1f7da49-d181-4328-abea-68c9dc4b5416",21),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",23)]},{roomFunction:4,schedule:[PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",0),PresenceMimicking.getScheduleItem("7fd2ccc5-5749-4142-b7a5-66405a676f03",7),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",9),PresenceMimicking.getScheduleItem("a1f7da49-d181-4328-abea-68c9dc4b5416",22)]},{roomFunction:8,schedule:[PresenceMimicking.getScheduleItem("7fd2ccc5-5749-4142-b7a5-66405a676f03",9),PresenceMimicking.getScheduleItem("b90c8900-a6b7-422c-a5d3-e170187dbf8c",11),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",17)]},{roomFunction:5,schedule:[PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",18),PresenceMimicking.getScheduleItem("a1f7da49-d181-4328-abea-68c9dc4b5416",21),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",23)]},{roomFunction:6,schedule:[PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",8),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",9),PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",17),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",18)]},{roomFunction:2,schedule:[PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",2),PresenceMimicking.getScheduleItem("a1f7da49-d181-4328-abea-68c9dc4b5416",18)]},{roomFunction:7,schedule:[PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",6),PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",8),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",9),PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",17),PresenceMimicking.getScheduleItem("8c74b9ba-6e89-4083-a2a7-b10a1e566fed",18)]},{roomFunction:0,schedule:[PresenceMimicking.getScheduleItem("7fd2ccc5-5749-4142-b7a5-66405a676f03",7),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",9)]},{roomFunction:3,schedule:[PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",0),PresenceMimicking.getScheduleItem("7fd2ccc5-5749-4142-b7a5-66405a676f03",7),PresenceMimicking.getScheduleItem("b90c8900-a6b7-422c-a5d3-e170187dbf8c",11),PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",18),PresenceMimicking.getScheduleItem("a1f7da49-d181-4328-abea-68c9dc4b5416",22)]}],fallbackSchedule=[PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",9),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",10),PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",13),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",14),PresenceMimicking.getScheduleItem("732ff1d9-76a7-4630-aad0-c8acc499bb0b",18),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",19),PresenceMimicking.getScheduleItem("a1f7da49-d181-4328-abea-68c9dc4b5416",22),PresenceMimicking.getScheduleItem("caabcf9c-984b-4a2c-a97a-0ed61a299258",23)],roomFunction=null===(_b=null===(_a=[{roomFunction:0,archetypes:["gym"]},{roomFunction:1,archetypes:["living_room","kitchen","dining"]},{roomFunction:2,archetypes:["garden","terrace","balcony","porch"]},{roomFunction:3,archetypes:["other"]},{roomFunction:4,archetypes:["bedroom","kids_bedroom","bathroom","nursery","guest_room"]},{roomFunction:5,archetypes:["staircase","hallway","tv","computer","recreation","man_cave","music"]},{roomFunction:6,archetypes:["garage","driveway","carport"]},{roomFunction:7,archetypes:["front_door"]},{roomFunction:8,archetypes:["office","reading","studio"]}].filter((function(roomFunction2Archetypes){return roomFunction2Archetypes.archetypes.some((function(at){return archetype===at}))})))||void 0===_a?void 0:_a[0])||void 0===_b?void 0:_b.roomFunction,matchingSchedule=null===(_d=null===(_c=roomFunctionSchedules.filter((function(schedule){return schedule.roomFunction===roomFunction})))||void 0===_c?void 0:_c[0])||void 0===_d?void 0:_d.schedule;return null!=matchingSchedule?matchingSchedule:fallbackSchedule})(archetype).forEach((function(scheduleItem){_this.env.log.debug("Scheduling ".concat(JSON.stringify(scheduleItem.time.time)," for ").concat(JSON.stringify(recipe.Recipe.get(scheduleItem.recipe).action))),LightMaestroAdapter.Schedule(maestro,scheduleItem.time.time,recipe.Recipe.get(scheduleItem.recipe).action,PresenceMimicking.randomization)})),_this.lightMaestros.push(maestro),done()}),(function(){var offCmd={on:{on:!1}};"turn_off"===_this.endStateLightsBehavior&&(_this.env.log.debug("Creating end state light maestro"),_this.endStateLightMaestro=LightMaestroAdapter.CreateLightMaestro(_this.config.where),LightMaestroAdapter.AddAction(_this.endStateLightMaestro,offCmd)),"turn_off"===_this.excludedLightsBehavior&&(_this.env.log.debug("Creating other lights light maestro"),_this.otherLightsMaestro=LightMaestroAdapter.CreateLightMaestro(_this.config.where,!0),LightMaestroAdapter.AddAction(_this.otherLightsMaestro,offCmd))}))};this.initializeState();var barrierCallback,barrier$1=new barrier.Barrier(this.config.where.length,(function(errors){_this.env.clipUtils.hasErrors(errors)||generateLightMaestros(),resultCallback(errors)}));this.config.where.forEach((barrierCallback=barrier$1.arrive,function(item){return _this.env.clipUtils.getResource(item.group,(function(errors,group){var whereItem,_a;_this.env.clipUtils.hasErrors(errors)||(whereItem=item,Environment.__spreadArray([whereItem.group],null!==(_a=whereItem.items)&&void 0!==_a?_a:[],!0).forEach((function(item){return _this.env.dependency.claimCritical(item.rid,item.rtype)})),function(archetype,whereItem){var _a;archetypeWhereMap[archetype]=Environment.__spreadArray(Environment.__spreadArray([],null!==(_a=archetypeWhereMap[archetype])&&void 0!==_a?_a:[],!0),[whereItem],!1)}(group.metadata.archetype,item)),barrierCallback(errors)}))}))},PresenceMimicking.prototype.initializeState=function(){this.env.persistence.isStatePersisted()||this.persistState("stopped",!0)},Object.defineProperty(PresenceMimicking.prototype,"config",{get:function(){return this.context.config},enumerable:!1,configurable:!0}),Object.defineProperty(PresenceMimicking.prototype,"excludedLightsBehavior",{get:function(){return this.config.excluded_lights?this.config.excluded_lights:"turn_off"},enumerable:!1,configurable:!0}),Object.defineProperty(PresenceMimicking.prototype,"endStateLightsBehavior",{get:function(){return this.config.end_state?this.config.end_state:"turn_off"},enumerable:!1,configurable:!0}),Object.defineProperty(PresenceMimicking.prototype,"mode",{get:function(){return this.config.mode&&"nighttime"===this.config.mode&&this.env.geolocation.isConfigured()?"nighttime":"24h"},enumerable:!1,configurable:!0}),PresenceMimicking.prototype.start=function(){var _this=this;this.persistState("started"),PresenceMimicking.ExecuteOrCancel([this.otherLightsMaestro],!0,(function(){var _a,_b;_this.subscribeToSunriseAndSunsetIfConfigured(),PresenceMimicking.ExecuteOrCancel([_this.daytimeLightMaestro],!(null===(_a=_this.isNight)||void 0===_a||_a)),PresenceMimicking.ExecuteOrCancel(Environment.__spreadArray([],_this.lightMaestros,!0),null===(_b=_this.isNight)||void 0===_b||_b),_this.env.log.debug("Presence Mimicking started!")}))},PresenceMimicking.prototype.subscribeToSunriseAndSunset=function(){var _this=this;this.isNight=this.isAtNight(),this.env.log.debug("nighttime mode -> isNight: ".concat(JSON.stringify(this.isNight))),this.daytimeLightMaestro=LightMaestroAdapter.CreateLightMaestro(this.config.where),LightMaestroAdapter.AddAction(this.daytimeLightMaestro,{on:{on:!1}});var onNextSunEvent=function(isAtNight){_this.isNight=isAtNight,PresenceMimicking.ExecuteOrCancel([_this.daytimeLightMaestro],!_this.isNight),PresenceMimicking.ExecuteOrCancel(Environment.__spreadArray([],_this.lightMaestros,!0),_this.isNight)};_this.sunriseTimepoint=new time_point.TimePoint(_this.env,{type:"sunrise"}),_this.sunriseTimepoint.scheduleTimer((function(){return onNextSunEvent(!1)}),PresenceMimicking.randomization,cron_expression.WEEKDAYS),_this.sunsetTimepoint=new time_point.TimePoint(_this.env,{type:"sunset"}),_this.sunsetTimepoint.scheduleTimer((function(){return onNextSunEvent(!0)}),PresenceMimicking.randomization,cron_expression.WEEKDAYS)},PresenceMimicking.prototype.isAtNight=function(){var fromTimeOfDayToSeconds=function(from){return 60*(60*from.hour+from.minute)+(from.second||0)},currentTime=new Date;this.env.log.debug("nighttime mode -> now: ".concat(currentTime.toString()));var sunrise=time.Time.fromDate(this.env.geolocation.getSunrise(currentTime));return function(sunset,sunrise,currentTime){return fromTimeOfDayToSeconds(sunset)<=fromTimeOfDayToSeconds(time.Time.fromDate(currentTime))||fromTimeOfDayToSeconds(time.Time.fromDate(currentTime))<fromTimeOfDayToSeconds(sunrise)}(time.Time.fromDate(this.env.geolocation.getSunset(currentTime)),sunrise,currentTime)},PresenceMimicking.prototype.persistState=function(runningState,force){void 0===force&&(force=!1),force?(this.state={pm_state:runningState},this.env.persistence.storeState(this.state)):this.env.persistence.isStatePersisted()&&(this.state=this.env.persistence.restoreState(),this.state.pm_state=runningState,this.env.persistence.storeState(this.state))},PresenceMimicking.prototype.getPresenceMimickingState=function(){var presenceMimickingState;return this.state?presenceMimickingState=this.state.pm_state:this.env.persistence.isStatePersisted()&&(this.state=this.env.persistence.restoreState(),presenceMimickingState=this.state.pm_state),presenceMimickingState},PresenceMimicking.prototype.run=function(){"started"===this.getPresenceMimickingState()&&this.start()},PresenceMimicking.prototype.cancelTimers=function(){var _a,_b;null===(_a=this.sunsetTimepoint)||void 0===_a||_a.cancelTimer(),this.sunsetTimepoint=void 0,null===(_b=this.sunriseTimepoint)||void 0===_b||_b.cancelTimer(),this.sunriseTimepoint=void 0},PresenceMimicking.prototype.stop=function(callback){var _this=this,cleanUp=function(){return LightMaestroAdapter.Cancel(Environment.__spreadArray(Environment.__spreadArray([],_this.lightMaestros,!0),[_this.otherLightsMaestro,_this.endStateLightMaestro],!1),(function(){_this.cancelTimers(),_this.persistState("stopped"),_this.env.log.debug("Presence Mimicking stopped!"),null==callback||callback()}))};void 0!==callback?cleanUp():PresenceMimicking.ExecuteOrCancel([this.endStateLightMaestro],!0,cleanUp)},PresenceMimicking.prototype.trigger=function(action){switch(this.env.log.debug("received trigger: "+JSON.stringify(action)),Object.getOwnPropertyNames(action)[0]){case"start":"started"!==this.getPresenceMimickingState()&&this.start();break;case"stop":"stopped"!==this.getPresenceMimickingState()&&this.stop();break;case"debug":this.getPresenceMimickingState()}},PresenceMimicking.Environment=script_environment.ScriptEnvironmentWithClipUtils,PresenceMimicking.randomization={hours:0,minutes:16,seconds:0,milliseconds:0},PresenceMimicking.ExecuteOrCancel=function(maestros,executeFlag,callback){executeFlag?LightMaestroAdapter.InitializeAndExecute(maestros,callback):LightMaestroAdapter.Cancel(maestros,callback)},PresenceMimicking}();module.exports=PresenceMimicking;
