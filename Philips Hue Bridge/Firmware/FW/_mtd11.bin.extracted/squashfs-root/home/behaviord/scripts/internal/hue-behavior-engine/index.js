"use strict";var Environment=require("hue-shared/lib-4.js"),CallbackMap=function(){function CallbackMap(uniqueIdGenerator,callbacks){void 0===callbacks&&(callbacks={}),this.uniqueIdGenerator=uniqueIdGenerator,this.callbacks=callbacks}return CallbackMap.prototype.add=function(callback){var id=this.uniqueIdGenerator.generate();return this.callbacks[id]=[callback,void 0],id},CallbackMap.prototype.getJsCallback=function(id){if(this.callbacks.hasOwnProperty(id))return this.callbacks[id][0]},CallbackMap.prototype.getCppTimerId=function(id){if(this.callbacks.hasOwnProperty(id))return this.callbacks[id][1]},CallbackMap.prototype.setCppTimerId=function(id,cppTimerId){this.callbacks.hasOwnProperty(id)&&(this.callbacks[id][1]=cppTimerId)},CallbackMap.prototype.delete=function(id){this.callbacks.hasOwnProperty(id)&&delete this.callbacks[id]},CallbackMap}();function UniqueIdGenerator(){var id=0;return{generate:function(){return(id++).toString()}}}var idGenerator=UniqueIdGenerator(),callbackRegister={},resolveCallback=function(scriptId){var record=callbackRegister[scriptId];record||(record={},callbackRegister[scriptId]=record);var map=new CallbackMap(idGenerator,record);return{register:function(callback){return map.add(callback)},call:function(callbackId,oneShot){for(var args=[],_i=2;_i<arguments.length;_i++)args[_i-2]=arguments[_i];var callback=map.getJsCallback(callbackId);oneShot&&map.delete(callbackId),callback&&(print("fapply(callback, ...args);"),Environment.fapply.apply(void 0,Environment.__spreadArray([callback],args,!1)))},remove:function(callbackId){return map.delete(callbackId)},assignCppTimer:function(jsCallbackId,cppTimerId){return map.setCppTimerId(jsCallbackId,cppTimerId)},getCppTimerId:function(jsCallbackId){return map.getCppTimerId(jsCallbackId)}}},DefaultContext=function(){function DefaultContext(id,retryRequestsInCaseOfConnectionError){this.id=id,this.retryRequestsInCaseOfConnectionError=retryRequestsInCaseOfConnectionError}return Object.defineProperty(DefaultContext.prototype,"config",{get:function(){return JSON.parse(getConfiguration(this.id))},enumerable:!1,configurable:!0}),DefaultContext}(),instances={},handle_add_service_event=function(instanceId,serviceId,serviceData,serviceMetadata){Environment.events.add.handleEvent(instanceId,serviceId,JSON.parse(serviceData),void 0===serviceMetadata?void 0:JSON.parse(serviceMetadata))},get_add_service_event_instance_ids=function(serviceId,currentEventIndex){return Environment.events.add.getInstanceIds(serviceId,currentEventIndex)},handle_update_service_event=function(instanceId,serviceId,serviceData,serviceMetadata){return Environment.events.update.handleEvent(instanceId,serviceId,JSON.parse(serviceData),void 0===serviceMetadata?void 0:JSON.parse(serviceMetadata))},get_update_service_event_instance_ids=function(serviceId,currentEventIndex){return Environment.events.update.getInstanceIds(serviceId,currentEventIndex)},handle_delete_service_event=function(instanceId,serviceId){return Environment.events.delete.handleEvent(instanceId,serviceId)},get_delete_service_event_instance_ids=function(serviceId,currentEventIndex){return Environment.events.delete.getInstanceIds(serviceId,currentEventIndex)},do_callback=function(instanceId,callbackId,callbackParam){resolveCallback(instanceId).call(callbackId,!0,callbackParam)},do_sink_callback=function(instanceId,callbackId,callbackParam){resolveCallback(instanceId).call(callbackId,!1,callbackParam)},handle_timer_event=function(callbackId,instanceId,oneShot,isSuccessful){var _a,_b;isSuccessful?null===(_a=resolveCallback(instanceId))||void 0===_a||_a.call(callbackId,oneShot):null===(_b=resolveCallback(instanceId))||void 0===_b||_b.remove(callbackId)},createInstanceInternal=function(Script,instanceId,callback){var _a,context,env,script,shouldCallback=!1,callbackError="";function createInstance(callback){return script=new(Script.bind.apply(Script,Environment.__spreadArray([void 0],function(callback){return callback?[context,env,callback]:[context,env]}(callback),!1))),instances[instanceId]={context:context,env:env,script:script},script}function doCallback(){var items;script&&shouldCallback&&callback(instances[instanceId],callbackError instanceof Array?(items=callbackError,items.filter((function(item,index){return items.indexOf(item)===index}))).join(", "):callbackError)}context=new DefaultContext(instanceId,!1),env=new(null!==(_a=Script.Environment)&&void 0!==_a?_a:Environment.ScriptEnvironment)(context,resolveCallback),3===Script.length?(createInstance((function(e){shouldCallback=!0,callbackError=e,doCallback()})),doCallback()):(createInstance(),callback(instances[instanceId],""))},deleteInstance=function(instanceId){instances[instanceId]&&(delete instances[instanceId],delete callbackRegister[instanceId],Environment.events.add.unsubscribeAll(instanceId),Environment.events.update.unsubscribeAll(instanceId),Environment.events.delete.unsubscribeAll(instanceId))},install=function(Script,instanceId,enabled_value,callback){createInstanceInternal(Script,instanceId,(function(instance,error){void 0===error&&(error=""),(null==instance?void 0:instance.context)&&(instance.context.retryRequestsInCaseOfConnectionError=!0),void 0!==error&&0!==error.length||(triggerInstanceInternal(instanceId,{enabled:enabled_value}),(null==instance?void 0:instance.script.run)&&instance.env.timer.setTimeout((function(){null==instance||instance.script.run()}),{seconds:0})),callback(error)}))},uninstall=function(instanceId){var _a,instance=instances[instanceId];(null===(_a=null==instance?void 0:instance.script)||void 0===_a?void 0:_a.stop)?instance.script.stop((function(){deleteInstance(instanceId)})):deleteInstance(instanceId)},migrateConfig=function(Script,config){return Script.migrateConfig?JSON.stringify(Script.migrateConfig(JSON.parse(config))):""},triggerInstanceInternal=function(instanceId,json_data,callback){var _a,_b,_c,instance=instances[instanceId];2===(null===(_a=null==instance?void 0:instance.script.trigger)||void 0===_a?void 0:_a.length)?(instance.context.retryRequestsInCaseOfConnectionError=!1,instance.script.trigger(json_data,(function(error){void 0===error&&(error=""),null==callback||callback(error),instance.context.retryRequestsInCaseOfConnectionError=!0}))):1===(null===(_b=null==instance?void 0:instance.script.trigger)||void 0===_b?void 0:_b.length)||0===(null===(_c=null==instance?void 0:instance.script.trigger)||void 0===_c?void 0:_c.length)?(instance.script.trigger(json_data),null==callback||callback("")):instance?null==callback||callback("The instance doesn't support triggers."):null==callback||callback("Instance undefined.")},triggerInstanceAction=function(instanceId,data,callback){triggerInstanceInternal(instanceId,JSON.parse(data),callback)};var index={BehaviorEngine:function(){return{deleteInstance:deleteInstance,install:install,callbackRegister:callbackRegister,instances:instances,uninstall:uninstall,triggerInstanceAction:triggerInstanceAction,handle_add_service_event:handle_add_service_event,handle_delete_service_event:handle_delete_service_event,handle_update_service_event:handle_update_service_event,get_add_service_event_instance_ids:get_add_service_event_instance_ids,get_update_service_event_instance_ids:get_update_service_event_instance_ids,get_delete_service_event_instance_ids:get_delete_service_event_instance_ids,migrateConfig:migrateConfig,do_callback:do_callback,do_sink_callback:do_sink_callback,handle_timer_event:handle_timer_event}},CallbackMap:CallbackMap,UniqueIdGenerator:UniqueIdGenerator};module.exports=index;
