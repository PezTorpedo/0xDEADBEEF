"use strict";var Environment=require("./lib-4.js"),accessory=require("./lib-6.js"),what_config=require("./lib-11.js"),ScopedStorage=function(){function ScopedStorage(env,namespace,defaults){this.env=env,this.namespace=namespace,this.defaults=defaults}return ScopedStorage.prototype.get=function(key,callback,errorCallback){var _this=this;this.env.storage.retrieveData("".concat(this.namespace,":").concat(String(key)),(function(error,data){var _a,_b;if((null==error?void 0:error.length)&&void 0===(null===(_a=_this.defaults)||void 0===_a?void 0:_a[key]))return null==errorCallback?void 0:errorCallback(error);callback(void 0===data?null===(_b=_this.defaults)||void 0===_b?void 0:_b[key]:data[0])}))},ScopedStorage.prototype.set=function(key,data,callback){void 0!==data&&this.env.storage.store("".concat(this.namespace,":").concat(String(key)),data,callback)},ScopedStorage}(),CUSTOM_LONG_PRESS_INTERVAL={milliseconds:1e3},SwitchBehavior=function(){function SwitchBehavior(config,context){this.config=config,this.context=context,this.doLatencyMetadataTransfer=!1,this.latencyMetadataTag="",this.buttonStates={},this.lastButtonConfig={}}return Object.defineProperty(SwitchBehavior.prototype,"buttonMap",{get:function(){return this.context.getConfigurationMap(this.config.buttons)},enumerable:!1,configurable:!0}),Object.defineProperty(SwitchBehavior.prototype,"where",{get:function(){var _this=this;return accessory.objectMap(this.buttonMap,(function(item){var _a;return null!==(_a=item.where)&&void 0!==_a?_a:_this.config.where}))},enumerable:!1,configurable:!0}),Object.defineProperty(SwitchBehavior.prototype,"speakers",{get:function(){var _a;return null!==(_a=accessory.objectMap(this.buttonMap,(function(item){var _a;return null===(_a=item.sound_targets)||void 0===_a?void 0:_a.map((function(s){return s.speaker_service}))})))&&void 0!==_a?_a:{}},enumerable:!1,configurable:!0}),Object.defineProperty(SwitchBehavior.prototype,"what",{get:function(){return accessory.objectMap(this.buttonMap,(function(item){return[item.on_short_release,item.on_long_press,item.on_repeat].filter(Boolean)}))},enumerable:!1,configurable:!0}),SwitchBehavior.prototype.init=function(source,callback){var _this=this,buttonServices=source.getServicesByType("button").concat(source.getServicesByType("bell_button")),serviceIds=Object.keys(this.config.buttons),configuredButtonServices=buttonServices.filter((function(service){return Environment.includes(serviceIds,service.id)}));if(serviceIds.length!==configuredButtonServices.length)return callback("Not all buttons have a matching service");this.context.subscribeToUpdateEvents(configuredButtonServices,this.onButtonEvent.bind(this)),Environment.entries(this.buttonMap).forEach((function(_a){var buttonId=_a[0],buttonConfig=_a[1];return _this.storage.set(buttonId,Environment.__assign(Environment.__assign({},buttonConfig),{where:void 0}))})),buttonServices.forEach((function(_a){var _b,id=_a.id,button=_a.button,buttonState=_this.buttonStates[id]={supportsRepeat:!0,supportsShortRelease:!0};(null==button?void 0:button.repeat_interval)&&(buttonState.repeat_interval=button.repeat_interval),(null===(_b=null==button?void 0:button.event_values)||void 0===_b?void 0:_b.length)&&(buttonState.supportsRepeat=Environment.includes(button.event_values,"repeat"),buttonState.supportsShortRelease=Environment.includes(button.event_values,"short_release"))})),delete this.config,callback()},SwitchBehavior.prototype.enableLatencyMetadataTransferWithTag=function(tag){this.doLatencyMetadataTransfer=!0,this.latencyMetadataTag=tag},Object.defineProperty(SwitchBehavior.prototype,"storage",{get:function(){return new ScopedStorage(this.context.env,"buttons")},enumerable:!1,configurable:!0}),SwitchBehavior.prototype.onButtonEvent=function(serviceId,events,metadata){var _this=this;void 0===metadata&&(metadata=void 0);var config=this.lastButtonConfig[serviceId];if(!config)return this.storage.get(serviceId,(function(config){var _a;_this.lastButtonConfig=((_a={})[serviceId]=config,_a),_this.onButtonEvent(serviceId,events,metadata)}));events.forEach((function(event){var _a;"button"!==event.type&&"bell_button"!==event.type||!(null===(_a=event.button)||void 0===_a?void 0:_a.button_report)||(new Date(event.button.button_report.updated).getTime()+3e4<=(new Date).getTime()?_this.context.env.log.warn("Button event passed hard timeout and will be ignored. <<== It was  ".concat((new Date).getTime()-new Date(event.button.button_report.updated).getTime()," ms ago for service ").concat(serviceId,". Current time: ").concat((new Date).getTime(),", event time: ").concat(new Date(event.button.button_report.updated).getTime()," ==>>")):(_this.handleButtonEventForCustomLongPress(serviceId,event.type,event.button.button_report.event,config),_this.handleButtonEvent(serviceId,event.type,event.button.button_report.event,metadata,config)))}))},SwitchBehavior.prototype.handleButtonEvent=function(serviceId,buttonType,lastEvent,buttonMetaData,config){var _this=this;if(config){var key=function(event){switch(event){case"initial_press":return"on_initial_press";case"repeat":return"on_repeat";case"long_release":return"on_long_press";case"short_release":return"on_short_release"}}(lastEvent),buttonState=this.buttonStates[serviceId];if("initial_press"===lastEvent&&buttonState.hasCalledLongPress&&delete buttonState.hasCalledLongPress,!buttonState.hasCalledLongPress||config.on_repeat&&!Environment.includes(["long_release","short_release"],lastEvent)){var execute=function(what,stateKeyAppendix,buttonEvent,doTransferMetaData){var repeatInterval,dimStep,duration;(void 0===buttonEvent&&(buttonEvent=key),void 0===doTransferMetaData&&(doTransferMetaData=!1),what)&&_this.context.executeActions(serviceId,what,[serviceId,stateKeyAppendix],(void 0===(repeatInterval=buttonState.repeat_interval)||0===repeatInterval?(dimStep=20,duration=1e3):(dimStep=.025*repeatInterval,duration=1.25*repeatInterval),{dim_up:what_config.createDimAction({action:"up",brightness_delta:dimStep},duration),dim_down:what_config.createDimAction({action:"down",brightness_delta:dimStep},duration),dim_alternate:what_config.createDimAlternateAction(dimStep,duration)}),buttonEvent,doTransferMetaData?_this.extractLatencyMetaData(buttonMetaData):{})};"bell_button"!==buttonType||!config.on_short_release||config.on_long_press||config.on_repeat?!config.on_long_press||"repeat"!==lastEvent&&"long_release"!==lastEvent?config.on_repeat&&("repeat"===lastEvent||"initial_press"===lastEvent&&!config.on_short_release)?(execute(config.on_repeat,"on_repeat",buttonState.hasCalledLongPress?"on_repeat":"on_initial_press"),buttonState.hasCalledLongPress=!0):("short_release"===lastEvent&&buttonState.supportsShortRelease||"initial_press"===lastEvent&&!buttonState.supportsShortRelease)&&execute(config.on_short_release,"on_short_release",void 0,this.doLatencyMetadataTransfer):(buttonState.hasCalledLongPress=!0,execute(config.on_long_press,"on_long_press")):"initial_press"===lastEvent&&(this.context.env.log.inform("handling bell button event"),execute(config.on_short_release,"on_short_release",void 0,this.doLatencyMetadataTransfer))}}},SwitchBehavior.prototype.extractLatencyMetaData=function(buttonMetaData){var clipMetaData={};return Object.keys(buttonMetaData).forEach((function(key){var value=buttonMetaData[key];"string"==typeof value&&"latency"===key.substring(0,7)&&(clipMetaData[key]=value)})),clipMetaData.latency_tag=this.latencyMetadataTag,clipMetaData},SwitchBehavior.prototype.handleButtonEventForCustomLongPress=function(serviceId,buttonType,lastEvent,config){var _this=this,buttonState=this.buttonStates[serviceId];!buttonState.supportsRepeat&&buttonState.supportsShortRelease&&(buttonState.timerId&&(this.context.env.timer.cancelTimer(buttonState.timerId),delete buttonState.timerId,delete buttonState.first_repeat_ignored),config.on_long_press&&"initial_press"===lastEvent?buttonState.timerId=this.context.env.timer.setTimeout(this.handleButtonEvent.bind(this,serviceId,buttonType,"repeat",{},config),CUSTOM_LONG_PRESS_INTERVAL):config.on_repeat&&"initial_press"===lastEvent&&(buttonState.first_repeat_ignored=!1,buttonState.timerId=this.context.env.timer.setInterval((function(){_this.buttonStates[serviceId].first_repeat_ignored?_this.handleButtonEvent(serviceId,buttonType,"repeat",{},config):_this.buttonStates[serviceId].first_repeat_ignored=!0}),CUSTOM_LONG_PRESS_INTERVAL)))},SwitchBehavior}(),RotaryGroupStrategy=function(){function RotaryGroupStrategy(whatActions,where,config,lightState,state){this.whatActions=whatActions,this.where=where,this.config=config,this.lightState=lightState,this.state=state}return RotaryGroupStrategy.prototype.execute=function(what,data){this.whatActions.createAndGroupActions([this.where],[],what).execute(data)},RotaryGroupStrategy}(),OnOffStrategy=function(_super){function OnOffStrategy(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(OnOffStrategy,_super),OnOffStrategy.prototype.handle=function(action,dimmingAction,_transition){"up"===dimmingAction&&"start"===action?this.execute(this.config.on_dim_on):"down"===dimmingAction&&this.execute(this.config.on_dim_off)},OnOffStrategy}(RotaryGroupStrategy),dimRecoveryAction={action:"last_on"},dimAction={action:"dim"},DimCapableStrategy=function(_super){function DimCapableStrategy(){return null!==_super&&_super.apply(this,arguments)||this}return Environment.__extends(DimCapableStrategy,_super),DimCapableStrategy.prototype.handle=function(action,dimmingAction,transition){"up"===dimmingAction&&this.isRecoveryApplicable?this.dimOnRecovery():"up"===dimmingAction&&"start"===action&&this.allLightsAreOff?this.dimOnWithTransition(transition):"down"===dimmingAction&&this.allLightsAreLowest?(this.state.dimmedOffAt=Date.now(),this.execute(this.config.on_dim_off)):this.allLightsAreOff||this.dim(dimmingAction,transition)},Object.defineProperty(DimCapableStrategy.prototype,"isRecoveryApplicable",{get:function(){return!!this.state.dimmedOffAt&&Date.now()-this.state.dimmedOffAt<=3e3},enumerable:!1,configurable:!0}),Object.defineProperty(DimCapableStrategy.prototype,"allLightsAreOff",{get:function(){var _a,_b;return!(null===(_b=null===(_a=this.lightState)||void 0===_a?void 0:_a.on)||void 0===_b?void 0:_b.on)},enumerable:!1,configurable:!0}),Object.defineProperty(DimCapableStrategy.prototype,"allLightsAreLowest",{get:function(){var _a,_b,_c,_d;return(null===(_b=null===(_a=this.lightState)||void 0===_a?void 0:_a.on)||void 0===_b?void 0:_b.on)&&(null===(_d=null===(_c=this.lightState)||void 0===_c?void 0:_c.dimming)||void 0===_d?void 0:_d.brightness)<=1},enumerable:!1,configurable:!0}),DimCapableStrategy.prototype.dim=function(action,transition){this.execute(dimAction,{dimming_delta:{action:action,brightness_delta:transition.brightnessDelta},dynamics:{duration:transition.duration},duration:transition.duration})},DimCapableStrategy.prototype.dimOnWithTransition=function(transition){this.execute(this.config.on_dim_on,{dimming:{brightness:transition.brightnessDelta},dynamics:{duration:transition.duration},duration:transition.duration})},DimCapableStrategy.prototype.dimOnRecovery=function(){this.execute(dimRecoveryAction,{dimming:{brightness:1}}),this.state.dimmedOffAt=null},DimCapableStrategy}(RotaryGroupStrategy),constants={a:1575,b:9843,c:-3,d:3999,e:1e4,f:500,g:1e3};var strategy={calculateBrightnessTransitionFromRotation:function(steps){var relativeDimStep=(constants.a*steps+constants.b)/constants.e,time=(constants.c*steps+constants.d+constants.f)/constants.g;return{brightnessDelta:Math.min(100,relativeDimStep),duration:100*Math.floor(time)}},determineDimmingDirectionFrom:function(direction){return"clock_wise"===direction?"up":"down"}},RotaryBehavior=function(){function RotaryBehavior(config,context){this.config=config,this.context=context,this.states={}}return Object.defineProperty(RotaryBehavior.prototype,"rotaryMap",{get:function(){return this.context.getConfigurationMap(this.config.rotaries)},enumerable:!1,configurable:!0}),Object.defineProperty(RotaryBehavior.prototype,"where",{get:function(){var _this=this;return accessory.objectMap(this.rotaryMap,(function(item){var _a;return null!==(_a=item.where)&&void 0!==_a?_a:_this.config.where}))},enumerable:!1,configurable:!0}),Object.defineProperty(RotaryBehavior.prototype,"what",{get:function(){return accessory.objectMap(this.rotaryMap,(function(item){return[item.on_dim_on,item.on_dim_off,item.on_dim,item.on_dim_recovery].filter(Boolean)}))},enumerable:!1,configurable:!0}),Object.defineProperty(RotaryBehavior.prototype,"storage",{get:function(){return new ScopedStorage(this.context.env,"rotaries")},enumerable:!1,configurable:!0}),RotaryBehavior.prototype.init=function(source,callback){var _this=this,rotaryServices=source.getServicesByType("relative_rotary"),serviceIds=Object.keys(this.config.rotaries),configuredServices=rotaryServices.filter((function(service){return Environment.includes(serviceIds,service.id)}));if(serviceIds.length!==configuredServices.length)return callback("Not all rotaries have a matching service");Environment.entries(this.rotaryMap).forEach((function(_a){var serviceId=_a[0],rotaryConfig=_a[1];_this.context.getWheresByServiceId(serviceId).forEach((function(where){_this.states[where.group.rid]={dimmedOffAt:null}})),_this.storage.set(serviceId,Environment.__assign(Environment.__assign({},rotaryConfig),{where:void 0}))})),this.context.subscribeToUpdateEvents(rotaryServices,this.onRotaryEvent.bind(this)),delete this.config,callback()},RotaryBehavior.prototype.onRotaryEvent=function(serviceId,events){var _this=this;events.forEach((function(event){"relative_rotary"===event.type&&event.relative_rotary&&event.relative_rotary.rotary_report&&_this.storage.get(serviceId,(function(config){if(config){var action=event.relative_rotary.rotary_report.action,where=_this.context.getWheresByServiceId(serviceId);if("repeat"===action&&_this.lastEvent){var diff=Date.now()-_this.lastEvent;_this.context.env.log.debug("Rotary event rate: ".concat(1e3/diff," events/second"))}_this.lastEvent=new Date(event.relative_rotary.rotary_report.updated).getTime();var dimmingAction=strategy.determineDimmingDirectionFrom(event.relative_rotary.rotary_report.rotation.direction),transition=strategy.calculateBrightnessTransitionFromRotation(event.relative_rotary.rotary_report.rotation.steps);where.forEach((function(where){return _this.createGroupStrategyForWhere(config,where,_this.states[where.group.rid]).handle(event.relative_rotary.rotary_report.action,dimmingAction,transition)}))}}))}))},RotaryBehavior.prototype.createGroupStrategyForWhere=function(config,where,state){var lightState=where.state,GroupStrategy=OnOffStrategy;return null!==(null==lightState?void 0:lightState.dimming)&&void 0!==(null==lightState?void 0:lightState.dimming)&&(GroupStrategy=DimCapableStrategy),new GroupStrategy(this.context.whatActions,where,config,lightState,state)},Object.defineProperty(RotaryBehavior.prototype,"speakers",{get:function(){return{}},enumerable:!1,configurable:!0}),RotaryBehavior}();exports.RotaryBehavior=RotaryBehavior,exports.SwitchBehavior=SwitchBehavior;
