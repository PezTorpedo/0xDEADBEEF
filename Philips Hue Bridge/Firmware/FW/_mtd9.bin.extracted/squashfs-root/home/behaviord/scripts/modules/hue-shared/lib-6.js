"use strict";var action,Environment=require("./lib-4.js"),helpers=require("./lib-8.js"),private_scene=require("./lib-7.js"),utils=require("./lib-9.js"),get_error_message=require("./lib-1.js"),EmptyAction=function(){function EmptyAction(){}return EmptyAction.prototype.execute=function(_payload){},EmptyAction}(),GroupedLightOffAction=function(){function GroupedLightOffAction(env,where){this.env=env,this.where=where}return GroupedLightOffAction.prototype.execute=function(){var groupedLight=this.where.groupedLight;groupedLight&&this.canExecute()&&this.env.clipUtils.turnOffLight(groupedLight,(function(){}))},GroupedLightOffAction.prototype.canExecute=function(){var _a,_b;return null===(_b=null===(_a=this.where.state)||void 0===_a?void 0:_a.on)||void 0===_b?void 0:_b.on},GroupedLightOffAction}(),supportedFeatures$2=["on","dimming","dynamics","dimming_delta","color","color_temperature"],RecallLastOnAction=function(){function RecallLastOnAction(env,where,defaultState){this.env=env,this.where=where,this.defaultState=defaultState}return RecallLastOnAction.prototype.execute=function(state){void 0===state&&(state=this.defaultState);var groupedLight=this.where.groupedLight;groupedLight&&this.canExecute()&&this.env.clipUtils.setLightState(groupedLight,Environment.__assign(Environment.__assign({},helpers.getSupportedFeatures(supportedFeatures$2,state)),{on:{on:!0}}),(function(){}))},RecallLastOnAction.prototype.canExecute=function(){var _a,_b;return!(null===(_b=null===(_a=this.where.state)||void 0===_a?void 0:_a.on)||void 0===_b?void 0:_b.on)},RecallLastOnAction}(),supportedFeatures$1=["dimming","duration"],RecallSceneAction=function(){function RecallSceneAction(env,what,defaultState){this.env=env,this.what=what,this.defaultState=defaultState}return RecallSceneAction.prototype.execute=function(state,event,metadata){void 0===state&&(state=this.defaultState),this.env.clipUtils.recallScene(this.what.recall,Environment.__assign(Environment.__assign({},helpers.getSupportedFeatures(supportedFeatures$1,state)),{action:"active"}),(function(){}),metadata)},RecallSceneAction.prototype.init=function(callback){var _this=this,initId="init:".concat(this.what.recall.rid);if(this.env.state.get(initId))return callback();this.env.state.set(initId,!0),this.env.clipUtils.getSceneOrSmartScene(this.what.recall,(function(error){if(error){var errorMessage="Failed fetching scene ".concat(_this.what.recall.rid);callback(errorMessage)}else _this.env.dependency.claimCritical(_this.what.recall.rid,_this.what.recall.rtype),callback()}))},RecallSceneAction}(),RecallSmartSceneAction=function(){function RecallSmartSceneAction(env,what){this.env=env,this.what=what}return RecallSmartSceneAction.prototype.execute=function(){this.env.clipUtils.recallSmartScene(this.what.recall,(function(){}))},RecallSmartSceneAction.prototype.init=function(callback){var _this=this,initId="init:".concat(this.what.recall.rid);if(this.env.state.get(initId))return callback();this.env.state.set(initId,!0),this.env.clipUtils.getSceneOrSmartScene(this.what.recall,(function(error){if(error){var errorMessage="Failed fetching smart scene ".concat(_this.what.recall.rid);callback(errorMessage)}else _this.env.dependency.claimCritical(_this.what.recall.rid,_this.what.recall.rtype),callback()}))},RecallSmartSceneAction}(),ErrorAction=function(){function ErrorAction(errorMessage){this.errorMessage=errorMessage}return ErrorAction.prototype.execute=function(){},ErrorAction.prototype.init=function(callback){callback(this.errorMessage)},ErrorAction}(),AllBasicActions=["all_off","last_on","clamp","do_nothing","dim","dim_up","dim_down","toggle","temporarily_dim","previous_state","soft_off_restore_brightness"],supportedFeatures=["dimming","duration"],RecallPrivateSceneAction=function(){function RecallPrivateSceneAction(env,scene){this.env=env,this.scene=scene}return RecallPrivateSceneAction.prototype.execute=function(state){this.scene.hasInitialised&&this.scene.resource&&this.env.clipUtils.recallScene(this.scene.resource,Environment.__assign(Environment.__assign({},helpers.getSupportedFeatures(supportedFeatures,state)),{action:"active"}),(function(){}))},RecallPrivateSceneAction.prototype.init=function(callback){this.scene.hasInitialised?callback():this.scene.init(callback,callback)},RecallPrivateSceneAction}(),createPrivateScene=function(context,stateKey){return context.env.state.get(stateKey,(function(){return new private_scene.PrivateSceneWithPreviousState(context.scriptId,context.env)}))},GroupListener=function(){function GroupListener(where){this.where=where,this._state=[],this.hasChanged=!1}return Object.defineProperty(GroupListener.prototype,"state",{get:function(){var state={},_a=this._state,on=_a[0],brightness=_a[1],signal_values=_a[2];return null!=on&&(state.on={on:on}),null!=brightness&&(state.dimming={brightness:brightness}),null!=signal_values&&(state.signaling={signal_values:signal_values}),state},set:function(state){var _a,_b,_c;this._state=[null===(_a=null==state?void 0:state.on)||void 0===_a?void 0:_a.on,null===(_b=null==state?void 0:state.dimming)||void 0===_b?void 0:_b.brightness,null===(_c=null==state?void 0:state.signaling)||void 0===_c?void 0:_c.signal_values]},enumerable:!1,configurable:!0}),Object.defineProperty(GroupListener.prototype,"group",{get:function(){return this.where.group},enumerable:!1,configurable:!0}),Object.defineProperty(GroupListener.prototype,"groupedLight",{get:function(){return this.groupedLightId?{rid:this.groupedLightId,rtype:"grouped_light"}:void 0},enumerable:!1,configurable:!0}),GroupListener.prototype.hasLightsChanged=function(){return this.hasChanged},GroupListener.prototype.resetLightsChanged=function(){this.hasChanged=!1},GroupListener.prototype.setLightsChanged=function(){this.hasChanged=!0},GroupListener}(),getIdFromResource=function(resource){return resource.rid},fetchAndSubscribe=function(env,resource,onChange,successCallback,errorCallback){void 0===successCallback&&(successCallback=utils.noop),void 0===errorCallback&&(errorCallback=successCallback),new private_scene.ClipApi(env.clip).resource(resource.rtype).get(resource.rid,(function(groupData){onChange(groupData.id,[groupData]),env.events.update.subscribe(resource.rid,onChange),successCallback()}),errorCallback)},recallDoesSomething=function(action){return!!action.action&&("object"==typeof action.action||"do_nothing"!==action.action)},WhereListener=function(){function WhereListener(instanceId,env){this.instanceId=instanceId,this.env=env,this.doLightsSubscription=!1,this.hasStarted=!1,this.listeners=[],this.onGroupChange=this.onGroupChange.bind(this),this.onGroupedLightChange=this.onGroupedLightChange.bind(this)}return WhereListener.prototype.subscribe=function(where){var a,currentIndex=Environment.findIndex(this.listeners.map((function(listener){return listener.where})),(a=where,function(b){return a.items&&b.items?Environment.equalsBy(a.items,b.items,getIdFromResource):!a.items&&!b.items&&a.group.rid===b.group.rid})),listener=this.listeners[currentIndex];return currentIndex<0&&(listener=new GroupListener(where),this.listeners.push(listener)),listener},WhereListener.prototype.start=function(doLightsSubscription,successCallback,errorCallback){var _this=this;this.doLightsSubscription=doLightsSubscription,this.hasStarted?successCallback():(this.hasStarted=!0,this.claimDependencies(),this.createPrivateGroups((function(){return _this.initListeners(successCallback,errorCallback)}),errorCallback))},WhereListener.prototype.claimDependencies=function(){var _this=this;Environment.flatten(this.listeners.map((function(l){var _a;return Environment.__spreadArray([l.where.group],null!==(_a=l.where.items)&&void 0!==_a?_a:[],!0)}))).forEach((function(resource){return _this.env.dependency.claimCritical(resource.rid,resource.rtype)}))},WhereListener.prototype.createPrivateGroups=function(successCallback,errorCallback){var _this=this,privateGroupListeners=this.listeners.filter((function(group){return!!group.where.items}));private_scene.barrier(privateGroupListeners,(function(listener,barrierCallback){_this.env.clipUtils.createPrivateGroup(_this.instanceId,listener.where.items,(function(errors,group){if(errors)return barrierCallback(errors);listener.where={group:group},barrierCallback(void 0)}))}),successCallback,errorCallback)},WhereListener.prototype.initListeners=function(successCallback,errorCallback){var _this=this;private_scene.barrier(this.listeners,(function(listener,barrierCallback){(fetchAndSubscribe(_this.env,listener.group,_this.onGroupChange,barrierCallback),_this.doLightsSubscription)&&ClipUtils2.getLightIdsInGroup(listener.group.rtype,listener.group.rid).forEach((function(light){_this.env.log.debug("Subscribing to light ".concat(light)),_this.env.events.update.subscribe(light,Environment.fbind(_this.onLightChange,_this))}))}),successCallback,errorCallback)},WhereListener.prototype.onLightChange=function(lightId,data,metadata){for(var listener,i=0;i<this.listeners.length;i++)if(!(listener=this.listeners[i]).hasLightsChanged()){var lights=ClipUtils2.getLightIdsInGroup(listener.group.rtype,listener.group.rid);if(Environment.includes(lights,lightId))break}if(listener&&!listener.hasLightsChanged()){void 0===metadata.event_origin||metadata.origin_rid===this.instanceId&&"behavior_instance"===metadata.origin_rtype&&"behavior"===metadata.event_origin||-1!==["zigbee","system"].indexOf(metadata.event_origin)||listener.setLightsChanged()}},WhereListener.prototype.onGroupChange=function(groupId,data){var _this=this;data.forEach((function(groupData){var _a;if(groupData.services){var listener=Environment.find(_this.listeners,(function(listener){return listener.group.rid===groupId}));if(listener){var currentServiceId=null===(_a=Environment.find(groupData.services,(function(service){return"grouped_light"===service.rtype})))||void 0===_a?void 0:_a.rid;listener.groupedLightId!==currentServiceId&&(listener.groupedLightId&&_this.env.events.update.unsubscribe(listener.groupedLightId),listener.groupedLightId=currentServiceId,currentServiceId?fetchAndSubscribe(_this.env,listener.groupedLight,_this.onGroupedLightChange):listener.state={})}}}))},WhereListener.prototype.onGroupedLightChange=function(groupedLightId,data){var listener=Environment.find(this.listeners,(function(listener){return listener.groupedLightId===groupedLightId}));listener&&(listener.state=data.reduce((function(state,delta){return Environment.__assign(Environment.__assign({},state),(obj=delta,["on","dimming","signaling"].reduce((function(delta,prop){return void 0!==obj[prop]&&(delta[prop]=obj[prop]),delta}),{})));var obj}),listener.state))},WhereListener}(),objectMap=function(obj,iterator,map){return void 0===map&&(map={}),Object.keys(obj).reduce((function(map,key){var _a;return Environment.__assign(Environment.__assign({},map),((_a={})[key]=iterator(obj[key],key),_a))}),map)},filterItemsByType=function(){for(var types=[],_i=0;_i<arguments.length;_i++)types[_i]=arguments[_i];return function(item){return Environment.includes(types,item.type)}},WhatGroup=function(){function WhatGroup(actions){this.actions=actions}return WhatGroup.prototype.execute=function(payload){this.actions.forEach((function(handler){return handler.execute(payload)}))},WhatGroup.prototype.init=function(callback){private_scene.barrier(this.actions,(function(handler,barrierCallback){return handler.init?handler.init(barrierCallback):barrierCallback(void 0)}),callback,callback)},WhatGroup.prototype.cancel=function(){this.actions.forEach((function(action){var _a;return null===(_a=action.cancel)||void 0===_a?void 0:_a.call(action)}))},WhatGroup.wrapMultiple=function(handlers){return handlers.length>1?new WhatGroup(handlers):handlers[0]},WhatGroup}(),UNCONFIGURED_ACTION=[new ErrorAction("Missing configuration for action")],WhatActionsFactory=function(){function WhatActionsFactory(env,scriptId,configuration){void 0===configuration&&(configuration={}),this.env=env,this.scriptId=scriptId,this.configuration=configuration}return WhatActionsFactory.prototype.createActions=function(where,speakers,config,stateKey){var _a,_b,_c;if(null==config)return[new ErrorAction("Config without valid actions provided")];if(config.behavior_trigger&&this.configuration.behavior_trigger)return null!==(_a=this.configuration.behavior_trigger(this,config.behavior_trigger))&&void 0!==_a?_a:UNCONFIGURED_ACTION;if(!(null!=speakers&&0!==speakers.length||null!=where&&0!==where.length))return[new ErrorAction("Where has 0 items")];if(config.action&&this.configuration[config.action])return null!==(_b=this.configuration[config.action](this,where,stateKey))&&void 0!==_b?_b:UNCONFIGURED_ACTION;for(var _i=0,configKeys_1=["recall_single","scene_cycle","time_based","recall_single_extended","scene_cycle_extended","time_based_extended","temporarily_dim","soft_off_restore_brightness","previous_state","signal"];_i<configKeys_1.length;_i++){var key=configKeys_1[_i];if(config[key]&&this.configuration[key])return null!==(_c=this.configuration[key](this,config[key],where,speakers,stateKey))&&void 0!==_c?_c:UNCONFIGURED_ACTION}return[new ErrorAction("Config without valid actions provided")]},WhatActionsFactory.prototype.createAndGroupActions=function(where,speakers,config,stateKey){return WhatGroup.wrapMultiple(this.createActions(where,speakers,config,stateKey))},WhatActionsFactory}(),BehaviorContext=function(){function BehaviorContext(env,context,whatActionsConfiguration){this.env=env,this.context=context,this.whatActionsConfiguration=whatActionsConfiguration,this.whereMap={},this.speakersMap={}}return BehaviorContext.prototype.createWhatActions=function(customWhatConfig){return void 0===customWhatConfig&&(customWhatConfig={}),new WhatActionsFactory(this.env,this.context.id,Environment.__assign(Environment.__assign({},this.whatActionsConfiguration),customWhatConfig))},Object.defineProperty(BehaviorContext.prototype,"whatActions",{get:function(){return this.createWhatActions()},enumerable:!1,configurable:!0}),BehaviorContext.prototype.getConfigurationMap=function(map,customBehavior){var _this=this,config=this.context.config;return objectMap(map,(function(path,key){var serviceConfig=_this.env.getConfig(path,config);return(null==customBehavior?void 0:customBehavior[key])?Environment.__assign(Environment.__assign({},serviceConfig),customBehavior[key]):serviceConfig}))},BehaviorContext.prototype.addSpeakersToMap=function(speakersMap){this.speakersMap=Environment.__assign(Environment.__assign({},this.speakersMap),speakersMap)},BehaviorContext.prototype.getSpeakersByServiceId=function(serviceId){return this.speakersMap[serviceId]},BehaviorContext.prototype.addWheresToMap=function(whereMap){this.whereMap=Environment.__assign(Environment.__assign({},this.whereMap),whereMap)},BehaviorContext.prototype.getWheresByServiceId=function(serviceId){return this.whereMap[serviceId]},BehaviorContext.prototype.executeActions=function(serviceId,what,stateKey,customWhatConfig,event,metadata){if(void 0===customWhatConfig&&(customWhatConfig={}),what){this.env.log.debug("BehaviorContext::executeActions: metadata:"+JSON.stringify(metadata));var action=this.createWhatActions(customWhatConfig).createAndGroupActions(this.getWheresByServiceId(serviceId),this.getSpeakersByServiceId(serviceId),what,"state:".concat(stateKey.join(":")));return action.execute(void 0,event,metadata),action}},BehaviorContext.prototype.subscribeToUpdateEvents=function(services,callback){var _this=this;services.forEach((function(service){_this.env.events.update.subscribe(service.id,callback),_this.env.dependency.claimCritical(service.id,service.type)}))},BehaviorContext}(),Accessory=function(){function Accessory(source,env,scriptContext,whatActionsConfiguration,modelIds){this.source=source,this.env=env,this.scriptContext=scriptContext,this.whatActionsConfiguration=whatActionsConfiguration,this.modelIds=modelIds,this.behaviors=[],this.context=new BehaviorContext(this.env,this.scriptContext,this.whatActionsConfiguration)}return Accessory.prototype.validate=function(successCallback,errorCallback){var _a,_b,_c,_d;if(this.modelIds&&!Environment.includes(this.modelIds,null===(_a=this.resourceData.product_data)||void 0===_a?void 0:_a.model_id))return errorCallback(["Expected accessory with one of model ids: [".concat(this.modelIds.join(", "),"], received: ").concat(null===(_b=this.resourceData.product_data)||void 0===_b?void 0:_b.model_id)]);var updateStateData={source_type:this.source.rtype};(null===(_c=this.resourceData.product_data)||void 0===_c?void 0:_c.model_id)&&(updateStateData.model_id=this.resourceData.product_data.model_id),(null===(_d=this.resourceData.device_mode)||void 0===_d?void 0:_d.mode)&&(updateStateData.device_mode=this.resourceData.device_mode.mode),this.env.persistence.updateState(updateStateData),successCallback()},Accessory.prototype.install=function(Behavior,config){var size=this.behaviors.push(new Behavior(config,this.context));return this.behaviors[size-1]},Accessory.prototype.getServicesByType=function(){for(var serviceTypes=[],_i=0;_i<arguments.length;_i++)serviceTypes[_i]=arguments[_i];return this.serviceData.filter(filterItemsByType.apply(void 0,serviceTypes))},Accessory.prototype.getServices=function(successCallback,errorCallback){var _this=this;if(this.resourceData&&this.serviceData)return successCallback(this.resourceData,this.serviceData);new private_scene.ClipApi(this.env.clip).resource(this.source.rtype).get(this.source.rid,(function(responseData){!function(env,services,successCallback,errorCallback){var serviceData=[],api=new private_scene.ClipApi(env.clip);private_scene.barrier(services,(function(service,barrierCallback){api.resource(service.rtype).get(service.rid,(function(item){serviceData.push(item),barrierCallback(void 0)}),barrierCallback)}),(function(){return successCallback(serviceData)}),errorCallback)}(_this.env,responseData.services,(function(serviceData){_this.resourceData=responseData,_this.serviceData=serviceData,successCallback(responseData,serviceData)}),errorCallback)}),errorCallback)},Accessory.prototype.init=function(successCallback,errorCallback){var _this=this,errorLoggerCallback=function(e){e&&_this.env.log.inform("Init failed due to "+JSON.stringify(e)),errorCallback(get_error_message.GetErrorMessage(e,_this.env.log))};this.env.dependency.claimCritical(this.source.rid,this.source.rtype);var whatMap=this.behaviors.reduce((function(map,behavior){return Environment.__assign(Environment.__assign({},map),behavior.what)}),{}),doLightsSubscription=Environment.entries(whatMap).some((function(_a){return _a[0],_a[1].some((function(w){return"temporarily_dim"===w.action}))})),initWhatAndWhere=function(){_this.initWhere(doLightsSubscription,(function(){return _this.initWhat(whatMap,(function(){return _this.initBehaviors(_this.resourceData,successCallback,errorCallback)}),errorLoggerCallback)}),errorLoggerCallback)};return this.getServices((function(){_this.validate?_this.validate(initWhatAndWhere,errorLoggerCallback):initWhatAndWhere()}),errorLoggerCallback),this.behaviors},Accessory.prototype.initWhere=function(doLightsSubscription,successCallback,errorCallback){var _this=this,whereListener=new WhereListener(this.scriptContext.id,this.env);this.behaviors.forEach((function(behavior){_this.context.addWheresToMap(objectMap(behavior.where,(function(where){return null==where?void 0:where.map((function(where){return whereListener.subscribe(where)}))}))),_this.context.addSpeakersToMap(objectMap(behavior.speakers,(function(speakers){return null==speakers?void 0:speakers.map((function(speaker){return speaker}))})))})),whereListener.start(doLightsSubscription,successCallback,errorCallback)},Accessory.prototype.initWhat=function(whatMap,successCallback,errorCallback){var _this=this;private_scene.barrier(Environment.entries(whatMap),(function(_a,barrierCallback){var serviceId=_a[0],what=_a[1];return _this.initActions(serviceId,what,barrierCallback)}),successCallback,errorCallback)},Accessory.prototype.initActions=function(serviceId,what,callback){var _this=this,where=this.context.getWheresByServiceId(serviceId),speakers=this.context.getSpeakersByServiceId(serviceId);private_scene.barrier(what,(function(what,barrierCallback){var actions=_this.context.whatActions.createActions(where,speakers,what);new WhatGroup(actions).init(barrierCallback)}),callback,callback)},Accessory.prototype.initBehaviors=function(data,successCallback,errorCallback){var _this=this;if(!this.behaviors||!this.serviceData)return errorCallback(["failed to initialize behaviors or service data"]);private_scene.barrier(this.behaviors,(function(behavior,barrierCallback){return behavior.init(_this,barrierCallback)}),successCallback,errorCallback)},Accessory}();exports.Accessory=Accessory,exports.ErrorAction=ErrorAction,exports.PREVIOUS_STATE_SCENE_NAME="previous_state",exports.RecallPrivateSceneAction=RecallPrivateSceneAction,exports.WhatGroup=WhatGroup,exports.createEmptyAction=function(_context,where){return where.map((function(){return null!=action?action:action=new EmptyAction}))},exports.createGroupedLightOffAction=function(context,where){return where.map((function(where){return new GroupedLightOffAction(context.env,where)}))},exports.createGroupedPreviousStateAction=function(sceneKey){return function(context,where){var scene=where.reduce((function(scene,where){return scene.add([where.group])}),createPrivateScene(context,sceneKey));return[new RecallPrivateSceneAction(context.env,scene)]}},exports.createLastOnAction=function(context,where){return where.map((function(where){return new RecallLastOnAction(context.env,where)}))},exports.createPreviousStateAction=function(sceneKey){return function(context,where){return where.map((function(where){var scene=createPrivateScene(context,"".concat(sceneKey,":").concat(where.group.rid)).add([where.group]),scenes=context.env.state.get(sceneKey,(function(){return[]}));return Environment.includes(scenes,scene)||scenes.push(scene),new RecallPrivateSceneAction(context.env,scene)}))}},exports.createRecallSceneAction=function(context,what){return new RecallSceneAction(context.env,what)},exports.createRecallSingleAction=function(context,config,where){if(where.length!==config.length)return[new ErrorAction("Where has ".concat(where.length," items, while recall_single has ").concat(config.length," items"))];function createRecallAction(where,what){var _a,factory=null===(_a=context.configuration.recall)||void 0===_a?void 0:_a[what.recall.rtype];return factory?factory(context,what,where):new ErrorAction("Unknown recall what action: ".concat(what.recall.rtype))}var basicActions=Environment.flatmap(AllBasicActions,(function(basicAction){var wheres=where.filter((function(_,index){return config[index].action===basicAction}));return wheres.length?context.createActions(wheres,[],{action:basicAction}):[]})),recallActions=Environment.flatmap(where,(function(where,index){var what=config[index];return"string"==typeof what.action?[]:[createRecallAction(where,what.action)]}));return 0===basicActions.length&&0===recallActions.length?[new ErrorAction("No actions could be created")]:Environment.__spreadArray(Environment.__spreadArray([],basicActions,!0),recallActions,!0)},exports.createRecallSmartSceneAction=function(context,what){return new RecallSmartSceneAction(context.env,what)},exports.filterItemsByType=filterItemsByType,exports.isExecutable=function(action){return!action.canExecute||action.canExecute()},exports.objectMap=objectMap,exports.whatDoesSomething=function(what){var _a,_b;return!!what&&(!!(what.scene_cycle||what.scene_cycle_extended||what.time_based||what.time_based_extended)||(recallDoesSomething(what)||(null===(_a=what.recall_single)||void 0===_a?void 0:_a.some(recallDoesSomething))||(null===(_b=what.recall_single_extended)||void 0===_b?void 0:_b.actions.some(recallDoesSomething))))};
