"use strict";var Environment=require("hue-shared/lib-4.js"),what=require("hue-shared/lib-0.js"),get_error_message=require("hue-shared/lib-1.js"),script_environment=require("hue-shared/lib-2.js"),where=require("hue-shared/lib-16.js"),barrier=require("hue-shared/lib-3.js");require("hue-shared/lib-5.js");var RelativeTimer=function(){function RelativeTimer(env,config){this.env=env,this.config=config}return RelativeTimer.prototype.continue=function(callback,nextTriggerTime){var next=new Date(nextTriggerTime),now=new Date,remainingTimeInMilliSecond=next.getTime()-now.getTime();remainingTimeInMilliSecond>0?this.setTimeout(callback,{milliseconds:remainingTimeInMilliSecond}):callback("next trigger time is in the past error.")},RelativeTimer.prototype.setTimeout=function(callback,timespan){void 0!==this.timerId&&this.env.timer.cancelTimer(this.timerId),this.timerId=this.env.timer.setTimeout(Environment.fbind(this.onTimeout,this,callback),timespan)},RelativeTimer.prototype.onTimeout=function(callback){this.timerId=void 0,Environment.fapply(callback)},RelativeTimer.prototype.start=function(callback){var timeSpanInSeconds=Environment.TimespanUtils.toSeconds(this.config),now=new Date,nextTriggerTime=new Date(now.getTime()+1e3*timeSpanInSeconds);return this.setTimeout(callback,{seconds:timeSpanInSeconds}),nextTriggerTime},RelativeTimer.prototype.stop=function(){void 0!==this.timerId&&this.env.timer.cancelTimer(this.timerId)},RelativeTimer}();function Timer(context,env,callback){this.env=env,this.context=context,this.relativeTimer=new RelativeTimer(env,context.config.duration),this.init(callback)}function onContinueTimeout(error){const state=this.env.persistence.restoreState();state.timer_state="stopped",state.next_trigger_time=void 0,this.env.persistence.storeState(state),error?this.env.log.warn(error):this.onTimerExpire()}function onStartTimeout(){this.storeTimerState("stopped"),this.onTimerExpire()}Object.defineProperty(Timer.prototype,"what",{get:function(){const config=this.context.config;return new what.What(this.env,this.context.id,config.what)}}),Object.defineProperty(Timer.prototype,"where",{get:function(){return new where.Where(this.env,this.context.config.where)}}),Timer.prototype.init=function(callback){const barrier$1=new barrier.Barrier(2,(function(errors){callback(get_error_message.GetErrorMessage(errors))}));this.initializeState(),this.where.claimDependencies(barrier$1.arrive),this.what.init(barrier$1.arrive)},Timer.prototype.storeTimerState=function(timer_state,next_trigger_timer){if(!0===this.env.persistence.isStatePersisted()){const state=this.env.persistence.restoreState();state.timer_state=timer_state,state.next_trigger_time=next_trigger_timer,this.env.persistence.storeState(state)}},Timer.prototype.initializeState=function(){if(!1===this.env.persistence.isStatePersisted()){const state={timer_state:"stopped"};this.env.persistence.storeState(state)}},Timer.prototype.run=function(){if(!0===this.env.persistence.isStatePersisted()){const state=this.env.persistence.restoreState();"started"===state.timer_state&&this.relativeTimer.continue(Environment.fbind(onContinueTimeout,this),state.next_trigger_time)}},Timer.prototype.stop=function(callback){this.storeTimerState("stopped"),callback&&callback()},Timer.prototype.onTimerExpire=function(){const date=new Date;this.env.log.inform("Timer expired at "+date.toISOString()),this.what.activateScenes((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&this.env.log.warn("Activate scenes: "+get_error_message.GetErrorMessage(errors))}))},Timer.prototype.onStartHandler=function(){const next_trigger_timer=this.relativeTimer.start(Environment.fbind(onStartTimeout,this));this.storeTimerState("started",next_trigger_timer.toISOString())},Timer.prototype.onStopHandler=function(){this.relativeTimer.stop(),this.storeTimerState("stopped")},Timer.prototype.trigger=function(action){this.env.log.debug("received trigger: "+JSON.stringify(action)),action.start&&this.onStartHandler(),action.stop&&this.onStopHandler()},Timer.Environment=script_environment.ScriptEnvironmentWithClipUtils,module.exports=Timer;
