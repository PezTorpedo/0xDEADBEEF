"use strict";var when=require("hue-shared/lib-13.js"),Environment=require("hue-shared/lib-4.js"),what=require("hue-shared/lib-0.js"),get_error_message=require("hue-shared/lib-1.js"),script_environment=require("hue-shared/lib-2.js"),barrier=require("hue-shared/lib-3.js"),recipe=require("hue-shared/lib-5.js");require("hue-shared/lib-14.js"),require("hue-shared/lib-15.js");const wakeUpRecipe={action:{color_temperature:{mirek:447},color:{xy:{x:.5018,y:.4152}},dimming:{brightness:100},on:{on:!0}}},sunriseActionStartingSlot=2,actionOn={on:{on:!0}},sunriseInitialAction={color:{on:{on:!0},color:{xy:{x:.1548,y:.1108}},dimming:{brightness:.4}},color_temperature:{on:{on:!0},color_temperature:{mirek:454},dimming:{brightness:.4}},dimming:{on:{on:!0},dimming:{brightness:.4}}},timeslot_relative_times=[.2,.1333,.1333,.2667,.2667],sunriseSceneFadeActions=[{color:{on:{on:!0},color:{xy:{x:.2488,y:.188}},dimming:{brightness:6.3}},color_temperature:{on:{on:!0},color_temperature:{mirek:454},dimming:{brightness:6.3}},dimming:{on:{on:!0},dimming:{brightness:6.3}}},{color:{on:{on:!0},color:{xy:{x:.5267,y:.4133}},dimming:{brightness:13.39}},color_temperature:{on:{on:!0},color_temperature:{mirek:447},dimming:{brightness:13.39}},dimming:{on:{on:!0},dimming:{brightness:13.39}}},{color:{on:{on:!0},color:{xy:{x:.477,y:.4137}},dimming:{brightness:41.34}},color_temperature:{on:{on:!0},color_temperature:{mirek:346},dimming:{brightness:41.34}},dimming:{on:{on:!0},dimming:{brightness:41.34}}},{color:{on:{on:!0},color:{xy:{x:.4532,y:.4089}},dimming:{brightness:100}},color_temperature:{on:{on:!0},color_temperature:{mirek:317},dimming:{brightness:100}},dimming:{on:{on:!0},dimming:{brightness:100}}}],wakeUpStyles={BASIC:"basic",SUNRISE:"sunrise"},wakeUpStates={INIT:"initialized",READY:"ready",RUNNING:"running",INTERRUPTED:"interrupted",TERMINATED:"terminated"};function whatCustomAction(light){const self=this;return self.doSunriseStyle?self.subscribeLightsAndCreateCustomAction(light):(self.checkIsSunriseCapableLight(light),recipe.Recipe.createCustomRecipeAction({action:self.updateActionBrightness(wakeUpRecipe.action)},light))}var emptyRecipe={};function BasicWakeUp(context,env,callback){const config=context.config;this.context=context,this.env=env,this.sunriseEffectCapableLights=[],this.totalLightCount=0,this.doSunriseStyle=config.style===wakeUpStyles.SUNRISE,this.sunriseTimeslot=1,this.wakeUpState=wakeUpStates.INIT,this.scheduled=!0,this.sunriseTimeslotCount=sunriseSceneFadeActions.length+sunriseActionStartingSlot-1,this.onLightManualControl=Environment.fbind(onLightManualControl,this),this.onGroupChanged=Environment.fbind(onGroupChanged,this),this.init(callback)}function onGroupChanged(id,data,metadata){this.OnGroupUpdateHandler(id,id,data,metadata)}function onLightManualControl(id,data,metadata){this.manualControlOnLightsHandler(id,id,data,metadata)}function onPerformSunriseTimeslot(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&this.env.log.warn("Error performing sunrise routine: "+get_error_message.GetErrorMessage(errors)),1===this.sunriseTimeslot&&this.logLightCount(),this.sunriseTimeslot++,this.performSunriseRoutine()}function basicActivateScenesWithTransition(activationCallback,secondBetweenActivations){this.sunriseTimeslot++,this.what.basicActivateScenesWithTransition({seconds:this.getTimeslotSeconds()-secondBetweenActivations},activationCallback)}function performWakeUpRoutine(){return this.env.log.inform("timer triggered at "+(new Date).toString()+" scheduled: "+JSON.stringify(this.scheduled)),this.scheduled&&this.performWakeUpRoutine(),!0}Object.defineProperty(BasicWakeUp.prototype,"when",{get:function(){return new when.When(this.env,this.context.config.when)}}),Object.defineProperty(BasicWakeUp.prototype,"what",{get:function(){return this._what||new what.What(this.env,this.context.id,this.context.config.where,emptyRecipe,void 0,whatCustomAction.bind(this))}}),BasicWakeUp.prototype.validateConfig=function(callback){const self=this;var errors=[];self.doSunriseStyle&&self.context.config.fade_in_duration.seconds<300&&errors.push({description:"Configured fade-in duration is too low; minimum fade-in duration for Sunrise style is 300 seconds."}),callback(errors)},BasicWakeUp.prototype.init=function(callback){const self=this,barrier$1=new barrier.Barrier(2,(function(errors){const error=get_error_message.GetErrorMessage(errors);error||self.subscribeToGroupEvents(),callback(error)}));self.validateConfig(barrier$1.arrive),self.what.init(barrier$1.arrive)},BasicWakeUp.prototype.subscribeToGroupEvents=function(){const self=this;self.context.config.where.forEach((function(whereCfgItem){whereCfgItem.items||(self.env.log.debug("subscribe to group updates on group["+whereCfgItem.group.rid+"]"),self.env.events.update.subscribe(whereCfgItem.group.rid,self.onGroupChanged))}))},BasicWakeUp.isLightSunriseCapable=function(light){return light.timed_effects&&light.timed_effects.effect_values&&light.timed_effects.effect_values.indexOf("sunrise")>-1},BasicWakeUp.prototype.subscribeLightsAndCreateCustomAction=function(light){const self=this;if(self.wakeUpState!==wakeUpStates.INTERRUPTED){if(self.wakeUpState===wakeUpStates.READY){if(light.on.on&&(!light.dimming||light.dimming.brightness>.4))return self.env.log.debug("subscribeLightsAndCreateCustomAction: sunriseTimeslot: "+self.sunriseTimeslot),self.env.log.debug("Light["+light.id+"] -> Pre-bright before wakeup.."),self.what.addExcludedLight({rid:light.id,rtype:"light"}),void self.getUpdateServiceReferences(light,(function(resourceRefs){resourceRefs.forEach((function(resourceRef){self.env.events.update.unsubscribe(resourceRef.rid),self.env.log.debug("BasicWakeUp::Unsubscribed from "+resourceRef.rtype+" event ["+resourceRef.rid+"]")}))}));self.getUpdateServiceReferences(light,(function(resourceRefs){resourceRefs.forEach((function(resourceRef){self.env.events.update.subscribe(resourceRef.rid,self.onLightManualControl),self.env.log.debug("BasicWakeUp::Subscribed to "+resourceRef.rtype+" event ["+resourceRef.rid+"]")}))}))}return self.createSunriseAction(light)}self.stopLightActivation(light)},BasicWakeUp.prototype.getUpdateServiceReferences=function(light,resourceRefsCallback){const self=this;var resourceRefs=[],deviceForLight=void 0;light.hasOwnProperty("owner")&&"device"===light.owner.rtype&&(deviceForLight=light.owner),resourceRefs.push({rid:light.id,rtype:light.type}),function(deviceForLight,zigbeeServiceCallback){deviceForLight?self.env.clipUtils.getResource(deviceForLight,(function(errors,data){if(script_environment.ClipUtils.prototype.hasErrors(errors))self.env.log.warn("Unable to get device response: "+JSON.stringify(errors)),zigbeeServiceCallback();else{const zigbee_service=data.services.filter((function(service){return"zigbee_connectivity"===service.rtype}))[0];zigbee_service?zigbeeServiceCallback(zigbee_service):zigbeeServiceCallback()}})):zigbeeServiceCallback()}(deviceForLight,(function(zigbeeServiceRef){zigbeeServiceRef&&resourceRefs.push(zigbeeServiceRef),resourceRefsCallback(resourceRefs)}))},BasicWakeUp.prototype.disable=function(){const self=this;self.env.clipUtils.disableInstance(self.context.id,(function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&self.env.log.warn("Error while disabling instance: "+get_error_message.GetErrorMessage(errors))}))},BasicWakeUp.prototype.stopLightActivation=function(light){const putLightRef={rid:light.id,rtype:light.type};var putLightData={};BasicWakeUp.isLightSunriseCapable(light)?putLightData.timed_effects={effect:"no_effect"}:(light.hasOwnProperty("color")&&(putLightData.color={xy:light.color.xy}),light.hasOwnProperty("color_temperature")&&light.color_temperature.mirek_valid&&(putLightData.color_temperature={mirek:light.color_temperature.mirek}),light.hasOwnProperty("dimming")&&(putLightData.dimming={brightness:light.dimming.brightness})),light.on&&1==light.on.on&&(putLightData.on=light.on),this.env.clipUtils.setLightState(putLightRef,putLightData,(function(){})),this.what.addExcludedLight(putLightRef)},BasicWakeUp.prototype.logEventHandlerArgs=function(id,service_id,data,metadata,user_string){this.env.log.debug(user_string),this.env.log.debug("id         = "+id),this.env.log.debug("service_id = "+service_id),this.env.log.debug("data       = "+JSON.stringify(data)),this.env.log.debug("metadata   = "+JSON.stringify(metadata))},BasicWakeUp.prototype.OnGroupUpdateHandler=function(id,service_id,data,metadata){const self=this;self.logEventHandlerArgs(id,service_id,data,metadata,"Group updated event"),self.wakeUpState!==wakeUpStates.RUNNING&&self.what.updateCurrentPrivateScene((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&self.env.log.warn("OnGroupUpdateHandler: updateCurrentPrivateScene "+get_error_message.GetErrorMessage(errors))}))},BasicWakeUp.prototype.filterManualControls=function(id,service_id,data,metadata){var filtered=!1;const response=data[0];var event_origin=metadata.event_origin;return"zigbee"===event_origin?response.hasOwnProperty("type")&&"zigbee_connectivity"===response.type&&(filtered=!0):"behavior"===event_origin&&metadata.origin_rid!==this.context.id?filtered=!0:"clip_v2"!==event_origin&&"rule"!==event_origin||(filtered=!0),filtered},BasicWakeUp.prototype.manualControlOnLightsHandler=function(id,service_id,data,metadata){const self=this,lightRef={rid:id,rtype:"light"};self.wakeUpState===wakeUpStates.RUNNING&&!self.what.isLightExcluded(lightRef)&&self.filterManualControls(id,service_id,data,metadata)&&(self.wakeUpState=wakeUpStates.INTERRUPTED,self.what.updateCurrentPrivateScene((function(){self.disableIfNotRecurring(),self.env.log.debug("The sunrise wake-up automation is disabled!!")})))},BasicWakeUp.prototype.updateActionBrightness=function(action){const config=this.context.config,brightness_coefficient=null==config.end_brightness||isNaN(config.end_brightness)?1:config.end_brightness/100;var updatedAction=JSON.parse(JSON.stringify(action));return action&&action.dimming&&action.dimming.brightness&&(updatedAction.dimming.brightness*=brightness_coefficient),updatedAction},BasicWakeUp.prototype.checkIsSunriseCapableLight=function(light){const self=this;return self.totalLightCount++,!!BasicWakeUp.isLightSunriseCapable(light)&&(self.env.log.debug("createSunriseAction: filtered out light "+light.id),self.sunriseEffectCapableLights.push({rid:light.id,rtype:light.type}),!0)},BasicWakeUp.prototype.createSunriseAction=function(light){const self=this;if(!self.checkIsSunriseCapableLight(light)){var actionDict=sunriseInitialAction;self.sunriseTimeslot>=sunriseActionStartingSlot&&(actionDict=sunriseSceneFadeActions[self.sunriseTimeslot-sunriseActionStartingSlot]);var lightReference={rid:light.id,rtype:light.type};return light.hasOwnProperty("color")?{action:self.updateActionBrightness(actionDict.color),target:lightReference}:light.hasOwnProperty("color_temperature")?{action:self.updateActionBrightness(actionDict.color_temperature),target:lightReference}:light.hasOwnProperty("dimming")?{action:self.updateActionBrightness(actionDict.dimming),target:lightReference}:{action:actionOn,target:lightReference}}},BasicWakeUp.prototype.turnOffLightsAndDisable=function(){const self=this;self.turnOffLightsIfNeeded((function(){self.disableIfNotRecurring(),self._what=null}))},BasicWakeUp.prototype.disableIfNotRecurring=function(){const self=this;self.what.clearExcludedLights(),self.env.log.debug("disableIfNotRecurring --\x3e Called!!"),self.when.isRecurring()?self.wakeUpState!==wakeUpStates.INTERRUPTED&&(self.wakeUpState=wakeUpStates.INIT,self.sunriseTimeslot=1,self.what.updateCurrentPrivateScene((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&self.env.log.warn("disableIfNotRecurring: updateCurrentPrivateScene "+get_error_message.GetErrorMessage(errors))}))):(self.wakeUpState=wakeUpStates.TERMINATED,self.sunriseTimeslot=1,self.disable(),self.what.updatePrivateResourcesData())},BasicWakeUp.prototype.turnOffLightsIfNeeded=function(callback){const self=this;if(self.context.config.turn_lights_off_after){const timeout=Environment.TimespanUtils.toSeconds(self.context.config.turn_lights_off_after);self.env.timer.setTimeout(Environment.fbind(self.what.turnOffLights,self.what,callback),{seconds:timeout})}else callback()},BasicWakeUp.prototype.performBasicRoutine=function(){const self=this;self.what.activateScenesWithTransition(self.context.config.fade_in_duration,(function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)?self.env.log.warn("Trigger wake up routine: "+get_error_message.GetErrorMessage(errors)):(self.logLightCount(),self.turnOffLightsAndDisable())}))},BasicWakeUp.prototype.getTimeslotSeconds=function(){return Math.round(this.context.config.fade_in_duration.seconds*timeslot_relative_times[this.sunriseTimeslot-1])},BasicWakeUp.prototype.performSunriseRoutine=function(){this.wakeUpState!==wakeUpStates.INTERRUPTED?this.sunriseTimeslot<=this.sunriseTimeslotCount?this.performSunriseTimeslot(Environment.fbind(onPerformSunriseTimeslot,this)):(this.env.log.debug("Sunrise WakeUp FINISHED!!"),this.turnOffLightsAndDisable()):this.sunriseTimeslot=this.sunriseTimeslotCount},BasicWakeUp.prototype.performSunriseTimeslot=function(boundCallback){const self=this,logIfErrors=function(errors){if(script_environment.ClipUtils.prototype.hasErrors(errors)){const errorMsg=get_error_message.GetErrorMessage(errors);errorMsg.length>0&&self.env.log.warn("Error performing sunrise routine: "+errorMsg)}},activateSunriseEffect=function(){self.wakeUpState=wakeUpStates.RUNNING,script_environment.ForEachAndFinally(self.sunriseEffectCapableLights,(function(light,done){self.env.clipUtils.setLightState(light,self.updateActionBrightness({timed_effects:{effect:"sunrise",duration:1e3*self.context.config.fade_in_duration.seconds},dimming:{brightness:100},on:{on:!0}}),(function(errors){logIfErrors(errors),done()}))}),(function(){self.totalLightCount===self.sunriseEffectCapableLights.length?self.env.timer.setTimeout((function(){self.turnOffLightsAndDisable()}),{seconds:self.context.config.fade_in_duration.seconds}):self.env.timer.setTimeout(boundCallback,{seconds:self.getTimeslotSeconds()}),self.env.events.update.listenNewEventsFromNow()}))},activationCallback=function(errors){logIfErrors(errors),script_environment.ClipUtils.prototype.hasErrors(errors)&&self.wakeUpState!==wakeUpStates.INTERRUPTED?self.env.timer.setTimeout(boundCallback,{seconds:self.getTimeslotSeconds()}):Environment.fapply(boundCallback)};if(1==self.sunriseTimeslot)self.what.updateCurrentPrivateScene(activateSunriseEffect);else if(self.sunriseTimeslot==sunriseActionStartingSlot){const secondBetweenActivations=10;self.sunriseTimeslot--,self.what.activateScenes((function(errors){self.env.log.debug("activateScenes::initialAction ---\x3e COMPLETED!!"),logIfErrors(errors),self.env.timer.setTimeout(Environment.fbind(basicActivateScenesWithTransition,self,activationCallback,secondBetweenActivations),{seconds:secondBetweenActivations})}))}else self.what.basicActivateScenesWithTransition({seconds:self.getTimeslotSeconds()},activationCallback)},BasicWakeUp.prototype.logLightCount=function(){this.env.log.inform("style: "+this.context.config.style+", secl count: "+this.sunriseEffectCapableLights.length.toString()+", total count: "+this.totalLightCount.toString())},BasicWakeUp.prototype.performWakeUpRoutine=function(){const self=this;self._what=self.what,self.what.getPrivateResourcesData((function(){self.what.clearExcludedLights(),self.wakeUpState=wakeUpStates.READY,self.totalLightCount=0,self.sunriseEffectCapableLights=[],self.doSunriseStyle?(self.sunriseTimeslot=1,self.performSunriseRoutine()):self.performBasicRoutine()}))},BasicWakeUp.prototype.run=function(){this.when.scheduleTimerWithOffset(this.context.config.fade_in_duration,performWakeUpRoutine.bind(this))},BasicWakeUp.prototype.trigger=function(action){const self=this;self.env.log.inform("received trigger: "+JSON.stringify(action)),action.start&&self.performWakeUpRoutine(),void 0!==action.enabled&&(self.scheduled=action.enabled)},BasicWakeUp.migrateConfig=function(config){var newConfiguration=config;return newConfiguration.style||(newConfiguration.style=wakeUpStyles.BASIC),newConfiguration},BasicWakeUp.Environment=script_environment.ScriptEnvironmentWithClipUtils,module.exports=BasicWakeUp;
