"use strict";var Environment=require("hue-shared/lib-4.js"),what=require("hue-shared/lib-0.js"),get_error_message=require("hue-shared/lib-1.js"),script_environment=require("hue-shared/lib-2.js"),barrier=require("hue-shared/lib-3.js"),time=require("hue-shared/lib-17.js"),where=require("hue-shared/lib-16.js");require("hue-shared/lib-5.js");var WhenConstrained=function(){function WhenConstrained(env,config){this.env=env,this.config=config}return WhenConstrained.prototype.validateConfig=function(callback){var errors=[];"nighttime"!==this.config.type||this.env.geolocation.isConfigured()||errors.push({description:"geolocation not configured"}),callback(errors)},WhenConstrained.prototype.isFulfilledWithDate=function(date){if("between"===this.config.type){if(function(date,startTime,endTime){var now=date.valueOf(),start=time.Time.todayAtTime(startTime).valueOf(),end=time.Time.todayAtTime(endTime).valueOf();return function(start,end){return start<end}(start,end)?function(now,start,end){return now>start&&now<end}(now,start,end):function(now,start,end){return now<start&&now>end}(now,start,end)}(date,this.config.start,this.config.end))return!0}else{if("nighttime"!==this.config.type)return!0;if(!this.env.geolocation.isDaytime())return!0}return!1},WhenConstrained.prototype.isFulfilled=function(){var date=new Date;return date.setTime(Date.now()),this.isFulfilledWithDate(date)},WhenConstrained}();function ComingHome(context,env,callback){this.env=env,this.context=context,this.activated=!0,this.init(callback)}Object.defineProperty(ComingHome.prototype,"what",{get:function(){const config=this.context.config;return new what.What(this.env,this.context.id,config.what)}}),Object.defineProperty(ComingHome.prototype,"whenConstrained",{get:function(){return new WhenConstrained(this.env,this.context.config.when_constrained)}}),Object.defineProperty(ComingHome.prototype,"where",{get:function(){return new where.Where(this.env,this.context.config.where)}}),ComingHome.prototype.init=function(callback){const barrier$1=new barrier.Barrier(3,(function(errors){callback(get_error_message.GetErrorMessage(errors))}));this.where.claimDependencies(barrier$1.arrive),this.what.init(barrier$1.arrive),this.whenConstrained.validateConfig(barrier$1.arrive)},ComingHome.prototype.activateComingHome=function(){const self=this;self.what.activateScenes((function(errors){script_environment.ClipUtils.prototype.hasErrors(errors)&&self.env.log.warn("Activate scenes: "+get_error_message.GetErrorMessage(errors))}))},ComingHome.prototype.onGeofenceEvent=function(geofenceEvent){this.env.log.inform("geofence event handled at "+(new Date).toString()+" activated: "+JSON.stringify(this.activated)),this.activated&&geofenceEvent.any_at_home&&this.whenConstrained.isFulfilled()&&this.activateComingHome()},ComingHome.prototype.run=function(){this.env.geofence.subscribe(Environment.fbind(this.onGeofenceEvent,this))},ComingHome.prototype.trigger=function(action){const self=this;self.env.log.inform("received trigger: "+JSON.stringify(action)),"coming home"===action.debug&&self.activateComingHome(),void 0!==action.enabled&&(self.activated=action.enabled)},ComingHome.Environment=script_environment.ScriptEnvironmentWithClipUtils,module.exports=ComingHome;
