"use strict";var includes=function(array,item){return array.indexOf(item)>=0};var flatmap=function(items,mapFn){return items.reduce((function(mappedItems,item,index){return mappedItems.concat(mapFn(item,index))}),[])},unique=function(items,key){return key?items.filter((function(item,index){var otherItem=items.filter((function(i){return item[key]===i[key]}))[0];return index===items.indexOf(otherItem)})):items.filter((function(item,index){return items.indexOf(item)===index}))},toMilliseconds=function(timeSpan){if(timeSpan){var totalTimeInSec=0;return timeSpan.milliseconds&&(totalTimeInSec+=timeSpan.milliseconds),totalTimeInSec+=1e3*addHoursMinutesSeconds(timeSpan)}return 0},addHoursMinutesSeconds=function(timeSpan){var sumHoursMinutesSeconds=0;return timeSpan.seconds&&(sumHoursMinutesSeconds+=timeSpan.seconds),timeSpan.minutes&&(sumHoursMinutesSeconds+=60*timeSpan.minutes),timeSpan.hours&&(sumHoursMinutesSeconds+=3600*timeSpan.hours),sumHoursMinutesSeconds},toTimespanFromMilliseconds=function(milliseconds){return{hours:Math.floor(milliseconds/36e5),minutes:Math.floor(milliseconds%36e5/6e4),seconds:Math.floor(milliseconds%6e4/1e3),milliseconds:milliseconds%1e3}},TimespanUtils={add:function(date,timespan){var ms=date.valueOf();return new Date(ms+toMilliseconds(timespan))},subtract:function(a,b){return toTimespanFromMilliseconds(toMilliseconds(a)-toMilliseconds(b))},toSeconds:function(timeSpan){if(timeSpan){var totalTimeInSec=0;return timeSpan.milliseconds&&(totalTimeInSec+=timeSpan.milliseconds/1e3),totalTimeInSec+=addHoursMinutesSeconds(timeSpan)}return 0},toMilliseconds:toMilliseconds,toTimespanFromMilliseconds:toTimespanFromMilliseconds},extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])},extendStatics(d,b)};function fbind(callback,scope){for(var params=[],_i=2;_i<arguments.length;_i++)params[_i-2]=arguments[_i];return{callback:callback,scope:scope,params:(null==params?void 0:params.length)?params:void 0}}function fapply(callback){for(var params,paramsArg=[],_i=1;_i<arguments.length;_i++)paramsArg[_i-1]=arguments[_i];if(callback)return"function"==typeof callback?callback.apply(void 0,paramsArg):(callback.params&&(params=callback.params),paramsArg&&(params=params?params.concat(paramsArg):paramsArg),callback.callback.apply(callback.scope,params))}exports.__assign=function(){return exports.__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},exports.__assign.apply(this,arguments)};var ServiceEventHandlerClass=function(){function ServiceEventHandlerClass(){this.callbacks={},this.instances={}}return ServiceEventHandlerClass.prototype.deleteServiceIfEmpty=function(serviceId){Object.keys(this.callbacks[serviceId]).length||delete this.callbacks[serviceId]},ServiceEventHandlerClass.prototype.deleteInstanceIfEmpty=function(instanceId){var found=!1;for(var serviceId in this.callbacks)if(this.callbacks.hasOwnProperty(serviceId)&&this.callbacks[serviceId][instanceId]){found=!0;break}found||delete this.instances[instanceId]},ServiceEventHandlerClass.prototype.listenNewEventsFromNow=function(instanceId){instanceId&&(this.instances[instanceId]=getNextEventIndex())},ServiceEventHandlerClass.prototype.subscribe=function(instanceId,serviceId,callback){var _a,_b;if(!instanceId||!serviceId||!callback)return!1;var serviceCallbacks=null!==(_a=(_b=this.callbacks)[serviceId])&&void 0!==_a?_a:_b[serviceId]={},instanceCallbacks=serviceCallbacks[instanceId];return instanceCallbacks=instanceCallbacks?1===(instanceCallbacks=unique([callback].concat(instanceCallbacks))).length?instanceCallbacks[0]:instanceCallbacks:callback,serviceCallbacks[instanceId]=instanceCallbacks,!0},ServiceEventHandlerClass.prototype.unsubscribe=function(instanceId,serviceId,callback){var _a,instanceCallbacks=null===(_a=this.callbacks[serviceId])||void 0===_a?void 0:_a[instanceId];instanceCallbacks&&(instanceCallbacks instanceof Array&&callback&&includes(instanceCallbacks,callback)?(instanceCallbacks.splice(instanceCallbacks.indexOf(callback),1),this.callbacks[serviceId][instanceId]=1===instanceCallbacks.length?instanceCallbacks[0]:instanceCallbacks):delete this.callbacks[serviceId][instanceId],this.deleteServiceIfEmpty(serviceId),this.deleteInstanceIfEmpty(instanceId))},ServiceEventHandlerClass.prototype.unsubscribeAll=function(instanceId){for(var serviceId in this.callbacks)this.callbacks.hasOwnProperty(serviceId)&&(this.unsubscribe(instanceId,serviceId),delete this.instances[instanceId])},ServiceEventHandlerClass.prototype.getInstanceIds=function(serviceId,currentEventIndex){var service_callbacks=this.callbacks[serviceId],ids=[];for(var instanceId in service_callbacks)if(service_callbacks.hasOwnProperty(instanceId)){var eventThreshold=this.instances[instanceId];(!eventThreshold||eventThreshold<currentEventIndex)&&ids.push(instanceId)}return ids},ServiceEventHandlerClass.prototype.handleEvent=function(instanceId,serviceId,serviceData,serviceMetadata){var _a,callbacks=null===(_a=this.callbacks[serviceId])||void 0===_a?void 0:_a[instanceId];if(callbacks){var call=function(callback){return fapply(callback,serviceId,serviceData,serviceMetadata)};callbacks instanceof Array?callbacks.forEach(call):call(callbacks)}},ServiceEventHandlerClass}(),events={add:new ServiceEventHandlerClass,update:new ServiceEventHandlerClass,delete:new ServiceEventHandlerClass},NotFatalErrors=["device is off or cannot be reached",'device (.*) is "soft off", command (.*) may not have effect',"device (.*) has communication issues, ","command (.*) may not have effect","(.*) feature not supported by grouped light resource"],ClipClass=function(){function ClipClass(scriptContext,log,callbackMap){this.scriptContext=scriptContext,this.log=log,this.callbackMap=callbackMap}return Object.defineProperty(ClipClass.prototype,"delegate",{get:function(){return getDelegate("Clip")},enumerable:!1,configurable:!0}),ClipClass.prototype.logRequest=function(method,url){this.log.debug("clip "+method+" on "+url)},ClipClass.prototype.logResponse=function(instanceId,method,url,body,result,duration){var resultString=JSON.stringify(result),bodyString=JSON.stringify(body);print("======================================================="),print("Instance:   "+instanceId),print("Url:        "+method.toUpperCase()+" "+url),print("Body:       "+bodyString),print("Response:   "+resultString),print("Duration:   "+duration+"ms"),print("======================================================="),url.match("^\\/private_(scene|group).*")&&this.log.inform("clip "+method.toUpperCase()+" on "+url+" with result: "+resultString+" and body: "+bodyString)},ClipClass.prototype.logErrors=function(method,url,errors){var messages,logFatalError,logNotFatalError,_this=this;void 0===errors&&(errors=[]),messages=errors.map((function(error){return"clip error for "+method.toLowerCase()+" on "+url+": "+JSON.stringify(error)})),logFatalError=function(fatalError){return _this.log.warn(fatalError)},logNotFatalError=function(infoMessage){return _this.log.inform(infoMessage)},messages.forEach((function(message){NotFatalErrors.some((function(regex){return message.match(regex)}))?logNotFatalError(message):logFatalError(message)}))},ClipClass.prototype.registerCallback=function(callback){return this.callbackMap.register((function(result){return callback(JSON.parse(result))}))},ClipClass.prototype.request=function(method,path,data,callback,delegateRequest){var _this=this,start=Date.now();delegateRequest(this.registerCallback((function(result){_this.logResponse(_this.scriptContext.id,method,path,data,result,Date.now()-start),_this.logErrors(method,path,result.errors),null==callback||callback(result)})))},ClipClass.prototype.get=function(path,callback){var _this=this;this.logRequest("get",path),this.request("GET",path,"",callback,(function(callbackId){return _this.delegate.get(path,_this.scriptContext.id,_this.scriptContext.retryRequestsInCaseOfConnectionError,callbackId)}))},ClipClass.prototype.put=function(path,data,callback,metadata){var _this=this,metadata_sa=[];null!=metadata&&Object.keys(metadata).forEach((function(metadataKey){metadata_sa.push(metadataKey),metadata_sa.push(metadata[metadataKey])})),this.request("PUT",path,data,callback,(function(callbackId){return _this.delegate.put(path,JSON.stringify(data),_this.scriptContext.id,metadata_sa,_this.scriptContext.retryRequestsInCaseOfConnectionError,callbackId)}))},ClipClass.prototype.post=function(path,data,callback){var _this=this;this.logRequest("post",path),this.request("POST",path,data,callback,(function(callbackId){return _this.delegate.post(path,JSON.stringify(data),_this.scriptContext.id,_this.scriptContext.retryRequestsInCaseOfConnectionError,callbackId)}))},ClipClass.prototype.delete=function(path,callback){var _this=this;this.logRequest("delete",path),this.request("DELETE",path,"",callback,(function(callbackId){return _this.delegate.delete(path,_this.scriptContext.id,_this.scriptContext.retryRequestsInCaseOfConnectionError,callbackId)}))},ClipClass.prototype.queryLightCapabilities=function(groupID,callback){var _this=this;this.logRequest("queryLightCapabilities",groupID),this.request("queryLightCapabilities",groupID,"",callback,(function(callbackId){return _this.delegate.queryLightCapabilities(groupID,_this.scriptContext.id,callbackId)}))},ClipClass}(),DependencyClass=function(){function DependencyClass(id){this.id=id}return Object.defineProperty(DependencyClass.prototype,"delegate",{get:function(){return getDelegate("Dependency")},enumerable:!1,configurable:!0}),DependencyClass.prototype.claimCritical=function(rid,rtype){"private_group"!==rtype&&"private_scene"!==rtype&&this.delegate.claimCritical(this.id,rid,rtype)},DependencyClass}();function onCallback(result){fapply(this,JSON.parse(result))}var GeofenceClass=function(){function GeofenceClass(scriptId,map){this.scriptId=scriptId,this.map=map}return Object.defineProperty(GeofenceClass.prototype,"delegate",{get:function(){return getDelegate("Geofence")},enumerable:!1,configurable:!0}),GeofenceClass.prototype.subscribe=function(callback){if(callback){var callback_id=this.map.register(fbind(onCallback,callback));this.delegate.subscribe(this.scriptId,callback_id)}},GeofenceClass}(),GeoloClass=function(){function GeoloClass(){}return Object.defineProperty(GeoloClass.prototype,"delegate",{get:function(){return getDelegate("Geolocation")},enumerable:!1,configurable:!0}),GeoloClass.prototype.isDaytime=function(localTime,sunriseOffset,sunsetOffset){var sunriseOffsetInSeconds=TimespanUtils.toSeconds(sunriseOffset),sunsetOffsetInSeconds=TimespanUtils.toSeconds(sunsetOffset);return void 0===localTime?this.delegate.isDaytime(sunriseOffsetInSeconds,sunsetOffsetInSeconds):this.delegate.isDaytimeAt(localTime.toISOString(),sunriseOffsetInSeconds,sunsetOffsetInSeconds)},GeoloClass.prototype.getSunrise=function(localTime){var sunriseIsoString=this.delegate.getSunrise(localTime.toISOString());return new Date(sunriseIsoString)},GeoloClass.prototype.getSunset=function(localTime){var sunsetIsoString=this.delegate.getSunset(localTime.toISOString());return new Date(sunsetIsoString)},GeoloClass.prototype.isConfigured=function(){return this.delegate.isConfigured()},GeoloClass.prototype.getDayTypeSunriseSunset=function(localTime){var parsed=JSON.parse(this.delegate.getDayTypeSunriseSunset(localTime.toISOString()));return{day_type:parsed.day_type,sunrise:new Date(parsed.sunrise),sunset:new Date(parsed.sunset)}},GeoloClass}(),Logger=function(){function Logger(id){this.id=id}return Logger.prototype.warn=function(message){warn(message,this.id)},Logger.prototype.inform=function(message){inform(message,this.id)},Logger.prototype.debug=function(message){print(message)},Logger}(),PersistenceClass=function(){function PersistenceClass(scriptId){this.scriptId=scriptId}return Object.defineProperty(PersistenceClass.prototype,"delegate",{get:function(){return getDelegate("Persistence")},enumerable:!1,configurable:!0}),PersistenceClass.prototype.storeState=function(state){this.delegate.storeState(JSON.stringify(state),this.scriptId)},PersistenceClass.prototype.restoreState=function(){var state=this.delegate.restoreState(this.scriptId);return state?JSON.parse(state):void 0},PersistenceClass.prototype.isStatePersisted=function(){return this.delegate.isStatePersisted(this.scriptId)},PersistenceClass.prototype.updateState=function(state){var stored_state={};this.isStatePersisted()&&(stored_state=this.restoreState()),this.storeState(exports.__assign(exports.__assign({},stored_state),state))},PersistenceClass}(),TimerClass=function(){function TimerClass(scriptId,callbackMap){this.scriptId=scriptId,this.callbackMap=callbackMap}return Object.defineProperty(TimerClass.prototype,"delegate",{get:function(){return getDelegate("Timer")},enumerable:!1,configurable:!0}),TimerClass.prototype.setTimer=function(callback,timerFunction){var timerId=this.callbackMap.register(callback),cpp_timer_id=timerFunction(timerId);return this.callbackMap.assignCppTimer(timerId,cpp_timer_id),timerId},TimerClass.prototype.setAlarm=function(callback,localTime){var _this=this;return this.setTimer(callback,(function(timerId){return _this.delegate.setAlarm(localTime.getFullYear(),localTime.getMonth(),localTime.getDate(),localTime.getHours(),localTime.getMinutes(),localTime.getSeconds(),localTime.getMilliseconds(),_this.scriptId,timerId)}))},TimerClass.prototype.setRecurringAlarm=function(callback,cronExpression){var _this=this;return this.setTimer(callback,(function(timerId){return _this.delegate.setRecurringAlarm(cronExpression,_this.scriptId,timerId)}))},TimerClass.prototype.setRecurringAlarmWithOffset=function(callback,cronExpression,_a){var _this=this,hours=_a.hours,minutes=_a.minutes,seconds=_a.seconds,milliseconds=_a.milliseconds;return this.setTimer(callback,(function(timerId){return _this.delegate.setRecurringAlarmWithOffset(cronExpression,hours||0,minutes||0,seconds||0+(milliseconds||0)/1e3,_this.scriptId,timerId)}))},TimerClass.prototype.setRecurringSunriseAlarmWithOffset=function(callback,_a){var _this=this,hours=_a.hours,minutes=_a.minutes,seconds=_a.seconds,milliseconds=_a.milliseconds;return this.setTimer(callback,(function(timerId){return _this.delegate.setRecurringSunriseAlarmWithOffset(hours||0,minutes||0,seconds||0+(milliseconds||0)/1e3,_this.scriptId,timerId)}))},TimerClass.prototype.setRecurringSunsetAlarmWithOffset=function(callback,_a){var _this=this,hours=_a.hours,minutes=_a.minutes,seconds=_a.seconds,milliseconds=_a.milliseconds;return this.setTimer(callback,(function(timerId){return _this.delegate.setRecurringSunsetAlarmWithOffset(hours||0,minutes||0,seconds||0+(milliseconds||0)/1e3,_this.scriptId,timerId)}))},TimerClass.prototype.setTimeout=function(callback,_a){var _this=this,hours=_a.hours,minutes=_a.minutes,seconds=_a.seconds,milliseconds=_a.milliseconds;return this.setTimer(callback,(function(timerId){return _this.delegate.setTimeout(hours||0,minutes||0,seconds||0,milliseconds||0,_this.scriptId,timerId)}))},TimerClass.prototype.setInterval=function(callback,_a){var _this=this,hours=_a.hours,minutes=_a.minutes,seconds=_a.seconds,milliseconds=_a.milliseconds;return this.setTimer(callback,(function(timerId){return _this.delegate.setInterval(hours||0,minutes||0,seconds||0,milliseconds||0,_this.scriptId,timerId)}))},TimerClass.prototype.cancelTimer=function(timerId){var cpp_timer_id=this.callbackMap.getCppTimerId(timerId);cpp_timer_id&&this.delegate.cancelTimer(this.scriptId,cpp_timer_id),this.callbackMap.remove(timerId)},TimerClass}(),StorageClass=function(){function StorageClass(scriptId,callbackMap){this.scriptId=scriptId,this.callbackMap=callbackMap}return Object.defineProperty(StorageClass.prototype,"delegate",{get:function(){return getDelegate("Storage")},enumerable:!1,configurable:!0}),StorageClass.prototype.registerCallback=function(callback){return this.callbackMap.register((function(result){return callback(JSON.parse(result))}))},StorageClass.prototype.request=function(callback,delegateRequest){delegateRequest(this.registerCallback((function(result){result.errors&&result.errors.length>0?null==callback||callback(result.errors,result.data):null==callback||callback(void 0,result.data)})))},StorageClass.prototype.store=function(key,data,callback){var _this=this;void 0!==data&&this.request(callback,(function(callbackId){return _this.delegate.store(_this.scriptId,key,JSON.stringify(data),callbackId)}))},StorageClass.prototype.update=function(key,data,callback){var _this=this;void 0!==data&&this.request(callback,(function(callbackId){return _this.delegate.update(_this.scriptId,key,JSON.stringify(data),callbackId)}))},StorageClass.prototype.clear=function(){this.delegate.clear(this.scriptId)},StorageClass.prototype.clearKey=function(key){this.delegate.clearKey(this.scriptId,key)},StorageClass.prototype.retrieveData=function(key,callback){var _this=this;this.request(callback,(function(callbackId){return _this.delegate.retrieveData(_this.scriptId,key,callbackId)}))},StorageClass.prototype.retrieveKeys=function(callback){var _this=this;this.request(callback,(function(callbackId){return _this.delegate.retrieveKeys(_this.scriptId,callbackId)}))},StorageClass}(),State=function(){function State(state){this.state=state}return State.prototype.get=function(key,factory){var _a,_b;return key?null!==(_a=(_b=this.state)[key])&&void 0!==_a?_a:_b[key]=null==factory?void 0:factory():null==factory?void 0:factory()},State.prototype.set=function(key,val){return key&&(this.state[key]=val),val},State.prototype.delete=function(key){delete this.state[key]},State.prototype.clear=function(){var _this=this;Object.keys(this.state).forEach((function(key){return _this.delete(key)}))},State}(),createEvent=function(instanceId,service){return{listenNewEventsFromNow:function(){return service.listenNewEventsFromNow(instanceId)},subscribe:function(serviceId,callback){return service.subscribe(instanceId,serviceId,callback)},unsubscribe:function(serviceId,callback){return service.unsubscribe(instanceId,serviceId,callback)},unsubscribeAll:function(){return service.unsubscribeAll(instanceId)}}},ScriptEnvironment=function(){function ScriptEnvironment(context,register){this.context=context,this.register=register}return ScriptEnvironment.prototype.getConfig=function(path,config){return void 0===config&&(config=this.context.config),"string"!=typeof path?path:path.split(".").reduce((function(val,key){return null==val?void 0:val[key]}),config)},Object.defineProperty(ScriptEnvironment.prototype,"callbackMap",{get:function(){return this.register(this.context.id)},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"log",{get:function(){return new Logger(this.context.id)},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"clip",{get:function(){return new ClipClass(this.context,this.log,this.callbackMap)},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"geofence",{get:function(){return new GeofenceClass(this.context.id,this.callbackMap)},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"geolocation",{get:function(){return new GeoloClass},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"timer",{get:function(){return new TimerClass(this.context.id,this.callbackMap)},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"dependency",{get:function(){return new DependencyClass(this.context.id)},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"persistence",{get:function(){return new PersistenceClass(this.context.id)},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"events",{get:function(){return instanceId=this.context.id,{add:createEvent(instanceId,events.add),update:createEvent(instanceId,events.update),delete:createEvent(instanceId,events.delete)};var instanceId},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"storage",{get:function(){return new StorageClass(this.context.id,this.callbackMap)},enumerable:!1,configurable:!0}),Object.defineProperty(ScriptEnvironment.prototype,"state",{get:function(){var _a;return new State(null!==(_a=this._state)&&void 0!==_a?_a:this._state={})},enumerable:!1,configurable:!0}),ScriptEnvironment}();exports.ScriptEnvironment=ScriptEnvironment,exports.TimespanUtils=TimespanUtils,exports.__extends=function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},exports.__spreadArray=function(to,from,pack){if(pack||2===arguments.length)for(var ar,i=0,l=from.length;i<l;i++)!ar&&i in from||(ar||(ar=Array.prototype.slice.call(from,0,i)),ar[i]=from[i]);return to.concat(ar||Array.prototype.slice.call(from))},exports.entries=function(obj){return Object.keys(obj).map((function(key){return[key,obj[key]]}))},exports.equalsBy=function(a,b,propFn){if(null===a||null===b)return!1;if(a.length!==b.length)return!1;if(!propFn)return a.every((function(itemA){return includes(b,itemA)}));var itemsA=a.map((function(item){return propFn(item)})),itemsB=b.map((function(item){return propFn(item)}));return itemsA.every((function(itemA){return includes(itemsB,itemA)}))},exports.events=events,exports.fapply=fapply,exports.fbind=fbind,exports.find=function(items,predicate){void 0===items&&(items=[]);for(var i=0;i<items.length;i++)if(predicate(items[i],i,items))return items[i]},exports.findIndex=function(items,predicate){void 0===items&&(items=[]);for(var i=0;i<items.length;i++)if(predicate(items[i],i,items))return i;return-1},exports.flatmap=flatmap,exports.flatten=function(items){return flatmap(items,(function(item){return item}))},exports.includes=includes,exports.includesAny=function(array){for(var items=[],_i=1;_i<arguments.length;_i++)items[_i-1]=arguments[_i];return items.some((function(item){return includes(array,item)}))},exports.unique=unique,exports.values=function(obj){return Object.keys(obj).map((function(key){return obj[key]}))};
